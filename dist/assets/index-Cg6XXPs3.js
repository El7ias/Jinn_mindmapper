const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/event-0KKzhgIB.js","assets/core-DhEqZVGG.js"])))=>i.map(i=>d[i]);
var An=Object.defineProperty;var In=(i,e,t)=>e in i?An(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var P=(i,e,t)=>In(i,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function t(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(n){if(n.ep)return;n.ep=!0;const o=t(n);fetch(n.href,o)}})();class Cn{constructor(){this._listeners=new Map}on(e,t){return this._listeners.has(e)||this._listeners.set(e,new Set),this._listeners.get(e).add(t),()=>this.off(e,t)}off(e,t){const s=this._listeners.get(e);s&&s.delete(t)}emit(e,t){const s=this._listeners.get(e);s&&s.forEach(n=>{try{n(t)}catch(o){console.error(`EventBus error [${e}]:`,o)}})}}class Mn{constructor(e,t={}){this.bus=e,this.maxSize=t.maxSize||50,this._stack=[],this._pointer=-1,this._paused=!1}push(e){this._paused||(this._stack=this._stack.slice(0,this._pointer+1),this._stack.push(JSON.parse(JSON.stringify(e))),this._stack.length>this.maxSize&&this._stack.shift(),this._pointer=this._stack.length-1,this.bus.emit("history:changed",this.status()))}undo(){if(!this.canUndo())return null;this._pointer--;const e=JSON.parse(JSON.stringify(this._stack[this._pointer]));return this.bus.emit("history:changed",this.status()),e}redo(){if(!this.canRedo())return null;this._pointer++;const e=JSON.parse(JSON.stringify(this._stack[this._pointer]));return this.bus.emit("history:changed",this.status()),e}canUndo(){return this._pointer>0}canRedo(){return this._pointer<this._stack.length-1}status(){return{canUndo:this.canUndo(),canRedo:this.canRedo()}}pause(){this._paused=!0}resume(){this._paused=!1}}class Pn{constructor(e){this.bus=e,this.container=document.getElementById("canvas-container"),this.viewport=document.getElementById("canvas-viewport"),this.zoomDisplay=document.getElementById("zoom-level"),this.x=0,this.y=0,this.zoom=1,this.minZoom=.15,this.maxZoom=3,this._isPanning=!1,this._spaceDown=!1,this._startX=0,this._startY=0,this._bindEvents(),this._applyTransform()}_bindEvents(){var e,t,s;this.container.addEventListener("wheel",n=>{n.preventDefault();const o=n.deltaY>0?.9:1.1,r=this.container.getBoundingClientRect(),a=n.clientX-r.left,c=n.clientY-r.top;this.zoomAt(a,c,o)},{passive:!1}),this.container.addEventListener("mousedown",n=>{(n.button===1||n.button===0&&this._spaceDown)&&(n.preventDefault(),this._isPanning=!0,this._startX=n.clientX-this.x,this._startY=n.clientY-this.y,this.container.classList.add("panning"))}),window.addEventListener("mousemove",n=>{this._isPanning&&(this.x=n.clientX-this._startX,this.y=n.clientY-this._startY,this._applyTransform(),this.bus.emit("viewport:changed",this.getState()))}),window.addEventListener("mouseup",n=>{this._isPanning&&(n.button===1||n.button===0)&&(this._isPanning=!1,this.container.classList.remove("panning"))}),window.addEventListener("keydown",n=>{var o,r;n.code==="Space"&&!n.repeat&&((o=document.activeElement)==null?void 0:o.tagName)!=="TEXTAREA"&&!((r=document.activeElement)!=null&&r.isContentEditable)&&(n.preventDefault(),this._spaceDown=!0,this.container.classList.add("panning"))}),window.addEventListener("keyup",n=>{n.code==="Space"&&(this._spaceDown=!1,this._isPanning||this.container.classList.remove("panning"))}),(e=document.getElementById("btn-zoom-in"))==null||e.addEventListener("click",()=>{const n=this.container.getBoundingClientRect();this.zoomAt(n.width/2,n.height/2,1.2)}),(t=document.getElementById("btn-zoom-out"))==null||t.addEventListener("click",()=>{const n=this.container.getBoundingClientRect();this.zoomAt(n.width/2,n.height/2,.8)}),(s=document.getElementById("btn-zoom-fit"))==null||s.addEventListener("click",()=>{this.bus.emit("viewport:fit-request")})}zoomAt(e,t,s){const n=this.zoom;this.zoom=Math.min(this.maxZoom,Math.max(this.minZoom,this.zoom*s));const o=this.zoom/n;this.x=e-(e-this.x)*o,this.y=t-(t-this.y)*o,this._applyTransform(),this.bus.emit("viewport:changed",this.getState())}_applyTransform(){this.viewport.style.transform=`translate(${this.x}px, ${this.y}px) scale(${this.zoom})`,this.zoomDisplay.textContent=`${Math.round(this.zoom*100)}%`;const e=24*this.zoom,t=e*6,s=this.x%e,n=this.y%e,o=this.x%t,r=this.y%t;this.container.style.backgroundSize=`${e}px ${e}px, ${e}px ${e}px, ${t}px ${t}px, ${t}px ${t}px`,this.container.style.backgroundPosition=`${s}px ${n}px, ${s}px ${n}px, ${o}px ${r}px, ${o}px ${r}px`}screenToWorld(e,t){return{x:(e-this.x)/this.zoom,y:(t-this.y)/this.zoom}}worldToScreen(e,t){return{x:e*this.zoom+this.x,y:t*this.zoom+this.y}}getState(){return{x:this.x,y:this.y,zoom:this.zoom}}setState(e){e&&(this.x=e.x||0,this.y=e.y||0,this.zoom=e.zoom||1,this._applyTransform())}get isSpaceDown(){return this._spaceDown}get isPanning(){return this._isPanning}}/*! @license DOMPurify 3.3.1 | (c) Cure53 and other contributors | Released under the Apache license 2.0 and Mozilla Public License 2.0 | github.com/cure53/DOMPurify/blob/3.3.1/LICENSE */const{entries:Gs,setPrototypeOf:vs,isFrozen:Ln,getPrototypeOf:Nn,getOwnPropertyDescriptor:$n}=Object;let{freeze:X,seal:Q,create:Lt}=Object,{apply:Nt,construct:$t}=typeof Reflect<"u"&&Reflect;X||(X=function(e){return e});Q||(Q=function(e){return e});Nt||(Nt=function(e,t){for(var s=arguments.length,n=new Array(s>2?s-2:0),o=2;o<s;o++)n[o-2]=arguments[o];return e.apply(t,n)});$t||($t=function(e){for(var t=arguments.length,s=new Array(t>1?t-1:0),n=1;n<t;n++)s[n-1]=arguments[n];return new e(...s)});const tt=V(Array.prototype.forEach),Rn=V(Array.prototype.lastIndexOf),xs=V(Array.prototype.pop),Oe=V(Array.prototype.push),On=V(Array.prototype.splice),ot=V(String.prototype.toLowerCase),Et=V(String.prototype.toString),St=V(String.prototype.match),De=V(String.prototype.replace),Dn=V(String.prototype.indexOf),zn=V(String.prototype.trim),te=V(Object.prototype.hasOwnProperty),W=V(RegExp.prototype.test),ze=Fn(TypeError);function V(i){return function(e){e instanceof RegExp&&(e.lastIndex=0);for(var t=arguments.length,s=new Array(t>1?t-1:0),n=1;n<t;n++)s[n-1]=arguments[n];return Nt(i,e,s)}}function Fn(i){return function(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return $t(i,t)}}function A(i,e){let t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:ot;vs&&vs(i,null);let s=e.length;for(;s--;){let n=e[s];if(typeof n=="string"){const o=t(n);o!==n&&(Ln(e)||(e[s]=o),n=o)}i[n]=!0}return i}function Bn(i){for(let e=0;e<i.length;e++)te(i,e)||(i[e]=null);return i}function re(i){const e=Lt(null);for(const[t,s]of Gs(i))te(i,t)&&(Array.isArray(s)?e[t]=Bn(s):s&&typeof s=="object"&&s.constructor===Object?e[t]=re(s):e[t]=s);return e}function Fe(i,e){for(;i!==null;){const s=$n(i,e);if(s){if(s.get)return V(s.get);if(typeof s.value=="function")return V(s.value)}i=Nn(i)}function t(){return null}return t}const ws=X(["a","abbr","acronym","address","area","article","aside","audio","b","bdi","bdo","big","blink","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","content","data","datalist","dd","decorator","del","details","dfn","dialog","dir","div","dl","dt","element","em","fieldset","figcaption","figure","font","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","img","input","ins","kbd","label","legend","li","main","map","mark","marquee","menu","menuitem","meter","nav","nobr","ol","optgroup","option","output","p","picture","pre","progress","q","rp","rt","ruby","s","samp","search","section","select","shadow","slot","small","source","spacer","span","strike","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","tr","track","tt","u","ul","var","video","wbr"]),Tt=X(["svg","a","altglyph","altglyphdef","altglyphitem","animatecolor","animatemotion","animatetransform","circle","clippath","defs","desc","ellipse","enterkeyhint","exportparts","filter","font","g","glyph","glyphref","hkern","image","inputmode","line","lineargradient","marker","mask","metadata","mpath","part","path","pattern","polygon","polyline","radialgradient","rect","stop","style","switch","symbol","text","textpath","title","tref","tspan","view","vkern"]),At=X(["feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feDropShadow","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence"]),qn=X(["animate","color-profile","cursor","discard","font-face","font-face-format","font-face-name","font-face-src","font-face-uri","foreignobject","hatch","hatchpath","mesh","meshgradient","meshpatch","meshrow","missing-glyph","script","set","solidcolor","unknown","use"]),It=X(["math","menclose","merror","mfenced","mfrac","mglyph","mi","mlabeledtr","mmultiscripts","mn","mo","mover","mpadded","mphantom","mroot","mrow","ms","mspace","msqrt","mstyle","msub","msup","msubsup","mtable","mtd","mtext","mtr","munder","munderover","mprescripts"]),Un=X(["maction","maligngroup","malignmark","mlongdiv","mscarries","mscarry","msgroup","mstack","msline","msrow","semantics","annotation","annotation-xml","mprescripts","none"]),ks=X(["#text"]),Es=X(["accept","action","align","alt","autocapitalize","autocomplete","autopictureinpicture","autoplay","background","bgcolor","border","capture","cellpadding","cellspacing","checked","cite","class","clear","color","cols","colspan","controls","controlslist","coords","crossorigin","datetime","decoding","default","dir","disabled","disablepictureinpicture","disableremoteplayback","download","draggable","enctype","enterkeyhint","exportparts","face","for","headers","height","hidden","high","href","hreflang","id","inert","inputmode","integrity","ismap","kind","label","lang","list","loading","loop","low","max","maxlength","media","method","min","minlength","multiple","muted","name","nonce","noshade","novalidate","nowrap","open","optimum","part","pattern","placeholder","playsinline","popover","popovertarget","popovertargetaction","poster","preload","pubdate","radiogroup","readonly","rel","required","rev","reversed","role","rows","rowspan","spellcheck","scope","selected","shape","size","sizes","slot","span","srclang","start","src","srcset","step","style","summary","tabindex","title","translate","type","usemap","valign","value","width","wrap","xmlns","slot"]),Ct=X(["accent-height","accumulate","additive","alignment-baseline","amplitude","ascent","attributename","attributetype","azimuth","basefrequency","baseline-shift","begin","bias","by","class","clip","clippathunits","clip-path","clip-rule","color","color-interpolation","color-interpolation-filters","color-profile","color-rendering","cx","cy","d","dx","dy","diffuseconstant","direction","display","divisor","dur","edgemode","elevation","end","exponent","fill","fill-opacity","fill-rule","filter","filterunits","flood-color","flood-opacity","font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","fx","fy","g1","g2","glyph-name","glyphref","gradientunits","gradienttransform","height","href","id","image-rendering","in","in2","intercept","k","k1","k2","k3","k4","kerning","keypoints","keysplines","keytimes","lang","lengthadjust","letter-spacing","kernelmatrix","kernelunitlength","lighting-color","local","marker-end","marker-mid","marker-start","markerheight","markerunits","markerwidth","maskcontentunits","maskunits","max","mask","mask-type","media","method","mode","min","name","numoctaves","offset","operator","opacity","order","orient","orientation","origin","overflow","paint-order","path","pathlength","patterncontentunits","patterntransform","patternunits","points","preservealpha","preserveaspectratio","primitiveunits","r","rx","ry","radius","refx","refy","repeatcount","repeatdur","restart","result","rotate","scale","seed","shape-rendering","slope","specularconstant","specularexponent","spreadmethod","startoffset","stddeviation","stitchtiles","stop-color","stop-opacity","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke","stroke-width","style","surfacescale","systemlanguage","tabindex","tablevalues","targetx","targety","transform","transform-origin","text-anchor","text-decoration","text-rendering","textlength","type","u1","u2","unicode","values","viewbox","visibility","version","vert-adv-y","vert-origin-x","vert-origin-y","width","word-spacing","wrap","writing-mode","xchannelselector","ychannelselector","x","x1","x2","xmlns","y","y1","y2","z","zoomandpan"]),Ss=X(["accent","accentunder","align","bevelled","close","columnsalign","columnlines","columnspan","denomalign","depth","dir","display","displaystyle","encoding","fence","frame","height","href","id","largeop","length","linethickness","lspace","lquote","mathbackground","mathcolor","mathsize","mathvariant","maxsize","minsize","movablelimits","notation","numalign","open","rowalign","rowlines","rowspacing","rowspan","rspace","rquote","scriptlevel","scriptminsize","scriptsizemultiplier","selection","separator","separators","stretchy","subscriptshift","supscriptshift","symmetric","voffset","width","xmlns"]),st=X(["xlink:href","xml:id","xlink:title","xml:space","xmlns:xlink"]),jn=Q(/\{\{[\w\W]*|[\w\W]*\}\}/gm),Hn=Q(/<%[\w\W]*|[\w\W]*%>/gm),Gn=Q(/\$\{[\w\W]*/gm),Wn=Q(/^data-[\-\w.\u00B7-\uFFFF]+$/),Yn=Q(/^aria-[\-\w]+$/),Ws=Q(/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|sms|cid|xmpp|matrix):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i),Xn=Q(/^(?:\w+script|data):/i),Vn=Q(/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205F\u3000]/g),Ys=Q(/^html$/i),Jn=Q(/^[a-z][.\w]*(-[.\w]+)+$/i);var Ts=Object.freeze({__proto__:null,ARIA_ATTR:Yn,ATTR_WHITESPACE:Vn,CUSTOM_ELEMENT:Jn,DATA_ATTR:Wn,DOCTYPE_NAME:Ys,ERB_EXPR:Hn,IS_ALLOWED_URI:Ws,IS_SCRIPT_OR_DATA:Xn,MUSTACHE_EXPR:jn,TMPLIT_EXPR:Gn});const Be={element:1,text:3,progressingInstruction:7,comment:8,document:9},Kn=function(){return typeof window>"u"?null:window},Zn=function(e,t){if(typeof e!="object"||typeof e.createPolicy!="function")return null;let s=null;const n="data-tt-policy-suffix";t&&t.hasAttribute(n)&&(s=t.getAttribute(n));const o="dompurify"+(s?"#"+s:"");try{return e.createPolicy(o,{createHTML(r){return r},createScriptURL(r){return r}})}catch{return console.warn("TrustedTypes policy "+o+" could not be created."),null}},As=function(){return{afterSanitizeAttributes:[],afterSanitizeElements:[],afterSanitizeShadowDOM:[],beforeSanitizeAttributes:[],beforeSanitizeElements:[],beforeSanitizeShadowDOM:[],uponSanitizeAttribute:[],uponSanitizeElement:[],uponSanitizeShadowNode:[]}};function Xs(){let i=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Kn();const e=w=>Xs(w);if(e.version="3.3.1",e.removed=[],!i||!i.document||i.document.nodeType!==Be.document||!i.Element)return e.isSupported=!1,e;let{document:t}=i;const s=t,n=s.currentScript,{DocumentFragment:o,HTMLTemplateElement:r,Node:a,Element:c,NodeFilter:l,NamedNodeMap:p=i.NamedNodeMap||i.MozNamedAttrMap,HTMLFormElement:h,DOMParser:g,trustedTypes:u}=i,f=c.prototype,m=Fe(f,"cloneNode"),b=Fe(f,"remove"),E=Fe(f,"nextSibling"),S=Fe(f,"childNodes"),D=Fe(f,"parentNode");if(typeof r=="function"){const w=t.createElement("template");w.content&&w.content.ownerDocument&&(t=w.content.ownerDocument)}let C,j="";const{implementation:L,createNodeIterator:J,createDocumentFragment:ae,getElementsByTagName:we}=t,{importNode:We}=s;let q=As();e.isSupported=typeof Gs=="function"&&typeof D=="function"&&L&&L.createHTMLDocument!==void 0;const{MUSTACHE_EXPR:ke,ERB_EXPR:ue,TMPLIT_EXPR:k,DATA_ATTR:T,ARIA_ATTR:H,IS_SCRIPT_OR_DATA:pe,ATTR_WHITESPACE:ee,CUSTOM_ELEMENT:me}=Ts;let{IS_ALLOWED_URI:Ee}=Ts,O=null;const Ye=A({},[...ws,...Tt,...At,...It,...ks]);let F=null;const Le=A({},[...Es,...Ct,...Ss,...st]);let $=Object.seal(Lt(null,{tagNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},allowCustomizedBuiltInElements:{writable:!0,configurable:!1,enumerable:!0,value:!1}})),Ne=null,ut=null;const Se=Object.seal(Lt(null,{tagCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeCheck:{writable:!0,configurable:!1,enumerable:!0,value:null}}));let es=!0,pt=!0,ts=!1,ss=!0,Te=!1,Xe=!0,ye=!1,gt=!1,ft=!1,Ae=!1,Ve=!1,Je=!1,ns=!0,is=!1;const _n="user-content-";let mt=!0,$e=!1,Ie={},ie=null;const yt=A({},["annotation-xml","audio","colgroup","desc","foreignobject","head","iframe","math","mi","mn","mo","ms","mtext","noembed","noframes","noscript","plaintext","script","style","svg","template","thead","title","video","xmp"]);let os=null;const rs=A({},["audio","video","img","source","image","track"]);let bt=null;const as=A({},["alt","class","for","id","label","name","pattern","placeholder","role","summary","title","value","style","xmlns"]),Ke="http://www.w3.org/1998/Math/MathML",Ze="http://www.w3.org/2000/svg",ce="http://www.w3.org/1999/xhtml";let Ce=ce,_t=!1,vt=null;const vn=A({},[Ke,Ze,ce],Et);let Qe=A({},["mi","mo","mn","ms","mtext"]),et=A({},["annotation-xml"]);const xn=A({},["title","style","font","a","script"]);let Re=null;const wn=["application/xhtml+xml","text/html"],kn="text/html";let B=null,Me=null;const En=t.createElement("form"),cs=function(d){return d instanceof RegExp||d instanceof Function},xt=function(){let d=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(!(Me&&Me===d)){if((!d||typeof d!="object")&&(d={}),d=re(d),Re=wn.indexOf(d.PARSER_MEDIA_TYPE)===-1?kn:d.PARSER_MEDIA_TYPE,B=Re==="application/xhtml+xml"?Et:ot,O=te(d,"ALLOWED_TAGS")?A({},d.ALLOWED_TAGS,B):Ye,F=te(d,"ALLOWED_ATTR")?A({},d.ALLOWED_ATTR,B):Le,vt=te(d,"ALLOWED_NAMESPACES")?A({},d.ALLOWED_NAMESPACES,Et):vn,bt=te(d,"ADD_URI_SAFE_ATTR")?A(re(as),d.ADD_URI_SAFE_ATTR,B):as,os=te(d,"ADD_DATA_URI_TAGS")?A(re(rs),d.ADD_DATA_URI_TAGS,B):rs,ie=te(d,"FORBID_CONTENTS")?A({},d.FORBID_CONTENTS,B):yt,Ne=te(d,"FORBID_TAGS")?A({},d.FORBID_TAGS,B):re({}),ut=te(d,"FORBID_ATTR")?A({},d.FORBID_ATTR,B):re({}),Ie=te(d,"USE_PROFILES")?d.USE_PROFILES:!1,es=d.ALLOW_ARIA_ATTR!==!1,pt=d.ALLOW_DATA_ATTR!==!1,ts=d.ALLOW_UNKNOWN_PROTOCOLS||!1,ss=d.ALLOW_SELF_CLOSE_IN_ATTR!==!1,Te=d.SAFE_FOR_TEMPLATES||!1,Xe=d.SAFE_FOR_XML!==!1,ye=d.WHOLE_DOCUMENT||!1,Ae=d.RETURN_DOM||!1,Ve=d.RETURN_DOM_FRAGMENT||!1,Je=d.RETURN_TRUSTED_TYPE||!1,ft=d.FORCE_BODY||!1,ns=d.SANITIZE_DOM!==!1,is=d.SANITIZE_NAMED_PROPS||!1,mt=d.KEEP_CONTENT!==!1,$e=d.IN_PLACE||!1,Ee=d.ALLOWED_URI_REGEXP||Ws,Ce=d.NAMESPACE||ce,Qe=d.MATHML_TEXT_INTEGRATION_POINTS||Qe,et=d.HTML_INTEGRATION_POINTS||et,$=d.CUSTOM_ELEMENT_HANDLING||{},d.CUSTOM_ELEMENT_HANDLING&&cs(d.CUSTOM_ELEMENT_HANDLING.tagNameCheck)&&($.tagNameCheck=d.CUSTOM_ELEMENT_HANDLING.tagNameCheck),d.CUSTOM_ELEMENT_HANDLING&&cs(d.CUSTOM_ELEMENT_HANDLING.attributeNameCheck)&&($.attributeNameCheck=d.CUSTOM_ELEMENT_HANDLING.attributeNameCheck),d.CUSTOM_ELEMENT_HANDLING&&typeof d.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements=="boolean"&&($.allowCustomizedBuiltInElements=d.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements),Te&&(pt=!1),Ve&&(Ae=!0),Ie&&(O=A({},ks),F=[],Ie.html===!0&&(A(O,ws),A(F,Es)),Ie.svg===!0&&(A(O,Tt),A(F,Ct),A(F,st)),Ie.svgFilters===!0&&(A(O,At),A(F,Ct),A(F,st)),Ie.mathMl===!0&&(A(O,It),A(F,Ss),A(F,st))),d.ADD_TAGS&&(typeof d.ADD_TAGS=="function"?Se.tagCheck=d.ADD_TAGS:(O===Ye&&(O=re(O)),A(O,d.ADD_TAGS,B))),d.ADD_ATTR&&(typeof d.ADD_ATTR=="function"?Se.attributeCheck=d.ADD_ATTR:(F===Le&&(F=re(F)),A(F,d.ADD_ATTR,B))),d.ADD_URI_SAFE_ATTR&&A(bt,d.ADD_URI_SAFE_ATTR,B),d.FORBID_CONTENTS&&(ie===yt&&(ie=re(ie)),A(ie,d.FORBID_CONTENTS,B)),d.ADD_FORBID_CONTENTS&&(ie===yt&&(ie=re(ie)),A(ie,d.ADD_FORBID_CONTENTS,B)),mt&&(O["#text"]=!0),ye&&A(O,["html","head","body"]),O.table&&(A(O,["tbody"]),delete Ne.tbody),d.TRUSTED_TYPES_POLICY){if(typeof d.TRUSTED_TYPES_POLICY.createHTML!="function")throw ze('TRUSTED_TYPES_POLICY configuration option must provide a "createHTML" hook.');if(typeof d.TRUSTED_TYPES_POLICY.createScriptURL!="function")throw ze('TRUSTED_TYPES_POLICY configuration option must provide a "createScriptURL" hook.');C=d.TRUSTED_TYPES_POLICY,j=C.createHTML("")}else C===void 0&&(C=Zn(u,n)),C!==null&&typeof j=="string"&&(j=C.createHTML(""));X&&X(d),Me=d}},ls=A({},[...Tt,...At,...qn]),ds=A({},[...It,...Un]),Sn=function(d){let y=D(d);(!y||!y.tagName)&&(y={namespaceURI:Ce,tagName:"template"});const x=ot(d.tagName),R=ot(y.tagName);return vt[d.namespaceURI]?d.namespaceURI===Ze?y.namespaceURI===ce?x==="svg":y.namespaceURI===Ke?x==="svg"&&(R==="annotation-xml"||Qe[R]):!!ls[x]:d.namespaceURI===Ke?y.namespaceURI===ce?x==="math":y.namespaceURI===Ze?x==="math"&&et[R]:!!ds[x]:d.namespaceURI===ce?y.namespaceURI===Ze&&!et[R]||y.namespaceURI===Ke&&!Qe[R]?!1:!ds[x]&&(xn[x]||!ls[x]):!!(Re==="application/xhtml+xml"&&vt[d.namespaceURI]):!1},oe=function(d){Oe(e.removed,{element:d});try{D(d).removeChild(d)}catch{b(d)}},be=function(d,y){try{Oe(e.removed,{attribute:y.getAttributeNode(d),from:y})}catch{Oe(e.removed,{attribute:null,from:y})}if(y.removeAttribute(d),d==="is")if(Ae||Ve)try{oe(y)}catch{}else try{y.setAttribute(d,"")}catch{}},hs=function(d){let y=null,x=null;if(ft)d="<remove></remove>"+d;else{const z=St(d,/^[\r\n\t ]+/);x=z&&z[0]}Re==="application/xhtml+xml"&&Ce===ce&&(d='<html xmlns="http://www.w3.org/1999/xhtml"><head></head><body>'+d+"</body></html>");const R=C?C.createHTML(d):d;if(Ce===ce)try{y=new g().parseFromString(R,Re)}catch{}if(!y||!y.documentElement){y=L.createDocument(Ce,"template",null);try{y.documentElement.innerHTML=_t?j:R}catch{}}const G=y.body||y.documentElement;return d&&x&&G.insertBefore(t.createTextNode(x),G.childNodes[0]||null),Ce===ce?we.call(y,ye?"html":"body")[0]:ye?y.documentElement:G},us=function(d){return J.call(d.ownerDocument||d,d,l.SHOW_ELEMENT|l.SHOW_COMMENT|l.SHOW_TEXT|l.SHOW_PROCESSING_INSTRUCTION|l.SHOW_CDATA_SECTION,null)},wt=function(d){return d instanceof h&&(typeof d.nodeName!="string"||typeof d.textContent!="string"||typeof d.removeChild!="function"||!(d.attributes instanceof p)||typeof d.removeAttribute!="function"||typeof d.setAttribute!="function"||typeof d.namespaceURI!="string"||typeof d.insertBefore!="function"||typeof d.hasChildNodes!="function")},ps=function(d){return typeof a=="function"&&d instanceof a};function le(w,d,y){tt(w,x=>{x.call(e,d,y,Me)})}const gs=function(d){let y=null;if(le(q.beforeSanitizeElements,d,null),wt(d))return oe(d),!0;const x=B(d.nodeName);if(le(q.uponSanitizeElement,d,{tagName:x,allowedTags:O}),Xe&&d.hasChildNodes()&&!ps(d.firstElementChild)&&W(/<[/\w!]/g,d.innerHTML)&&W(/<[/\w!]/g,d.textContent)||d.nodeType===Be.progressingInstruction||Xe&&d.nodeType===Be.comment&&W(/<[/\w]/g,d.data))return oe(d),!0;if(!(Se.tagCheck instanceof Function&&Se.tagCheck(x))&&(!O[x]||Ne[x])){if(!Ne[x]&&ms(x)&&($.tagNameCheck instanceof RegExp&&W($.tagNameCheck,x)||$.tagNameCheck instanceof Function&&$.tagNameCheck(x)))return!1;if(mt&&!ie[x]){const R=D(d)||d.parentNode,G=S(d)||d.childNodes;if(G&&R){const z=G.length;for(let K=z-1;K>=0;--K){const de=m(G[K],!0);de.__removalCount=(d.__removalCount||0)+1,R.insertBefore(de,E(d))}}}return oe(d),!0}return d instanceof c&&!Sn(d)||(x==="noscript"||x==="noembed"||x==="noframes")&&W(/<\/no(script|embed|frames)/i,d.innerHTML)?(oe(d),!0):(Te&&d.nodeType===Be.text&&(y=d.textContent,tt([ke,ue,k],R=>{y=De(y,R," ")}),d.textContent!==y&&(Oe(e.removed,{element:d.cloneNode()}),d.textContent=y)),le(q.afterSanitizeElements,d,null),!1)},fs=function(d,y,x){if(ns&&(y==="id"||y==="name")&&(x in t||x in En))return!1;if(!(pt&&!ut[y]&&W(T,y))){if(!(es&&W(H,y))){if(!(Se.attributeCheck instanceof Function&&Se.attributeCheck(y,d))){if(!F[y]||ut[y]){if(!(ms(d)&&($.tagNameCheck instanceof RegExp&&W($.tagNameCheck,d)||$.tagNameCheck instanceof Function&&$.tagNameCheck(d))&&($.attributeNameCheck instanceof RegExp&&W($.attributeNameCheck,y)||$.attributeNameCheck instanceof Function&&$.attributeNameCheck(y,d))||y==="is"&&$.allowCustomizedBuiltInElements&&($.tagNameCheck instanceof RegExp&&W($.tagNameCheck,x)||$.tagNameCheck instanceof Function&&$.tagNameCheck(x))))return!1}else if(!bt[y]){if(!W(Ee,De(x,ee,""))){if(!((y==="src"||y==="xlink:href"||y==="href")&&d!=="script"&&Dn(x,"data:")===0&&os[d])){if(!(ts&&!W(pe,De(x,ee,"")))){if(x)return!1}}}}}}}return!0},ms=function(d){return d!=="annotation-xml"&&St(d,me)},ys=function(d){le(q.beforeSanitizeAttributes,d,null);const{attributes:y}=d;if(!y||wt(d))return;const x={attrName:"",attrValue:"",keepAttr:!0,allowedAttributes:F,forceKeepAttr:void 0};let R=y.length;for(;R--;){const G=y[R],{name:z,namespaceURI:K,value:de}=G,Pe=B(z),kt=de;let U=z==="value"?kt:zn(kt);if(x.attrName=Pe,x.attrValue=U,x.keepAttr=!0,x.forceKeepAttr=void 0,le(q.uponSanitizeAttribute,d,x),U=x.attrValue,is&&(Pe==="id"||Pe==="name")&&(be(z,d),U=_n+U),Xe&&W(/((--!?|])>)|<\/(style|title|textarea)/i,U)){be(z,d);continue}if(Pe==="attributename"&&St(U,"href")){be(z,d);continue}if(x.forceKeepAttr)continue;if(!x.keepAttr){be(z,d);continue}if(!ss&&W(/\/>/i,U)){be(z,d);continue}Te&&tt([ke,ue,k],_s=>{U=De(U,_s," ")});const bs=B(d.nodeName);if(!fs(bs,Pe,U)){be(z,d);continue}if(C&&typeof u=="object"&&typeof u.getAttributeType=="function"&&!K)switch(u.getAttributeType(bs,Pe)){case"TrustedHTML":{U=C.createHTML(U);break}case"TrustedScriptURL":{U=C.createScriptURL(U);break}}if(U!==kt)try{K?d.setAttributeNS(K,z,U):d.setAttribute(z,U),wt(d)?oe(d):xs(e.removed)}catch{be(z,d)}}le(q.afterSanitizeAttributes,d,null)},Tn=function w(d){let y=null;const x=us(d);for(le(q.beforeSanitizeShadowDOM,d,null);y=x.nextNode();)le(q.uponSanitizeShadowNode,y,null),gs(y),ys(y),y.content instanceof o&&w(y.content);le(q.afterSanitizeShadowDOM,d,null)};return e.sanitize=function(w){let d=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},y=null,x=null,R=null,G=null;if(_t=!w,_t&&(w="<!-->"),typeof w!="string"&&!ps(w))if(typeof w.toString=="function"){if(w=w.toString(),typeof w!="string")throw ze("dirty is not a string, aborting")}else throw ze("toString is not a function");if(!e.isSupported)return w;if(gt||xt(d),e.removed=[],typeof w=="string"&&($e=!1),$e){if(w.nodeName){const de=B(w.nodeName);if(!O[de]||Ne[de])throw ze("root node is forbidden and cannot be sanitized in-place")}}else if(w instanceof a)y=hs("<!---->"),x=y.ownerDocument.importNode(w,!0),x.nodeType===Be.element&&x.nodeName==="BODY"||x.nodeName==="HTML"?y=x:y.appendChild(x);else{if(!Ae&&!Te&&!ye&&w.indexOf("<")===-1)return C&&Je?C.createHTML(w):w;if(y=hs(w),!y)return Ae?null:Je?j:""}y&&ft&&oe(y.firstChild);const z=us($e?w:y);for(;R=z.nextNode();)gs(R),ys(R),R.content instanceof o&&Tn(R.content);if($e)return w;if(Ae){if(Ve)for(G=ae.call(y.ownerDocument);y.firstChild;)G.appendChild(y.firstChild);else G=y;return(F.shadowroot||F.shadowrootmode)&&(G=We.call(s,G,!0)),G}let K=ye?y.outerHTML:y.innerHTML;return ye&&O["!doctype"]&&y.ownerDocument&&y.ownerDocument.doctype&&y.ownerDocument.doctype.name&&W(Ys,y.ownerDocument.doctype.name)&&(K="<!DOCTYPE "+y.ownerDocument.doctype.name+`>
`+K),Te&&tt([ke,ue,k],de=>{K=De(K,de," ")}),C&&Je?C.createHTML(K):K},e.setConfig=function(){let w=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};xt(w),gt=!0},e.clearConfig=function(){Me=null,gt=!1},e.isValidAttribute=function(w,d,y){Me||xt({});const x=B(w),R=B(d);return fs(x,R,y)},e.addHook=function(w,d){typeof d=="function"&&Oe(q[w],d)},e.removeHook=function(w,d){if(d!==void 0){const y=Rn(q[w],d);return y===-1?void 0:On(q[w],y,1)[0]}return xs(q[w])},e.removeHooks=function(w){q[w]=[]},e.removeAllHooks=function(){q=As()},e}var Qn=Xs();function _e(i){if(!i)return"";const e=document.createElement("div");return e.appendChild(document.createTextNode(i)),e.innerHTML}function ei(i){return i?Qn.sanitize(i,{ALLOWED_TAGS:["p","br","strong","b","em","i","u","s","del","h1","h2","h3","h4","h5","h6","ul","ol","li","a","img","code","pre","blockquote","table","thead","tbody","tr","th","td","span","div","hr"],ALLOWED_ATTR:["href","src","alt","title","class","target","rel"],ADD_ATTR:["target"],ALLOW_DATA_ATTR:!1,ALLOWED_URI_REGEXP:/^(?:(?:https?|mailto|tel):|[^a-z]|[a-z+.-]+(?:[^a-z+.\-:]|$))/i}):""}function rt(i){return i?i.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):""}let ti=0;function si(){return`node_${Date.now().toString(36)}_${(++ti).toString(36)}`}const Is=["#00e5ff","#ff2d78","#00ff88","#ffc107","#7c4dff","#ff6e40","#e6edf3"],Vs=[{id:"rectangle",icon:"â–¬",label:"Rectangle",meaning:"Process / Task"},{id:"rounded",icon:"â–¢",label:"Rounded",meaning:"Start / End"},{id:"diamond",icon:"â—‡",label:"Diamond",meaning:"Decision"},{id:"parallelogram",icon:"â–±",label:"Parallelogram",meaning:"Input / Output"},{id:"hexagon",icon:"â¬¡",label:"Hexagon",meaning:"Preparation"},{id:"circle",icon:"â—",label:"Circle",meaning:"Event / Trigger"},{id:"pill",icon:"â–­",label:"Pill",meaning:"Terminal"}],qt=[{id:"general",icon:"ðŸ“„",label:"General",color:"#7d8590"},{id:"feature",icon:"âš¡",label:"Feature",color:"#00e5ff"},{id:"constraint",icon:"ðŸ”’",label:"Constraint",color:"#ffc107"},{id:"reference",icon:"ðŸ“Ž",label:"Reference",color:"#7c4dff"},{id:"risk",icon:"âš ï¸",label:"Risk",color:"#ff2d78"},{id:"techNote",icon:"ðŸ”§",label:"Tech Note",color:"#00ff88"}],Ut=[{id:"critical",icon:"ðŸ”´",label:"Critical",color:"#ff2d78",ring:"#ff2d78"},{id:"high",icon:"ðŸŸ ",label:"High",color:"#ff6e40",ring:"#ff6e40"},{id:"medium",icon:"ðŸŸ¡",label:"Medium",color:"#ffc107",ring:"#ffc107"},{id:"low",icon:"ðŸŸ¢",label:"Low",color:"#00ff88",ring:"#00ff88"}],Rt={unassigned:{icon:"âšª",label:"Unassigned",color:"#7d8590"},planning:{icon:"ðŸ”µ",label:"Planning",color:"#00e5ff"},"in-review":{icon:"ðŸŸ¡",label:"In Review",color:"#ffc107"},approved:{icon:"ðŸŸ¢",label:"Approved",color:"#00ff88"},blocked:{icon:"ðŸ”´",label:"Blocked",color:"#ff2d78"}},jt=[{id:"coo",icon:"ðŸ‘”",label:"COO"},{id:"cto",icon:"ðŸ—ï¸",label:"CTO"},{id:"cfo",icon:"ðŸ’°",label:"CFO"},{id:"creative",icon:"ðŸŽ¨",label:"Creative"},{id:"frontend",icon:"ðŸ–¥ï¸",label:"Frontend"},{id:"backend",icon:"âš™ï¸",label:"Backend"},{id:"devils-advocate",icon:"ðŸ˜ˆ",label:"Devil's Advocate"},{id:"sentinel",icon:"ðŸ›¡ï¸",label:"Sentinel"},{id:"documenter",icon:"ðŸ“",label:"Documenter"},{id:"token-auditor",icon:"ðŸ”¢",label:"Token Auditor"},{id:"api-cost-auditor",icon:"ðŸ’µ",label:"API Cost Auditor"},{id:"project-auditor",icon:"ðŸ“Š",label:"Project Auditor"}];class ni{constructor(e,t){this.bus=e,this.viewport=t,this.nodesLayer=document.getElementById("nodes-layer"),this.container=document.getElementById("canvas-container"),this.nodes=new Map,this.selected=new Set,this._dragging=null,this._dragOffsets=new Map,this.connectionManager=null,this._bindEvents()}setConnectionManager(e){this.connectionManager=e}_bindEvents(){var e,t;this.container.addEventListener("dblclick",s=>{if(s.target.closest(".mind-node")||s.target.closest(".node-port")||s.target.closest(".connection-group")||s.target.closest(".connection-hit-area"))return;const n=this.container.getBoundingClientRect(),o=this.viewport.screenToWorld(s.clientX-n.left,s.clientY-n.top);this.createNode(o.x-70,o.y-20)}),this.container.addEventListener("mousedown",s=>{s.button===0&&(this.viewport.isSpaceDown||!s.target.closest(".mind-node")&&!s.target.closest(".toolbar")&&!s.target.closest(".property-panel")&&!s.target.closest(".context-menu")&&(this.deselectAll(),this.bus.emit("selection:changed",[])))}),window.addEventListener("mousemove",s=>this._onDragMove(s)),window.addEventListener("mouseup",s=>this._onDragEnd(s)),(e=document.getElementById("btn-add-node"))==null||e.addEventListener("click",()=>{const s=this.container.getBoundingClientRect(),n=this.viewport.screenToWorld(s.width/2,s.height/2);this.createNode(n.x-70,n.y-20)}),(t=document.getElementById("btn-delete"))==null||t.addEventListener("click",()=>{this.deleteSelected()})}createNode(e,t,s={}){const n=s.id||si(),o=s.text||"",r=s.color||Is[this.nodes.size%Is.length],a=s.shape||"rectangle",c=s.nodeType||"general",l=s.priority||"medium",p=s.phase??null,h=s.assignedAgent||null,g=s.agentStatus||"unassigned",u=s.agentNotes||null,f=document.createElement("div");f.className=`mind-node appearing shape-${a}`,l!=="medium"&&f.classList.add(`priority-${l}`),f.dataset.nodeId=n,f.style.left=`${e}px`,f.style.top=`${t}px`,f.innerHTML=this._buildNodeHTML(n,o,r,c,l,p,h,g),f.addEventListener("animationend",()=>f.classList.remove("appearing"),{once:!0}),f.addEventListener("mousedown",S=>{S.target.classList.contains("node-port")||S.button===0&&(this.viewport.isSpaceDown||(S.stopPropagation(),S.shiftKey?this._toggleSelect(n):this.selected.has(n)||(this.deselectAll(),this._select(n)),this._startDrag(S,n)))});const m=f.querySelector(".node-text");m.addEventListener("dblclick",S=>{S.stopPropagation(),this._startEditing(n,m)}),this.nodesLayer.appendChild(f);const b={id:n,text:o,x:e,y:t,color:r,shape:a,el:f,nodeType:c,priority:l,phase:p,assignedAgent:h,agentStatus:g,agentNotes:u};this.nodes.set(n,b),this.deselectAll(),this._select(n),this.bus.emit("node:created",b),this.bus.emit("state:changed");const E=document.getElementById("help-hint");return E&&E.classList.add("hidden"),b}_buildNodeHTML(e,t,s,n,o,r,a,c){const l=Rt[c]||Rt.unassigned,p=qt.find(b=>b.id===n),h=a?jt.find(b=>b.id===a):null,g=c!=="unassigned"?`<span class="node-status-badge" title="${rt(l.label)}" style="background:${l.color}">${l.icon}</span>`:"",u=h?`<span class="node-agent-chip" title="${rt(h.label)}">${h.icon} ${_e(h.label)}</span>`:"",f=[];r!=null&&f.push(`Phase ${r}`),n!=="general"&&f.push(`${(p==null?void 0:p.icon)||""} ${_e((p==null?void 0:p.label)||n)}`);const m=f.length>0||u?`<div class="node-meta">${u}${f.length>0?`<span class="node-meta-text">${f.join(" Â· ")}</span>`:""}</div>`:"";return`
      <div class="node-color-bar" style="background:${s}"></div>
      ${g}
      <div class="node-text" spellcheck="false">${_e(t||"")}</div>
      ${m}
      <div class="node-port port-top" data-port="top" data-node-id="${e}"></div>
      <div class="node-port port-right" data-port="right" data-node-id="${e}"></div>
      <div class="node-port port-bottom" data-port="bottom" data-node-id="${e}"></div>
      <div class="node-port port-left" data-port="left" data-node-id="${e}"></div>
    `}_refreshNodeOverlays(e){const t=this.nodes.get(e);if(!t)return;const s=t.el,n=s.querySelector(".node-text"),o=(n==null?void 0:n.textContent)||t.text;s.innerHTML=this._buildNodeHTML(t.id,o,t.color,t.nodeType,t.priority,t.phase,t.assignedAgent,t.agentStatus),Ut.forEach(a=>s.classList.remove(`priority-${a.id}`)),t.priority!=="medium"&&s.classList.add(`priority-${t.priority}`);const r=s.querySelector(".node-text");r.addEventListener("dblclick",a=>{a.stopPropagation(),this._startEditing(t.id,r)})}setNodeType(e,t){const s=this.nodes.get(e);s&&(s.nodeType=t,this._refreshNodeOverlays(e),this.bus.emit("node:updated",s),this.bus.emit("state:changed"))}setPriority(e,t){const s=this.nodes.get(e);s&&(s.priority=t,this._refreshNodeOverlays(e),this.bus.emit("node:updated",s),this.bus.emit("state:changed"))}setPhase(e,t){const s=this.nodes.get(e);s&&(s.phase=t,this._refreshNodeOverlays(e),this.bus.emit("node:updated",s),this.bus.emit("state:changed"))}setAssignedAgent(e,t){const s=this.nodes.get(e);s&&(s.assignedAgent=t,t&&s.agentStatus==="unassigned"&&(s.agentStatus="planning"),this._refreshNodeOverlays(e),this.bus.emit("node:updated",s),this.bus.emit("state:changed"))}setAgentStatus(e,t){const s=this.nodes.get(e);s&&(s.agentStatus=t,this._refreshNodeOverlays(e),this.bus.emit("node:updated",s),this.bus.emit("state:changed"))}setAgentNotes(e,t){const s=this.nodes.get(e);s&&(s.agentNotes=t,this.bus.emit("node:updated",s),this.bus.emit("state:changed"))}_startEditing(e,t){t.contentEditable="true",t.focus();const s=document.createRange();s.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(s);const o=()=>{t.contentEditable="false";const a=this.nodes.get(e);a&&(a.text=t.textContent.trim(),this.bus.emit("node:updated",a),this.bus.emit("state:changed")),t.removeEventListener("blur",o),t.removeEventListener("keydown",r)},r=a=>{a.key==="Enter"&&!a.shiftKey&&(a.preventDefault(),t.blur()),a.key==="Escape"&&t.blur(),a.stopPropagation()};t.addEventListener("blur",o),t.addEventListener("keydown",r)}_select(e){this.selected.add(e);const t=this.nodes.get(e);t&&t.el.classList.add("selected"),this.bus.emit("selection:changed",[...this.selected])}_toggleSelect(e){if(this.selected.has(e)){this.selected.delete(e);const t=this.nodes.get(e);t&&t.el.classList.remove("selected")}else this._select(e);this.bus.emit("selection:changed",[...this.selected])}deselectAll(){this.selected.forEach(e=>{const t=this.nodes.get(e);t&&t.el.classList.remove("selected")}),this.selected.clear()}_startDrag(e,t){this._dragging=t,this._dragOffsets.clear();const s=this.viewport.screenToWorld(e.clientX,e.clientY);this.selected.forEach(n=>{const o=this.nodes.get(n);o&&(o.el.classList.add("dragging"),this._dragOffsets.set(n,{dx:o.x-s.x,dy:o.y-s.y}))})}_onDragMove(e){if(!this._dragging)return;const t=this.viewport.screenToWorld(e.clientX,e.clientY);if(this.selected.forEach(s=>{const n=this.nodes.get(s),o=this._dragOffsets.get(s);n&&o&&(n.x=t.x+o.dx,n.y=t.y+o.dy,n.el.style.left=`${n.x}px`,n.el.style.top=`${n.y}px`,this.bus.emit("node:moved",n))}),this.selected.size===1&&this.connectionManager){const s=[...this.selected][0],n=this.nodes.get(s);if(n){const o=n.x+n.el.offsetWidth/2,r=n.y+n.el.offsetHeight/2;this.connectionManager.highlightSpliceTarget(o,r,s)}}}_onDragEnd(e){if(this._dragging){if(this.selected.size===1&&this.connectionManager){const t=[...this.selected][0],s=this.nodes.get(t);if(s){const n=s.x+s.el.offsetWidth/2,o=s.y+s.el.offsetHeight/2,r=this.connectionManager.findConnectionAtPoint(n,o,t);r&&(this.connectionManager.clearSpliceHighlight(),this.connectionManager.spliceNodeIntoConnection(r.id,t))}this.connectionManager.clearSpliceHighlight()}this.selected.forEach(t=>{const s=this.nodes.get(t);s&&s.el.classList.remove("dragging")}),this._dragging=null,this._dragOffsets.clear(),this.bus.emit("state:changed")}}deleteSelected(){if(this.selected.size===0)return;[...this.selected].forEach(t=>this.deleteNode(t)),this.bus.emit("state:changed")}deleteNode(e){const t=this.nodes.get(e);t&&(t.el.remove(),this.nodes.delete(e),this.selected.delete(e),this.bus.emit("node:deleted",{id:e}),this.bus.emit("selection:changed",[...this.selected]))}getNode(e){return this.nodes.get(e)}setShape(e,t){const s=this.nodes.get(e);s&&(Vs.forEach(n=>s.el.classList.remove(`shape-${n.id}`)),s.el.classList.add(`shape-${t}`),s.shape=t,this.bus.emit("node:updated",s),this.bus.emit("state:changed"))}getPortPosition(e,t){const s=this.nodes.get(e);if(!s)return null;const n=s.el,o=n.offsetWidth,r=n.offsetHeight;switch(t){case"top":return{x:s.x+o/2,y:s.y};case"right":return{x:s.x+o,y:s.y+r/2};case"bottom":return{x:s.x+o/2,y:s.y+r};case"left":return{x:s.x,y:s.y+r/2};default:return{x:s.x+o/2,y:s.y+r/2}}}serialize(){const e=[];return this.nodes.forEach(t=>{e.push({id:t.id,text:t.text,x:t.x,y:t.y,color:t.color,shape:t.shape||"rectangle",nodeType:t.nodeType||"general",priority:t.priority||"medium",phase:t.phase??null,assignedAgent:t.assignedAgent||null,agentStatus:t.agentStatus||"unassigned",agentNotes:t.agentNotes||null})}),e}deserialize(e){this.nodes.forEach(t=>t.el.remove()),this.nodes.clear(),this.selected.clear(),e&&(e.forEach(t=>{this.createNode(t.x,t.y,{id:t.id,text:t.text,color:t.color,shape:t.shape||"rectangle",nodeType:t.nodeType||"general",priority:t.priority||"medium",phase:t.phase??null,assignedAgent:t.assignedAgent||null,agentStatus:t.agentStatus||"unassigned",agentNotes:t.agentNotes||null})}),this.deselectAll())}getBounds(){if(this.nodes.size===0)return null;let e=1/0,t=1/0,s=-1/0,n=-1/0;return this.nodes.forEach(o=>{const r=o.el.offsetWidth,a=o.el.offsetHeight;o.x<e&&(e=o.x),o.y<t&&(t=o.y),o.x+r>s&&(s=o.x+r),o.y+a>n&&(n=o.y+a)}),{minX:e,minY:t,maxX:s,maxY:n,width:s-e,height:n-t}}}let ii=0;function oi(){return`conn_${Date.now().toString(36)}_${(++ii).toString(36)}`}class ri{constructor(e,t){this.bus=e,this.nodeManager=t,this.svgLayer=document.getElementById("connections-layer"),this.container=document.getElementById("canvas-container"),this.connections=new Map,this.selectedConnection=null,this._connecting=!1,this._connSource=null,this._previewLine=null,this._detaching=!1,this._detachConn=null,this._detachEnd=null,this._detachAnchor=null,this._detachPreview=null,this._bindEvents(),this.bus.on("node:moved",()=>this._renderAll()),this.bus.on("node:deleted",({id:s})=>this._removeConnectionsForNode(s))}_bindEvents(){this.container.addEventListener("mousedown",t=>{const s=t.target.closest(".node-port");!s||t.button!==0||(t.stopPropagation(),t.preventDefault(),this._connecting=!0,this._connSource={nodeId:s.dataset.nodeId,port:s.dataset.port},this._previewLine=document.createElementNS("http://www.w3.org/2000/svg","path"),this._previewLine.classList.add("connection-preview"),this.svgLayer.appendChild(this._previewLine))}),this.svgLayer.addEventListener("mousedown",t=>{const s=t.target.closest(".connection-dot");if(!s||t.button!==0)return;const n=s.closest(".connection-group");if(!n)return;t.stopPropagation(),t.preventDefault();const o=n.dataset.connectionId,r=this.connections.get(o);if(!r)return;const a=s===r.dot1;this._detaching=!0,this._detachConn=r,this._detachEnd=a?"source":"target",this._detachAnchor=a?{nodeId:r.targetId,port:r.targetPort}:{nodeId:r.sourceId,port:r.sourcePort},r.group.style.opacity="0.2",this._detachPreview=document.createElementNS("http://www.w3.org/2000/svg","path"),this._detachPreview.classList.add("connection-preview"),this.svgLayer.appendChild(this._detachPreview)}),window.addEventListener("mousemove",t=>{const s=this.container.getBoundingClientRect(),o=this.nodeManager.viewport.screenToWorld(t.clientX-s.left,t.clientY-s.top);if(this._connecting&&this._connSource){const r=this.nodeManager.getPortPosition(this._connSource.nodeId,this._connSource.port);if(!r)return;const a=this._computePath(r.x,r.y,o.x,o.y);this._previewLine.setAttribute("d",a)}if(this._detaching&&this._detachAnchor){const r=this.nodeManager.getPortPosition(this._detachAnchor.nodeId,this._detachAnchor.port);if(!r)return;const a=this._computePath(r.x,r.y,o.x,o.y);this._detachPreview.setAttribute("d",a)}}),window.addEventListener("mouseup",t=>{if(this._connecting){const s=t.target.closest(".node-port"),n=t.target.closest(".mind-node");if(s&&this._connSource){const o=s.dataset.nodeId,r=s.dataset.port;o!==this._connSource.nodeId&&(this._connectionExists(this._connSource.nodeId,this._connSource.port,o,r)||this.createConnection(this._connSource.nodeId,this._connSource.port,o,r))}else if(n&&this._connSource){const o=n.dataset.nodeId;if(o&&o!==this._connSource.nodeId){const r=this._findBestPort(this._connSource.nodeId,o);this._connectionExists(this._connSource.nodeId,this._connSource.port,o,r)||this.createConnection(this._connSource.nodeId,this._connSource.port,o,r)}}else if(this._connSource&&!s&&!n){const o=this.container.getBoundingClientRect(),a=this.nodeManager.viewport.screenToWorld(t.clientX-o.left,t.clientY-o.top),c=this._oppositePort(this._connSource.port),l=this.nodeManager.createNode(a.x-70,a.y-20);this.createConnection(this._connSource.nodeId,this._connSource.port,l.id,c)}this._previewLine&&(this._previewLine.remove(),this._previewLine=null),this._connecting=!1,this._connSource=null}if(this._detaching){const s=t.target.closest(".node-port"),n=t.target.closest(".mind-node");if(s){const o=s.dataset.nodeId,r=s.dataset.port;if(o!==this._detachAnchor.nodeId){const a=this._detachConn.id;this._detachConn.group.style.opacity="",this.deleteConnection(a),this.createConnection(this._detachAnchor.nodeId,this._detachAnchor.port,o,r)}else this._detachConn.group.style.opacity=""}else if(n){const o=n.dataset.nodeId;if(o&&o!==this._detachAnchor.nodeId){const r=this._findBestPort(this._detachAnchor.nodeId,o),a=this._detachConn.id;this._detachConn.group.style.opacity="",this.deleteConnection(a),this.createConnection(this._detachAnchor.nodeId,this._detachAnchor.port,o,r)}else this._detachConn.group.style.opacity=""}else this._detachConn.group.style.opacity="",this.deleteConnection(this._detachConn.id),this.bus.emit("state:changed");this._detachPreview&&(this._detachPreview.remove(),this._detachPreview=null),this._detaching=!1,this._detachConn=null,this._detachEnd=null,this._detachAnchor=null}});const e=t=>{const s=t.target.closest(".connection-group");if(!s)return;t.stopPropagation(),t.preventDefault(),t._connectionHandled=!0;const n=s.dataset.connectionId;n&&(this.deleteConnection(n),this.bus.emit("state:changed"))};this.svgLayer.addEventListener("dblclick",e),this.container.addEventListener("dblclick",t=>{const s=t.target.closest(".connection-group");if(!s||t._connectionHandled)return;t.stopPropagation();const n=s.dataset.connectionId;n&&(this.deleteConnection(n),this.bus.emit("state:changed"))}),this.container.addEventListener("mousedown",t=>{!t.target.closest(".connection-group")&&this.selectedConnection&&this.deselectConnection()})}_oppositePort(e){switch(e){case"top":return"bottom";case"bottom":return"top";case"left":return"right";case"right":return"left";default:return"top"}}createConnection(e,t,s,n,o={}){const r=o.id||oi(),a=document.createElementNS("http://www.w3.org/2000/svg","g");a.classList.add("connection-group"),a.dataset.connectionId=r;const c=document.createElementNS("http://www.w3.org/2000/svg","path");c.classList.add("connection-hit-area");const l=document.createElementNS("http://www.w3.org/2000/svg","path");l.classList.add("connection-path");const p=document.createElementNS("http://www.w3.org/2000/svg","circle");p.classList.add("connection-dot"),p.setAttribute("r","3.5");const h=document.createElementNS("http://www.w3.org/2000/svg","circle");h.classList.add("connection-dot"),h.setAttribute("r","3.5"),a.appendChild(c),a.appendChild(l),a.appendChild(p),a.appendChild(h),a.addEventListener("mousedown",m=>{m.stopPropagation(),this.selectConnection(r)}),this.svgLayer.appendChild(a);const g=o.directed||!1,u=g===!0?"forward":g==="forward"||g==="both"?g:"none",f={id:r,sourceId:e,sourcePort:t,targetId:s,targetPort:n,directed:u,group:a,pathEl:l,hitArea:c,dot1:p,dot2:h};return this.connections.set(r,f),u!=="none"&&this._applyArrow(f),this._renderConnection(f),this.bus.emit("connection:created",f),this.bus.emit("state:changed"),f}toggleArrow(e){const t=this.connections.get(e);if(!t)return;const s={none:"forward",forward:"both",both:"none"};t.directed=s[t.directed]||"forward",this._applyArrow(t),this.bus.emit("state:changed")}setArrow(e,t){const s=this.connections.get(e);s&&(s.directed=t,this._applyArrow(s),this.bus.emit("state:changed"))}_applyArrow(e){const s=e.group.classList.contains("selected")?"magenta":"cyan";e.directed==="forward"||e.directed==="both"?e.pathEl.setAttribute("marker-end",`url(#arrowhead-${s})`):e.pathEl.removeAttribute("marker-end"),e.directed==="both"?e.pathEl.setAttribute("marker-start",`url(#arrowhead-start-${s})`):e.pathEl.removeAttribute("marker-start")}_renderConnection(e){const t=this.nodeManager.getPortPosition(e.sourceId,e.sourcePort),s=this.nodeManager.getPortPosition(e.targetId,e.targetPort);if(!t||!s)return;const n=this._computeSmartPath(t.x,t.y,e.sourcePort,s.x,s.y,e.targetPort);e._basePathD=n,e.pathEl.setAttribute("d",n),e.hitArea.setAttribute("d",n),e.dot1.setAttribute("cx",t.x),e.dot1.setAttribute("cy",t.y),e.dot2.setAttribute("cx",s.x),e.dot2.setAttribute("cy",s.y),this._scheduleJumpUpdate()}_renderAll(){this.connections.forEach(e=>this._renderConnection(e))}_scheduleJumpUpdate(){cancelAnimationFrame(this._jumpFrame),this._jumpFrame=requestAnimationFrame(()=>this._applyAllJumps())}_computePath(e,t,s,n){const o=s-e,r=n-t,a=e+o/2,c=t+r/2;return Math.abs(o)>Math.abs(r)?`M ${e} ${t} L ${a} ${t} L ${a} ${n} L ${s} ${n}`:`M ${e} ${t} L ${e} ${c} L ${s} ${c} L ${s} ${n}`}_computeSmartPath(e,t,s,n,o,r){const c=this._portDirection(s),l=this._portDirection(r),p=e+c.dx*30,h=t+c.dy*30,g=n+l.dx*30,u=o+l.dy*30,f=[`M ${e} ${t}`,`L ${p} ${h}`],m=g-p,b=u-h;if(c.dx!==0&&l.dy!==0||c.dx!==0&&l.dx!==0&&Math.abs(m)>Math.abs(b))f.push(`L ${g} ${h}`),f.push(`L ${g} ${u}`);else if(c.dy!==0&&l.dx!==0||c.dy!==0&&l.dy!==0)f.push(`L ${p} ${u}`),f.push(`L ${g} ${u}`);else{const E=p+m/2,S=h+b/2;Math.abs(m)>Math.abs(b)?(f.push(`L ${E} ${h}`),f.push(`L ${E} ${u}`)):(f.push(`L ${p} ${S}`),f.push(`L ${g} ${S}`)),f.push(`L ${g} ${u}`)}return f.push(`L ${n} ${o}`),f.join(" ")}_portDirection(e){switch(e){case"top":return{dx:0,dy:-1};case"bottom":return{dx:0,dy:1};case"left":return{dx:-1,dy:0};case"right":return{dx:1,dy:0};default:return{dx:0,dy:-1}}}_parsePathPoints(e){const t=[],s=/[ML]\s*([-\d.]+)\s+([-\d.]+)/g;let n;for(;(n=s.exec(e))!==null;)t.push({x:parseFloat(n[1]),y:parseFloat(n[2])});return t}_findSegmentCrossings(e,t){const s=[];for(let o=0;o<e.length-1;o++){const r=e[o],a=e[o+1],c=Math.abs(a.y-r.y)<.5,l=Math.abs(a.x-r.x)<.5;if(!(!c&&!l))for(let p=0;p<t.length-1;p++){const h=t[p],g=t[p+1],u=Math.abs(g.y-h.y)<.5,f=Math.abs(g.x-h.x)<.5;if(!u&&!f||c===u)continue;let m,b;c&&f?(b=r.y,m=h.x):(m=r.x,b=h.y);const E=Math.min(r.x,a.x),S=Math.max(r.x,a.x),D=Math.min(r.y,a.y),C=Math.max(r.y,a.y),j=Math.min(h.x,g.x),L=Math.max(h.x,g.x),J=Math.min(h.y,g.y),ae=Math.max(h.y,g.y);if(c){if(m<=E+6||m>=S-6||Math.abs(b-r.y)>.5)continue}else if(b<=D+6||b>=C-6||Math.abs(m-r.x)>.5)continue;if(u){if(m<=j+6||m>=L-6||Math.abs(b-h.y)>.5)continue}else if(b<=J+6||b>=ae-6||Math.abs(m-h.x)>.5)continue;s.push({x:m,y:b,segIndex:o})}}return s}_buildPathWithJumps(e,t){if(t.length===0)return null;const s=6;let n=`M ${e[0].x} ${e[0].y}`;for(let o=1;o<e.length;o++){const r=e[o-1],a=e[o],c=t.filter(p=>p.segIndex===o-1);if(c.length===0){n+=` L ${a.x} ${a.y}`;continue}if(Math.abs(a.y-r.y)<.5){const p=a.x>r.x;c.sort((h,g)=>p?h.x-g.x:g.x-h.x);for(const h of c){const g=p?1:-1;n+=` L ${h.x-s*g} ${h.y}`,n+=` A ${s} ${s} 0 0 ${p?0:1} ${h.x+s*g} ${h.y}`}}else{const p=a.y>r.y;c.sort((h,g)=>p?h.y-g.y:g.y-h.y);for(const h of c){const g=p?1:-1;n+=` L ${h.x} ${h.y-s*g}`,n+=` A ${s} ${s} 0 0 ${p?1:0} ${h.x} ${h.y+s*g}`}}n+=` L ${a.x} ${a.y}`}return n}_applyAllJumps(){const e=[];for(const t of this.connections.values()){const s=t._basePathD;if(!s)continue;const n=this._parsePathPoints(s);t._pathPoints=n,e.push({conn:t,pts:n})}for(const{conn:t,pts:s}of e){const n=[];for(const{conn:o,pts:r}of e){if(o.id===t.id)continue;const a=this._findSegmentCrossings(s,r);n.push(...a)}if(n.length>0){const o=this._buildPathWithJumps(s,n);o&&t.pathEl.setAttribute("d",o)}else t.pathEl.setAttribute("d",t._basePathD)}}_findBestPort(e,t){const s=this.nodeManager.getNode(e),n=this.nodeManager.getNode(t);if(!s||!n)return"left";const o=s.el,r=n.el,a=s.x+o.offsetWidth/2,c=s.y+o.offsetHeight/2,l=n.x+r.offsetWidth/2,p=n.y+r.offsetHeight/2,h=a-l,g=c-p;return Math.abs(h)>Math.abs(g)?h>0?"right":"left":g>0?"bottom":"top"}selectConnection(e){this.deselectConnection();const t=this.connections.get(e);t&&(t.group.classList.add("selected"),this.selectedConnection=e,t.directed!=="none"&&this._applyArrow(t),this.nodeManager.deselectAll(),this.bus.emit("connection:selected",t))}deselectConnection(){if(this.selectedConnection){const e=this.connections.get(this.selectedConnection);e&&(e.group.classList.remove("selected"),e.directed!=="none"&&this._applyArrow(e)),this.selectedConnection=null}}deleteConnection(e){const t=this.connections.get(e);t&&(t.group.remove(),this.connections.delete(e),this.selectedConnection===e&&(this.selectedConnection=null),this.bus.emit("connection:deleted",{id:e}))}deleteSelectedConnection(){this.selectedConnection&&(this.deleteConnection(this.selectedConnection),this.bus.emit("state:changed"))}_removeConnectionsForNode(e){const t=[];this.connections.forEach((s,n)=>{(s.sourceId===e||s.targetId===e)&&t.push(n)}),t.forEach(s=>this.deleteConnection(s))}getConnectionsForNode(e){const t=[];return this.connections.forEach(s=>{(s.sourceId===e||s.targetId===e)&&t.push(s)}),t}disconnectAll(e){const t=this.getConnectionsForNode(e);return t.forEach(s=>this.deleteConnection(s.id)),t.length>0&&this.bus.emit("state:changed"),t.length}findConnectionAtPoint(e,t,s=null){const n=new DOMPoint(e,t);for(const o of this.connections.values())if(!(s&&(o.sourceId===s||o.targetId===s)))try{if(o.hitArea.isPointInStroke(n))return o}catch{}return null}spliceNodeIntoConnection(e,t){const s=this.connections.get(e);if(!s)return!1;const{sourceId:n,sourcePort:o,targetId:r,targetPort:a,directed:c}=s,l=this._findBestPort(n,t),p=this._findBestPort(r,t),h=p===l?this._oppositePort(l):p;return this.deleteConnection(e),this.createConnection(n,o,t,l,{directed:c}),this.createConnection(t,h,r,a,{directed:c}),this.bus.emit("state:changed"),!0}highlightSpliceTarget(e,t,s){this.clearSpliceHighlight();const n=this.findConnectionAtPoint(e,t,s);return n&&(n.group.classList.add("splice-target"),this._spliceHighlight=n.id),n}clearSpliceHighlight(){if(this._spliceHighlight){const e=this.connections.get(this._spliceHighlight);e&&e.group.classList.remove("splice-target"),this._spliceHighlight=null}}_connectionExists(e,t,s,n){for(const o of this.connections.values())if(o.sourceId===e&&o.sourcePort===t&&o.targetId===s&&o.targetPort===n||o.sourceId===s&&o.sourcePort===n&&o.targetId===e&&o.targetPort===t)return!0;return!1}serialize(){const e=[];return this.connections.forEach(t=>{e.push({id:t.id,sourceId:t.sourceId,sourcePort:t.sourcePort,targetId:t.targetId,targetPort:t.targetPort,directed:t.directed||"none"})}),e}deserialize(e){this.connections.forEach(t=>t.group.remove()),this.connections.clear(),this.selectedConnection=null,e&&e.forEach(t=>{this.nodeManager.getNode(t.sourceId)&&this.nodeManager.getNode(t.targetId)&&this.createConnection(t.sourceId,t.sourcePort,t.targetId,t.targetPort,{id:t.id,directed:t.directed||"none"})})}}class ai{constructor(e,t,s,n){this.bus=e,this.nodeManager=t,this.connectionManager=s,this.viewport=n,this.el=document.getElementById("context-menu"),this.itemsEl=document.getElementById("context-menu-items"),this.container=document.getElementById("canvas-container"),this._visible=!1,this._clickWorld=null,this._bindEvents()}_bindEvents(){this.container.addEventListener("contextmenu",e=>{e.preventDefault();const t=this.container.getBoundingClientRect();this._clickWorld=this.viewport.screenToWorld(e.clientX-t.left,e.clientY-t.top);const s=e.target.closest(".connection-group");if(s){const o=s.dataset.connectionId;if(o){this._showConnectionMenu(e.clientX,e.clientY,o);return}}const n=e.target.closest(".mind-node");n?this._showNodeMenu(e.clientX,e.clientY,n.dataset.nodeId):this._showCanvasMenu(e.clientX,e.clientY)}),window.addEventListener("mousedown",e=>{this._visible&&!this.el.contains(e.target)&&this.hide()}),window.addEventListener("keydown",e=>{e.key==="Escape"&&this.hide()})}_showCanvasMenu(e,t){this._buildMenu([{label:"Add Node",shortcut:"Dbl-Click",action:()=>{this.nodeManager.createNode(this._clickWorld.x-70,this._clickWorld.y-20)}},{type:"divider"},{label:"Zoom to Fit",action:()=>this.bus.emit("viewport:fit-request")},{label:"Reset Zoom",shortcut:"100%",action:()=>{this.viewport.zoom=1,this.viewport._applyTransform(),this.bus.emit("viewport:changed",this.viewport.getState())}}]),this._show(e,t)}_showNodeMenu(e,t,s){const n=this.nodeManager.getNode(s);if(!n)return;this.nodeManager.selected.has(s)||(this.nodeManager.deselectAll(),this.nodeManager._select(s));const o=this.connectionManager.getConnectionsForNode(s).length,r=[{label:"Edit Text",action:()=>{const a=n.el.querySelector(".node-text");this.nodeManager._startEditing(s,a)}},{type:"divider"},{label:"Shape",type:"header"},...Vs.map(a=>({label:`${a.icon} ${a.label}`,shortcut:a.meaning,className:n.shape===a.id?"menu-active":"",action:()=>this.nodeManager.setShape(s,a.id)})),{type:"divider"},{label:"Node Type",type:"header"},...qt.map(a=>({label:`${a.icon} ${a.label}`,className:n.nodeType===a.id?"menu-active":"",action:()=>this.nodeManager.setNodeType(s,a.id)})),{type:"divider"},{label:"Priority",type:"header"},...Ut.map(a=>({label:`${a.icon} ${a.label}`,className:n.priority===a.id?"menu-active":"",action:()=>this.nodeManager.setPriority(s,a.id)})),{type:"divider"},{label:"Assign Agent",type:"header"},{label:"âšª Unassigned",className:n.assignedAgent?"":"menu-active",action:()=>{this.nodeManager.setAssignedAgent(s,null),this.nodeManager.setAgentStatus(s,"unassigned")}},...jt.map(a=>({label:`${a.icon} ${a.label}`,className:n.assignedAgent===a.id?"menu-active":"",action:()=>this.nodeManager.setAssignedAgent(s,a.id)})),{type:"divider"},{label:"Duplicate",action:()=>{this.nodeManager.createNode(n.x+30,n.y+30,{text:n.text,color:n.color,shape:n.shape,nodeType:n.nodeType,priority:n.priority})}}];o>0&&(r.push({type:"divider"}),r.push({label:"Disconnect All",shortcut:`${o}`,action:()=>{this.connectionManager.disconnectAll(s)}})),r.push({type:"divider"}),r.push({label:"Delete",shortcut:"Del",action:()=>{this.nodeManager.deleteNode(s),this.bus.emit("state:changed")}}),this._buildMenu(r),this._show(e,t)}_showConnectionMenu(e,t,s){const n=this.connectionManager.connections.get(s);if(!n)return;this.connectionManager.selectConnection(s);const o=n.directed,r=[];o==="none"?(r.push({label:"â†’ Add Arrow",action:()=>this.connectionManager.setArrow(s,"forward")}),r.push({label:"â‡† Add Bidirectional",action:()=>this.connectionManager.setArrow(s,"both")})):o==="forward"?(r.push({label:"â‡† Make Bidirectional",action:()=>this.connectionManager.setArrow(s,"both")}),r.push({label:"â†” Reverse Direction",action:()=>{const{sourceId:a,sourcePort:c,targetId:l,targetPort:p,directed:h}=n;this.connectionManager.deleteConnection(s),this.connectionManager.createConnection(l,p,a,c,{directed:h})}}),r.push({label:"âœ• Remove Arrow",action:()=>this.connectionManager.setArrow(s,"none")})):o==="both"&&(r.push({label:"â†’ Make One-way",action:()=>this.connectionManager.setArrow(s,"forward")}),r.push({label:"âœ• Remove Arrows",action:()=>this.connectionManager.setArrow(s,"none")})),r.push({type:"divider"}),r.push({label:"Delete Connection",shortcut:"Del",action:()=>{this.connectionManager.deleteConnection(s),this.bus.emit("state:changed")}}),this._buildMenu(r),this._show(e,t)}_buildMenu(e){this.itemsEl.innerHTML="",e.forEach(t=>{const s=document.createElement("li");t.type==="divider"?s.className="menu-divider":t.type==="header"?(s.className="menu-header",s.textContent=t.label):(s.innerHTML=`<span>${t.label}</span>${t.shortcut?`<span class="shortcut">${t.shortcut}</span>`:""}`,t.className&&s.classList.add(t.className),s.addEventListener("click",()=>{var n;this.hide(),(n=t.action)==null||n.call(t)})),this.itemsEl.appendChild(s)})}_show(e,t){this.el.style.left=`${e}px`,this.el.style.top=`${t}px`,this.el.style.display="block",this._visible=!0,requestAnimationFrame(()=>{const s=this.el.getBoundingClientRect();s.right>window.innerWidth&&(this.el.style.left=`${e-s.width}px`),s.bottom>window.innerHeight&&(this.el.style.top=`${t-s.height}px`)})}hide(){this.el.style.display="none",this._visible=!1}}class ci{constructor(e,t){this.bus=e,this.nodeManager=t,this.panel=document.getElementById("property-panel"),this.textInput=document.getElementById("prop-text"),this.idDisplay=document.getElementById("prop-id"),this.posDisplay=document.getElementById("prop-pos"),this.colorPicker=document.getElementById("color-picker"),this.closeBtn=document.getElementById("btn-close-panel"),this._currentNodeId=null,this._bindEvents()}_bindEvents(){var e,t,s,n;this.bus.on("selection:changed",o=>{o.length===1?this.show(o[0]):this.hide()}),this.bus.on("node:moved",o=>{o.id===this._currentNodeId&&(this.posDisplay.textContent=`${Math.round(o.x)}, ${Math.round(o.y)}`)}),(e=this.closeBtn)==null||e.addEventListener("click",()=>{this.hide(),this.nodeManager.deselectAll(),this.bus.emit("selection:changed",[])}),(t=this.textInput)==null||t.addEventListener("input",()=>{const o=this.nodeManager.getNode(this._currentNodeId);o&&(o.text=this.textInput.value,o.el.querySelector(".node-text").textContent=o.text,this.bus.emit("node:updated",o))}),(s=this.textInput)==null||s.addEventListener("change",()=>{this.bus.emit("state:changed")}),(n=this.colorPicker)==null||n.addEventListener("click",o=>{const r=o.target.closest(".color-swatch");if(!r)return;const a=r.dataset.color,c=this.nodeManager.getNode(this._currentNodeId);c&&(c.color=a,c.el.querySelector(".node-color-bar").style.background=a,this._updateActiveColor(a),this.bus.emit("node:updated",c),this.bus.emit("state:changed"))})}show(e){const t=this.nodeManager.getNode(e);t&&(this._currentNodeId=e,this.textInput.value=t.text,this.idDisplay.textContent=t.id.substring(0,12)+"â€¦",this.posDisplay.textContent=`${Math.round(t.x)}, ${Math.round(t.y)}`,this._updateActiveColor(t.color),this.panel.style.display="block")}hide(){this.panel.style.display="none",this._currentNodeId=null}_updateActiveColor(e){this.colorPicker.querySelectorAll(".color-swatch").forEach(t=>{t.classList.toggle("active",t.dataset.color===e)})}}class li{constructor(e,t,s){this.bus=e,this.nodeManager=t,this.viewport=s,this.canvas=document.getElementById("minimap-canvas"),this.ctx=this.canvas.getContext("2d"),this.width=this.canvas.width,this.height=this.canvas.height,this._bindEvents(),requestAnimationFrame(()=>this.render())}_bindEvents(){const e=()=>requestAnimationFrame(()=>this.render());this.bus.on("node:created",e),this.bus.on("node:moved",e),this.bus.on("node:deleted",e),this.bus.on("viewport:changed",e),this.bus.on("state:loaded",e),this.canvas.addEventListener("click",t=>{const s=this.nodeManager.getBounds();if(!s)return;const n=this.canvas.getBoundingClientRect(),o=t.clientX-n.left,r=t.clientY-n.top,a=60,c=s.width+a*2,l=s.height+a*2,p=Math.min(this.width/c,this.height/l),h=(this.width-c*p)/2,g=(this.height-l*p)/2,u=(o-h)/p+s.minX-a,f=(r-g)/p+s.minY-a,m=document.getElementById("canvas-container").getBoundingClientRect();this.viewport.x=-u*this.viewport.zoom+m.width/2,this.viewport.y=-f*this.viewport.zoom+m.height/2,this.viewport._applyTransform(),this.bus.emit("viewport:changed",this.viewport.getState())})}render(){const e=this.ctx,t=this.width,s=this.height;e.fillStyle="#06060f",e.fillRect(0,0,t,s);const n=this.nodeManager.getBounds();if(!n){e.fillStyle="#1a2332",e.font="10px Inter, sans-serif",e.textAlign="center",e.fillText("No nodes",t/2,s/2);return}const o=60,r=n.width+o*2,a=n.height+o*2,c=Math.min(t/r,s/a),l=(t-r*c)/2,p=(s-a*c)/2,h=L=>(L-n.minX+o)*c+l,g=L=>(L-n.minY+o)*c+p;e.strokeStyle="rgba(0, 229, 255, 0.3)",e.lineWidth=1,this.nodeManager.nodes.forEach(L=>{const J=h(L.x),ae=g(L.y),we=Math.max(L.el.offsetWidth*c,4),We=Math.max(L.el.offsetHeight*c,3);e.fillStyle=L.color||"#00e5ff",e.globalAlpha=.8,e.fillRect(J,ae,we,We),e.globalAlpha=1});const u=document.getElementById("canvas-container").getBoundingClientRect(),f=-this.viewport.x/this.viewport.zoom,m=-this.viewport.y/this.viewport.zoom,b=u.width/this.viewport.zoom,E=u.height/this.viewport.zoom,S=h(f),D=g(m),C=b*c,j=E*c;e.strokeStyle="rgba(255, 255, 255, 0.3)",e.lineWidth=1,e.strokeRect(S,D,C,j)}}const Cs="mindmapper_state";class di{constructor(e){this.bus=e,this._saveTimeout=null,this._saveDelay=500,this.bus.on("state:changed",()=>this._scheduleAutoSave())}_scheduleAutoSave(){clearTimeout(this._saveTimeout),this._updateIndicator("saving"),this._saveTimeout=setTimeout(()=>{this.bus.emit("state:save-request")},this._saveDelay)}save(e){try{localStorage.setItem(Cs,JSON.stringify(e)),this._updateIndicator("saved")}catch(t){console.error("Storage save failed:",t),this._updateIndicator("error")}}load(){try{const e=localStorage.getItem(Cs);if(e)return JSON.parse(e)}catch(e){console.error("Storage load failed:",e)}return null}_updateIndicator(e){const t=document.getElementById("save-indicator");if(!t)return;t.className=`save-indicator ${e}`;const s=t.querySelector("span:last-child");s&&(s.textContent=e==="saved"?"Saved":e==="saving"?"Saving...":"Error")}}let fe=0;const _=()=>`pn_${++fe}`,v=()=>`pc_${++fe}`;function hi(){fe=0;const i={core:_(),ui:_(),logic:_(),data:_(),nav:_(),auth:_(),api:_(),push:_(),store:_(),test:_(),analytics:_()};return{id:"ios-app",name:"iOS App",description:"Full iOS app architecture â€” SwiftUI, Auth, APIs, App Store",icon:"ðŸ“±",category:"mobile",data:{nodes:[{id:i.core,text:"iOS App Core",x:350,y:0,color:"#00e5ff",shape:"rounded"},{id:i.ui,text:"UI / SwiftUI",x:50,y:140,color:"#7c4dff",shape:"rectangle"},{id:i.logic,text:"Business Logic",x:350,y:140,color:"#00e5ff",shape:"rectangle"},{id:i.data,text:"Data Layer",x:650,y:140,color:"#ffc107",shape:"parallelogram"},{id:i.nav,text:"Navigation",x:0,y:290,color:"#7c4dff",shape:"diamond"},{id:i.auth,text:"Auth Flow",x:250,y:290,color:"#ff2d78",shape:"diamond"},{id:i.api,text:"REST API",x:500,y:290,color:"#ffc107",shape:"parallelogram"},{id:i.push,text:"Push Notifications",x:720,y:290,color:"#ff6e40",shape:"circle"},{id:i.test,text:"Testing",x:100,y:440,color:"#00ff88",shape:"hexagon"},{id:i.analytics,text:"Analytics",x:400,y:440,color:"#ffc107",shape:"hexagon"},{id:i.store,text:"App Store",x:300,y:580,color:"#00ff88",shape:"pill"}],connections:[{id:v(),sourceId:i.core,sourcePort:"bottom",targetId:i.ui,targetPort:"top",directed:"forward"},{id:v(),sourceId:i.core,sourcePort:"bottom",targetId:i.logic,targetPort:"top",directed:"forward"},{id:v(),sourceId:i.core,sourcePort:"bottom",targetId:i.data,targetPort:"top",directed:"forward"},{id:v(),sourceId:i.ui,sourcePort:"bottom",targetId:i.nav,targetPort:"top",directed:"forward"},{id:v(),sourceId:i.logic,sourcePort:"bottom",targetId:i.auth,targetPort:"top",directed:"both"},{id:v(),sourceId:i.logic,sourcePort:"bottom",targetId:i.api,targetPort:"top",directed:"both"},{id:v(),sourceId:i.data,sourcePort:"bottom",targetId:i.push,targetPort:"top",directed:"forward"},{id:v(),sourceId:i.nav,sourcePort:"bottom",targetId:i.test,targetPort:"top",directed:"forward"},{id:v(),sourceId:i.api,sourcePort:"bottom",targetId:i.analytics,targetPort:"top",directed:"forward"},{id:v(),sourceId:i.test,sourcePort:"bottom",targetId:i.store,targetPort:"left",directed:"forward"},{id:v(),sourceId:i.analytics,sourcePort:"bottom",targetId:i.store,targetPort:"right",directed:"forward"}]}}}function ui(){fe=100;const i={core:_(),ui:_(),logic:_(),data:_(),nav:_(),auth:_(),api:_(),firebase:_(),play:_(),test:_(),permissions:_()};return{id:"android-app",name:"Android App",description:"Android app architecture â€” Jetpack Compose, Firebase, Play Store",icon:"ðŸ¤–",category:"mobile",data:{nodes:[{id:i.core,text:"Android App",x:350,y:0,color:"#00ff88",shape:"rounded"},{id:i.ui,text:"Jetpack Compose",x:50,y:140,color:"#7c4dff",shape:"rectangle"},{id:i.logic,text:"ViewModel / Logic",x:350,y:140,color:"#00e5ff",shape:"rectangle"},{id:i.data,text:"Room Database",x:650,y:140,color:"#ffc107",shape:"parallelogram"},{id:i.nav,text:"Navigation Graph",x:0,y:290,color:"#7c4dff",shape:"diamond"},{id:i.auth,text:"Auth / OAuth",x:250,y:290,color:"#ff2d78",shape:"diamond"},{id:i.api,text:"Retrofit API",x:500,y:290,color:"#ffc107",shape:"parallelogram"},{id:i.firebase,text:"Firebase Services",x:720,y:290,color:"#ff6e40",shape:"circle"},{id:i.permissions,text:"Permissions",x:100,y:440,color:"#ff6e40",shape:"hexagon"},{id:i.test,text:"Espresso Tests",x:400,y:440,color:"#00ff88",shape:"hexagon"},{id:i.play,text:"Play Store",x:300,y:580,color:"#00ff88",shape:"pill"}],connections:[{id:v(),sourceId:i.core,sourcePort:"bottom",targetId:i.ui,targetPort:"top",directed:"forward"},{id:v(),sourceId:i.core,sourcePort:"bottom",targetId:i.logic,targetPort:"top",directed:"forward"},{id:v(),sourceId:i.core,sourcePort:"bottom",targetId:i.data,targetPort:"top",directed:"forward"},{id:v(),sourceId:i.ui,sourcePort:"bottom",targetId:i.nav,targetPort:"top",directed:"forward"},{id:v(),sourceId:i.logic,sourcePort:"bottom",targetId:i.auth,targetPort:"top",directed:"both"},{id:v(),sourceId:i.logic,sourcePort:"bottom",targetId:i.api,targetPort:"top",directed:"both"},{id:v(),sourceId:i.data,sourcePort:"bottom",targetId:i.firebase,targetPort:"top",directed:"both"},{id:v(),sourceId:i.nav,sourcePort:"bottom",targetId:i.permissions,targetPort:"top",directed:"forward"},{id:v(),sourceId:i.api,sourcePort:"bottom",targetId:i.test,targetPort:"top",directed:"forward"},{id:v(),sourceId:i.permissions,sourcePort:"bottom",targetId:i.play,targetPort:"left",directed:"forward"},{id:v(),sourceId:i.test,sourcePort:"bottom",targetId:i.play,targetPort:"right",directed:"forward"}]}}}function pi(){fe=200;const i={app:_(),ui:_(),core:_(),files:_(),config:_(),cli:_(),db:_(),pkg:_(),test:_(),logs:_()};return{id:"local-exe",name:"Local Executable",description:"Desktop application â€” GUI, file I/O, configuration, packaging",icon:"ðŸ–¥ï¸",category:"desktop",data:{nodes:[{id:i.app,text:"Application",x:350,y:0,color:"#00e5ff",shape:"rounded"},{id:i.ui,text:"GUI Framework",x:50,y:150,color:"#7c4dff",shape:"rectangle"},{id:i.core,text:"Core Engine",x:350,y:150,color:"#00e5ff",shape:"rectangle"},{id:i.files,text:"File I/O",x:650,y:150,color:"#ffc107",shape:"parallelogram"},{id:i.config,text:"Configuration",x:0,y:310,color:"#ffc107",shape:"hexagon"},{id:i.cli,text:"CLI Interface",x:220,y:310,color:"#e6edf3",shape:"parallelogram"},{id:i.db,text:"Local Database",x:470,y:310,color:"#ffc107",shape:"parallelogram"},{id:i.logs,text:"Logging",x:700,y:310,color:"#ff6e40",shape:"hexagon"},{id:i.test,text:"Unit / Integration",x:200,y:470,color:"#00ff88",shape:"hexagon"},{id:i.pkg,text:"Installer / Package",x:450,y:470,color:"#00ff88",shape:"pill"}],connections:[{id:v(),sourceId:i.app,sourcePort:"bottom",targetId:i.ui,targetPort:"top",directed:"forward"},{id:v(),sourceId:i.app,sourcePort:"bottom",targetId:i.core,targetPort:"top",directed:"forward"},{id:v(),sourceId:i.app,sourcePort:"bottom",targetId:i.files,targetPort:"top",directed:"forward"},{id:v(),sourceId:i.ui,sourcePort:"bottom",targetId:i.config,targetPort:"top",directed:"forward"},{id:v(),sourceId:i.core,sourcePort:"bottom",targetId:i.cli,targetPort:"top",directed:"both"},{id:v(),sourceId:i.core,sourcePort:"bottom",targetId:i.db,targetPort:"top",directed:"both"},{id:v(),sourceId:i.files,sourcePort:"bottom",targetId:i.logs,targetPort:"top",directed:"forward"},{id:v(),sourceId:i.cli,sourcePort:"bottom",targetId:i.test,targetPort:"top",directed:"forward"},{id:v(),sourceId:i.db,sourcePort:"bottom",targetId:i.pkg,targetPort:"top",directed:"forward"}]}}}function gi(){fe=300;const i={product:_(),frontend:_(),backend:_(),db:_(),auth:_(),billing:_(),hosting:_(),monitor:_(),ci:_(),marketing:_(),onboard:_()};return{id:"saas",name:"SaaS Platform",description:"SaaS architecture â€” Frontend, API, Auth, Billing, DevOps",icon:"â˜ï¸",category:"saas",data:{nodes:[{id:i.product,text:"SaaS Product",x:350,y:0,color:"#7c4dff",shape:"rounded"},{id:i.frontend,text:"Frontend (React)",x:50,y:150,color:"#00e5ff",shape:"rectangle"},{id:i.backend,text:"Backend API",x:350,y:150,color:"#00e5ff",shape:"rectangle"},{id:i.db,text:"Database",x:650,y:150,color:"#ffc107",shape:"parallelogram"},{id:i.auth,text:"Auth & Users",x:50,y:310,color:"#ff2d78",shape:"diamond"},{id:i.billing,text:"Billing / Stripe",x:280,y:310,color:"#ff6e40",shape:"circle"},{id:i.onboard,text:"Onboarding",x:500,y:310,color:"#00ff88",shape:"hexagon"},{id:i.hosting,text:"Hosting / CDN",x:720,y:310,color:"#e6edf3",shape:"hexagon"},{id:i.ci,text:"CI / CD Pipeline",x:100,y:470,color:"#00ff88",shape:"hexagon"},{id:i.monitor,text:"Monitoring",x:380,y:470,color:"#ff6e40",shape:"circle"},{id:i.marketing,text:"Marketing Site",x:600,y:470,color:"#7c4dff",shape:"rounded"}],connections:[{id:v(),sourceId:i.product,sourcePort:"bottom",targetId:i.frontend,targetPort:"top",directed:"forward"},{id:v(),sourceId:i.product,sourcePort:"bottom",targetId:i.backend,targetPort:"top",directed:"forward"},{id:v(),sourceId:i.product,sourcePort:"bottom",targetId:i.db,targetPort:"top",directed:"forward"},{id:v(),sourceId:i.frontend,sourcePort:"bottom",targetId:i.auth,targetPort:"top",directed:"both"},{id:v(),sourceId:i.backend,sourcePort:"bottom",targetId:i.billing,targetPort:"top",directed:"both"},{id:v(),sourceId:i.backend,sourcePort:"bottom",targetId:i.onboard,targetPort:"top",directed:"forward"},{id:v(),sourceId:i.db,sourcePort:"bottom",targetId:i.hosting,targetPort:"top",directed:"forward"},{id:v(),sourceId:i.auth,sourcePort:"bottom",targetId:i.ci,targetPort:"top",directed:"forward"},{id:v(),sourceId:i.billing,sourcePort:"bottom",targetId:i.monitor,targetPort:"top",directed:"forward"},{id:v(),sourceId:i.hosting,sourcePort:"bottom",targetId:i.marketing,targetPort:"top",directed:"forward"},{id:v(),sourceId:i.frontend,sourcePort:"right",targetId:i.backend,targetPort:"left",directed:"both"}]}}}function fi(){fe=400;const i={page:_(),header:_(),hero:_(),features:_(),cta:_(),social:_(),footer:_(),about:_(),contact:_(),pricing:_()};return{id:"wireframe",name:"Website Wireframe",description:"Page layout wireframe â€” Header, Hero, Sections, Footer",icon:"ðŸ“",category:"web",data:{nodes:[{id:i.page,text:"Homepage",x:300,y:0,color:"#00e5ff",shape:"rounded"},{id:i.header,text:"Header / Nav Bar",x:300,y:130,color:"#7c4dff",shape:"rectangle"},{id:i.hero,text:"Hero Section",x:300,y:260,color:"#ff2d78",shape:"rectangle"},{id:i.features,text:"Features Grid",x:100,y:390,color:"#ffc107",shape:"rectangle"},{id:i.cta,text:"CTA Banner",x:500,y:390,color:"#ff2d78",shape:"rectangle"},{id:i.social,text:"Social Proof",x:300,y:520,color:"#e6edf3",shape:"rectangle"},{id:i.footer,text:"Footer",x:300,y:650,color:"#7c4dff",shape:"rectangle"},{id:i.about,text:"About Page",x:680,y:130,color:"#00ff88",shape:"rounded"},{id:i.pricing,text:"Pricing Page",x:680,y:260,color:"#ff6e40",shape:"rounded"},{id:i.contact,text:"Contact Page",x:680,y:390,color:"#ffc107",shape:"rounded"}],connections:[{id:v(),sourceId:i.page,sourcePort:"bottom",targetId:i.header,targetPort:"top",directed:"forward"},{id:v(),sourceId:i.header,sourcePort:"bottom",targetId:i.hero,targetPort:"top",directed:"forward"},{id:v(),sourceId:i.hero,sourcePort:"bottom",targetId:i.features,targetPort:"top",directed:"forward"},{id:v(),sourceId:i.hero,sourcePort:"bottom",targetId:i.cta,targetPort:"top",directed:"forward"},{id:v(),sourceId:i.features,sourcePort:"bottom",targetId:i.social,targetPort:"left",directed:"forward"},{id:v(),sourceId:i.cta,sourcePort:"bottom",targetId:i.social,targetPort:"right",directed:"forward"},{id:v(),sourceId:i.social,sourcePort:"bottom",targetId:i.footer,targetPort:"top",directed:"forward"},{id:v(),sourceId:i.header,sourcePort:"right",targetId:i.about,targetPort:"left",directed:"forward"},{id:v(),sourceId:i.about,sourcePort:"bottom",targetId:i.pricing,targetPort:"top",directed:"none"},{id:v(),sourceId:i.pricing,sourcePort:"bottom",targetId:i.contact,targetPort:"top",directed:"none"}]}}}function mi(){fe=500;const i={home:_(),about:_(),products:_(),blog:_(),contact:_(),login:_(),dashboard:_(),detail:_(),post:_(),error:_(),terms:_()};return{id:"sitemap",name:"Website Map",description:"Full sitemap structure â€” pages, hierarchy, user flows",icon:"ðŸ—ºï¸",category:"web",data:{nodes:[{id:i.home,text:"Home",x:350,y:0,color:"#00e5ff",shape:"rounded"},{id:i.about,text:"About",x:0,y:150,color:"#7c4dff",shape:"rectangle"},{id:i.products,text:"Products",x:200,y:150,color:"#ffc107",shape:"rectangle"},{id:i.blog,text:"Blog",x:420,y:150,color:"#00ff88",shape:"rectangle"},{id:i.contact,text:"Contact",x:630,y:150,color:"#e6edf3",shape:"rectangle"},{id:i.login,text:"Login / Register",x:830,y:150,color:"#ff2d78",shape:"diamond"},{id:i.detail,text:"Product Detail",x:140,y:310,color:"#ffc107",shape:"rectangle"},{id:i.post,text:"Blog Post",x:380,y:310,color:"#00ff88",shape:"rectangle"},{id:i.dashboard,text:"User Dashboard",x:750,y:310,color:"#7c4dff",shape:"hexagon"},{id:i.error,text:"404 Not Found",x:550,y:310,color:"#ff6e40",shape:"circle"},{id:i.terms,text:"Terms & Privacy",x:0,y:310,color:"#e6edf3",shape:"pill"}],connections:[{id:v(),sourceId:i.home,sourcePort:"bottom",targetId:i.about,targetPort:"top",directed:"forward"},{id:v(),sourceId:i.home,sourcePort:"bottom",targetId:i.products,targetPort:"top",directed:"forward"},{id:v(),sourceId:i.home,sourcePort:"bottom",targetId:i.blog,targetPort:"top",directed:"forward"},{id:v(),sourceId:i.home,sourcePort:"bottom",targetId:i.contact,targetPort:"top",directed:"forward"},{id:v(),sourceId:i.home,sourcePort:"bottom",targetId:i.login,targetPort:"top",directed:"forward"},{id:v(),sourceId:i.products,sourcePort:"bottom",targetId:i.detail,targetPort:"top",directed:"forward"},{id:v(),sourceId:i.blog,sourcePort:"bottom",targetId:i.post,targetPort:"top",directed:"forward"},{id:v(),sourceId:i.login,sourcePort:"bottom",targetId:i.dashboard,targetPort:"top",directed:"forward"},{id:v(),sourceId:i.contact,sourcePort:"bottom",targetId:i.error,targetPort:"top",directed:"none"},{id:v(),sourceId:i.about,sourcePort:"bottom",targetId:i.terms,targetPort:"top",directed:"forward"}]}}}const yi=[hi(),ui(),pi(),gi(),fi(),mi()],Ms="mindmapper_custom_presets";class bi{constructor(){this.builtins=yi,this._customCache=null}getBuiltins(){return this.builtins}getCustom(){return this._customCache||(this._customCache=this._loadCustom()),this._customCache}getAll(){return[...this.builtins,...this.getCustom()]}getById(e){return this.getAll().find(t=>t.id===e)||null}saveCustom(e,t,s,n){const o=this.getCustom(),r={id:`custom_${Date.now()}`,name:e,description:t||"Custom preset",icon:s||"ðŸ“Œ",category:"custom",data:JSON.parse(JSON.stringify(n)),createdAt:new Date().toISOString()};return o.push(r),this._saveCustom(o),this._customCache=o,r}deleteCustom(e){let t=this.getCustom();t=t.filter(s=>s.id!==e),this._saveCustom(t),this._customCache=t}renameCustom(e,t){const s=this.getCustom(),n=s.find(o=>o.id===e);n&&(n.name=t,this._saveCustom(s))}_loadCustom(){try{const e=localStorage.getItem(Ms);return e?JSON.parse(e):[]}catch{return[]}}_saveCustom(e){try{localStorage.setItem(Ms,JSON.stringify(e))}catch(t){console.warn("Failed to save custom presets:",t)}}}class _i{constructor(e,t,s){this.presetManager=e,this.onSelect=t,this.getState=s,this.overlay=document.getElementById("preset-modal-overlay"),this.modal=document.getElementById("preset-modal"),this.closeBtn=document.getElementById("preset-modal-close"),this.grid=document.getElementById("preset-grid"),this.saveBtn=document.getElementById("preset-save-current"),this.categoryFilter=document.getElementById("preset-category-filter"),this._activeCategory="all",this._bind()}show(){this._render(),this.overlay.classList.add("visible"),this.modal.classList.add("visible"),setTimeout(()=>this.closeBtn.focus(),100)}hide(){this.overlay.classList.remove("visible"),this.modal.classList.remove("visible")}_bind(){this.closeBtn.addEventListener("click",()=>this.hide()),this.overlay.addEventListener("click",e=>{e.target===this.overlay&&this.hide()}),window.addEventListener("keydown",e=>{e.key==="Escape"&&this.overlay.classList.contains("visible")&&(e.stopPropagation(),this.hide())}),this.categoryFilter.addEventListener("click",e=>{const t=e.target.closest("[data-category]");t&&(this._activeCategory=t.dataset.category,this._render())}),this.saveBtn.addEventListener("click",()=>this._saveCurrentAsPreset())}_render(){this.categoryFilter.querySelectorAll("[data-category]").forEach(s=>{s.classList.toggle("active",s.dataset.category===this._activeCategory)});const e=this.presetManager.getAll(),t=this._activeCategory==="all"?e:e.filter(s=>s.category===this._activeCategory);if(this.grid.innerHTML="",t.length===0){this.grid.innerHTML=`
        <div class="preset-empty">
          <span class="preset-empty-icon">ðŸ“‚</span>
          <p>No presets in this category</p>
        </div>`;return}t.forEach(s=>{var c,l;const n=document.createElement("div");n.className="preset-card",n.dataset.presetId=s.id;const o=((c=s.data.nodes)==null?void 0:c.length)||0,r=((l=s.data.connections)==null?void 0:l.length)||0,a=s.category==="custom";n.innerHTML=`
        <div class="preset-card-header">
          <span class="preset-card-icon">${s.icon}</span>
          ${a?'<button class="preset-card-delete" title="Delete preset">âœ•</button>':""}
        </div>
        <div class="preset-card-body">
          <h3 class="preset-card-name">${s.name}</h3>
          <p class="preset-card-desc">${s.description}</p>
          <div class="preset-card-meta">
            <span>${o} nodes</span>
            <span>Â·</span>
            <span>${r} wires</span>
          </div>
        </div>
        <div class="preset-card-preview">
          ${this._renderMiniPreview(s.data)}
        </div>
      `,n.addEventListener("click",p=>{p.target.closest(".preset-card-delete")||this._confirmAndLoad(s)}),a&&n.querySelector(".preset-card-delete").addEventListener("click",p=>{p.stopPropagation(),this._deleteCustom(s.id)}),this.grid.appendChild(n)})}_renderMiniPreview(e){if(!e.nodes||e.nodes.length===0)return"";const t=e.nodes;let s=1/0,n=1/0,o=-1/0,r=-1/0;t.forEach(E=>{s=Math.min(s,E.x),n=Math.min(n,E.y),o=Math.max(o,E.x+120),r=Math.max(r,E.y+32)});const a=o-s||1,c=r-n||1,l=8,p=200,h=60,g=(p-l*2)/a,u=(h-l*2)/c,f=Math.min(g,u,1);let m="";t.forEach(E=>{const S=l+(E.x-s+60)*f,D=l+(E.y-n+16)*f;m+=`<circle cx="${S.toFixed(1)}" cy="${D.toFixed(1)}" r="3" fill="${E.color||"#00e5ff"}" opacity="0.8"/>`});let b="";if(e.connections){const E=new Map(t.map(S=>[S.id,S]));e.connections.forEach(S=>{const D=E.get(S.sourceId),C=E.get(S.targetId);if(!D||!C)return;const j=l+(D.x-s+60)*f,L=l+(D.y-n+16)*f,J=l+(C.x-s+60)*f,ae=l+(C.y-n+16)*f;b+=`<line x1="${j.toFixed(1)}" y1="${L.toFixed(1)}" x2="${J.toFixed(1)}" y2="${ae.toFixed(1)}" stroke="#00e5ff" stroke-width="0.7" opacity="0.3"/>`})}return`<svg width="${p}" height="${h}" viewBox="0 0 ${p} ${h}" class="preset-preview-svg">${b}${m}</svg>`}_confirmAndLoad(e){const t=this.getState();if(t.nodes&&t.nodes.length>0&&!confirm(`Load "${e.name}"?

This will replace your current canvas.`))return;this.hide();const n=JSON.parse(JSON.stringify(e.data));this.onSelect(n)}_saveCurrentAsPreset(){const e=this.getState();if(!e.nodes||e.nodes.length===0){alert("Canvas is empty â€” add some nodes first.");return}const t=prompt("Preset name:");if(!t||!t.trim())return;const s=prompt("Short description (optional):")||"",n=["ðŸ“Œ","â­","ðŸ’¡","ðŸ”·","ðŸŽ¯","ðŸ·ï¸","ðŸ“‹","ðŸš€"],o=n[Math.floor(Math.random()*n.length)];this.presetManager.saveCustom(t.trim(),s.trim(),o,{nodes:e.nodes,connections:e.connections}),this._activeCategory="custom",this._render()}_deleteCustom(e){confirm("Delete this custom preset?")&&(this.presetManager.deleteCustom(e),this._render())}}const Ps=[{color:"#00e5ff",shape:"rounded"},{color:"#7c4dff",shape:"rectangle"},{color:"#ffc107",shape:"rectangle"},{color:"#00ff88",shape:"rectangle"},{color:"#ff6e40",shape:"rectangle"},{color:"#e6edf3",shape:"rectangle"}];function vi(i){return Ps[Math.min(i,Ps.length-1)]}const xi=150,wi=140,Js=40;async function ki(i){switch(i.name.split(".").pop().toLowerCase()){case"md":return Ei(await i.text());case"txt":return Ot(await i.text());case"png":case"jpg":case"jpeg":case"gif":case"webp":return Si(i);case"doc":case"docx":return Ti(i);default:return Ot(await i.text())}}function Ei(i){var n;const e=i.split(/\r?\n/),t={text:"Document",depth:0,children:[]},s=[t];for(const o of e){const r=o.trimEnd();if(!r)continue;const a=r.match(/^(#{1,6})\s+(.+)/);if(a){const p=a[1].length,h={text:a[2].trim(),depth:p,children:[]};for(;s.length>1&&s[s.length-1].depth>=p;)s.pop();s[s.length-1].children.push(h),s.push(h);continue}const c=r.match(/^(\s*)([-*]|\d+\.)\s+(.+)/);if(c){const p=c[1].length,h=(((n=s[s.length-1])==null?void 0:n.depth)||0)+1+Math.floor(p/2),g={text:c[3].trim(),depth:h,children:[]};for(;s.length>1&&s[s.length-1].depth>=h;)s.pop();s[s.length-1].children.push(g),s.push(g);continue}const l=r.trim();if(l&&s.length>1){const p=s[s.length-1];p.text.length<80&&(p.text+=" "+l)}else l&&t.children.push({text:l,depth:1,children:[]})}if(t.children.length===1&&t.text==="Document"){const o=t.children[0];return o.depth=0,Dt(o)}return Dt(t)}function Ot(i){const e=i.split(/\r?\n/).filter(n=>n.trim());if(e.length===0)return{nodes:[{id:"n_1",text:"Empty Document",x:400,y:0,color:"#00e5ff",shape:"rounded"}],connections:[]};const t={text:e[0].trim(),depth:0,children:[]},s=[t];for(let n=1;n<e.length;n++){const o=e[n],r=o.match(/^(\s*)/)[1].length,a=Math.floor(r/2)+1,c={text:o.trim(),depth:a,children:[]};for(;s.length>1&&s[s.length-1].depth>=a;)s.pop();s[s.length-1].children.push(c),s.push(c)}return Dt(t)}async function Si(i){return{nodes:[{id:"n_img_root",text:i.name.replace(/\.[^.]+$/,""),x:350,y:0,color:"#7c4dff",shape:"rounded"},{id:"n_img_type",text:`Type: ${i.type}`,x:100,y:150,color:"#ffc107",shape:"parallelogram"},{id:"n_img_size",text:`Size: ${Ai(i.size)}`,x:350,y:150,color:"#ffc107",shape:"parallelogram"},{id:"n_img_ref",text:"ðŸ“¸ Image Reference",x:600,y:150,color:"#ff6e40",shape:"circle"},{id:"n_img_note",text:"Add analysis notes here",x:350,y:300,color:"#e6edf3",shape:"rectangle"}],connections:[{id:"c_img_1",sourceId:"n_img_root",sourcePort:"bottom",targetId:"n_img_type",targetPort:"top",directed:"forward"},{id:"c_img_2",sourceId:"n_img_root",sourcePort:"bottom",targetId:"n_img_size",targetPort:"top",directed:"forward"},{id:"c_img_3",sourceId:"n_img_root",sourcePort:"bottom",targetId:"n_img_ref",targetPort:"top",directed:"forward"},{id:"c_img_4",sourceId:"n_img_size",sourcePort:"bottom",targetId:"n_img_note",targetPort:"top",directed:"forward"}]}}async function Ti(i){try{const s=(await i.text()).replace(/[^\x20-\x7E\n\r\t]/g,"").trim();if(s.length>20)return Ot(s)}catch{}return{nodes:[{id:"n_doc_root",text:i.name.replace(/\.[^.]+$/,""),x:350,y:0,color:"#00e5ff",shape:"rounded"},{id:"n_doc_note",text:"Export as .txt or .md for full import",x:350,y:150,color:"#ffc107",shape:"rectangle"}],connections:[{id:"c_doc_1",sourceId:"n_doc_root",sourcePort:"bottom",targetId:"n_doc_note",targetPort:"top",directed:"forward"}]}}let Ht=0;function Dt(i){Ht=0;const e=[],t=[];return Ks(i),Zs(i),Qs(i,400,0),en(i,e,t),{nodes:e,connections:t}}function Ks(i){var e;i.id=`n_import_${++Ht}`,(e=i.children)==null||e.forEach(Ks)}function Zs(i){return!i.children||i.children.length===0?(i._width=wi,i._width):(i._width=i.children.reduce((e,t)=>e+Zs(t),0)+(i.children.length-1)*Js,i._width)}function Qs(i,e,t){if(i.x=e-60,i.y=t,!i.children||i.children.length===0)return;let s=e-i._width/2;for(const n of i.children){const o=s+n._width/2;Qs(n,o,t+xi),s+=n._width+Js}}function en(i,e,t){const s=vi(i.depth);if(e.push({id:i.id,text:i.text,x:Math.round(i.x),y:Math.round(i.y),color:s.color,shape:s.shape}),i.children)for(const n of i.children)t.push({id:`c_import_${++Ht}`,sourceId:i.id,sourcePort:"bottom",targetId:n.id,targetPort:"top",directed:"forward"}),en(n,e,t)}function Ai(i){return i<1024?i+" B":i<1024*1024?(i/1024).toFixed(1)+" KB":(i/(1024*1024)).toFixed(1)+" MB"}const Mt=".mindmap",Ls="application/json";class Ii{constructor(e){this.getState=e.getState,this.loadState=e.loadState,this.clearState=e.clearState,this.fitToContent=e.fitToContent,this.getNodeManager=e.getNodeManager,this.getConnectionManager=e.getConnectionManager,this.currentFileName="Untitled",this._titleEl=document.getElementById("project-title"),this._updateTitle(),this._openInput=this._createInput(Mt,".json"),this._importInput=this._createInput(".md,.txt,.png,.jpg,.jpeg,.gif,.webp,.doc,.docx")}newProject(){this._confirmDiscard()&&(this.clearState(),this.currentFileName="Untitled",this._updateTitle())}openFile(){this._openInput.click()}save(){this._downloadState(this.currentFileName)}saveAs(){const e=prompt("Save as:",this.currentFileName);if(!e||!e.trim())return;const t=e.trim().replace(/\.mindmap$/i,"");this.currentFileName=t,this._updateTitle(),this._downloadState(t)}exportJSON(){const e=this.getState(),t={version:"1.1",name:this.currentFileName,exportedAt:new Date().toISOString(),...e},s=new Blob([JSON.stringify(t,null,2)],{type:Ls});this._downloadBlob(s,`${this.currentFileName}.json`)}exportPNG(){const e=this.getNodeManager(),t=this.getConnectionManager(),s=e.getBounds();if(!s){alert("Canvas is empty.");return}const n=60,o=s.width+n*2,r=s.height+n*2,a=s.minX-n,c=s.minY-n,l=document.createElement("canvas"),p=window.devicePixelRatio||1;l.width=o*p,l.height=r*p;const h=l.getContext("2d");h.scale(p,p),h.fillStyle="#06060f",h.fillRect(0,0,o,r),h.strokeStyle="#00e5ff",h.lineWidth=2,h.lineCap="round",h.lineJoin="round",t.connections.forEach(g=>{var f;const u=((f=g.pathEl)==null?void 0:f.getAttribute("d"))||g._basePathD;if(u)try{const m=new Path2D(this._translatePath(u,-a,-c));h.stroke(m)}catch{}}),e.nodes.forEach(g=>{const u=g.x-a,f=g.y-c,m=g.el,b=m.offsetWidth||140,E=m.offsetHeight||40;h.fillStyle="#0d1117",h.strokeStyle="rgba(255,255,255,0.08)",h.lineWidth=1,this._drawRoundedRect(h,u,f,b,E,8),h.fill(),h.stroke(),h.fillStyle=g.color||"#00e5ff",this._drawRoundedRect(h,u,f,b,3,8,!0),h.fill(),h.fillStyle="#e6edf3",h.font="13px Inter, sans-serif",h.textBaseline="middle",h.textAlign="center";const S=g.text||"",D=b-20,C=h.measureText(S).width>D?S.slice(0,Math.floor(S.length*D/h.measureText(S).width))+"â€¦":S;h.fillText(C,u+b/2,f+E/2)}),l.toBlob(g=>{g&&this._downloadBlob(g,`${this.currentFileName}.png`)},"image/png")}exportSVG(){const e=this.getNodeManager(),t=this.getConnectionManager(),s=e.getBounds();if(!s){alert("Canvas is empty.");return}const n=60,o=s.width+n*2,r=s.height+n*2,a=s.minX-n,c=s.minY-n;let l=`<svg xmlns="http://www.w3.org/2000/svg" width="${o}" height="${r}" viewBox="0 0 ${o} ${r}">
`;l+=`  <rect width="${o}" height="${r}" fill="#06060f"/>
`,t.connections.forEach(h=>{var f;const g=((f=h.pathEl)==null?void 0:f.getAttribute("d"))||h._basePathD;if(!g)return;const u=this._translatePath(g,-a,-c);l+=`  <path d="${u}" fill="none" stroke="#00e5ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
`}),e.nodes.forEach(h=>{const g=h.x-a,u=h.y-c,f=h.el.offsetWidth||140,m=h.el.offsetHeight||40;l+=`  <rect x="${g}" y="${u}" width="${f}" height="${m}" rx="8" fill="#0d1117" stroke="rgba(255,255,255,0.08)"/>
`,l+=`  <rect x="${g}" y="${u}" width="${f}" height="3" rx="1.5" fill="${h.color||"#00e5ff"}"/>
`;const b=(h.text||"").replace(/&/g,"&amp;").replace(/</g,"&lt;");l+=`  <text x="${g+f/2}" y="${u+m/2+4}" text-anchor="middle" fill="#e6edf3" font-family="Inter, sans-serif" font-size="13">${b}</text>
`}),l+="</svg>";const p=new Blob([l],{type:"image/svg+xml"});this._downloadBlob(p,`${this.currentFileName}.svg`)}importReference(){this._importInput.click()}async _handleImport(e){var t;try{const s=await ki(e);if(!s||!s.nodes||s.nodes.length===0){alert("Could not extract structure from this file.");return}if(((t=this.getState().nodes)==null?void 0:t.length)>0&&!confirm(`Import "${e.name}"?

This will replace your current canvas.`))return;this.currentFileName=e.name.replace(/\.[^.]+$/,""),this._updateTitle(),this.loadState(s)}catch(s){console.error("Import error:",s),alert(`Failed to import file: ${s.message}`)}}_confirmDiscard(){const e=this.getState();return e.nodes&&e.nodes.length>0?confirm("Discard current canvas? Unsaved changes will be lost."):!0}_downloadState(e){const t=this.getState(),s={version:"1.1",name:e,...t},n=new Blob([JSON.stringify(s)],{type:Ls});this._downloadBlob(n,`${e}${Mt}`)}_downloadBlob(e,t){const s=URL.createObjectURL(e),n=document.createElement("a");n.href=s,n.download=t,document.body.appendChild(n),n.click(),setTimeout(()=>{document.body.removeChild(n),URL.revokeObjectURL(s)},100)}_createInput(...e){const t=document.createElement("input");return t.type="file",t.accept=e.join(","),t.style.display="none",document.body.appendChild(t),t.addEventListener("change",()=>{var n;const s=(n=t.files)==null?void 0:n[0];s&&(t.value="",e.includes(Mt)||e.includes(".json")?this._handleOpen(s):this._handleImport(s))}),t}async _handleOpen(e){var t;try{const s=await e.text(),n=JSON.parse(s);if(!n.nodes||!Array.isArray(n.nodes)){alert("Invalid MindMapper file â€” missing nodes array.");return}if(((t=this.getState().nodes)==null?void 0:t.length)>0&&!confirm(`Open "${e.name}"?

This will replace your current canvas.`))return;this.currentFileName=n.name||e.name.replace(/\.[^.]+$/,""),this._updateTitle(),this.loadState({nodes:n.nodes,connections:n.connections||[]})}catch(s){console.error("Open error:",s),alert(`Failed to open file: ${s.message}`)}}_updateTitle(){this._titleEl&&(this._titleEl.textContent=this.currentFileName,this._titleEl.title=this.currentFileName)}_translatePath(e,t,s){const n=e.match(/[a-zA-Z]|[-+]?[\d.]+(?:e[-+]?\d+)?/g);if(!n)return e;let o="",r=0,a="";for(;r<n.length;){if(/[a-zA-Z]/.test(n[r])){a=n[r],o+=a,r++;continue}a===a.toUpperCase()&&/[MLHVCSQTA]/.test(a)?a==="H"?(o+=" "+(parseFloat(n[r])+t).toFixed(1),r++):a==="V"?(o+=" "+(parseFloat(n[r])+s).toFixed(1),r++):a==="A"&&r+6<n.length?(o+=` ${n[r]} ${n[r+1]} ${n[r+2]} ${n[r+3]} ${n[r+4]}`,o+=` ${(parseFloat(n[r+5])+t).toFixed(1)} ${(parseFloat(n[r+6])+s).toFixed(1)}`,r+=7):r+1<n.length?(o+=` ${(parseFloat(n[r])+t).toFixed(1)} ${(parseFloat(n[r+1])+s).toFixed(1)}`,r+=2):(o+=" "+n[r],r++):(o+=" "+n[r],r++)}return o}_drawRoundedRect(e,t,s,n,o,r,a=!1){e.beginPath(),a?(e.moveTo(t+r,s),e.lineTo(t+n-r,s),e.arcTo(t+n,s,t+n,s+r,r),e.lineTo(t+n,s+o),e.lineTo(t,s+o),e.lineTo(t,s+r),e.arcTo(t,s,t+r,s,r)):(e.moveTo(t+r,s),e.lineTo(t+n-r,s),e.arcTo(t+n,s,t+n,s+r,r),e.lineTo(t+n,s+o-r),e.arcTo(t+n,s+o,t+n-r,s+o,r),e.lineTo(t+r,s+o),e.arcTo(t,s+o,t,s+o-r,r),e.lineTo(t,s+r),e.arcTo(t,s,t+r,s,r)),e.closePath()}}class Ci{constructor(e){this.fm=e,this.isOpen=!1,this.btn=document.getElementById("btn-file-menu"),this.menu=document.getElementById("file-menu-dropdown"),this._buildMenu(),this._bind()}toggle(){this.isOpen?this.hide():this.show()}show(){this.menu.classList.add("open"),this.btn.classList.add("active"),this.isOpen=!0}hide(){this.menu.classList.remove("open"),this.btn.classList.remove("active"),this.isOpen=!1}_buildMenu(){const e=[{label:"New Project",shortcut:"Ctrl+N",icon:"ðŸ“„",action:()=>this.fm.newProject()},{type:"divider"},{label:"Open Fileâ€¦",shortcut:"Ctrl+O",icon:"ðŸ“‚",action:()=>this.fm.openFile()},{type:"divider"},{label:"Save",shortcut:"Ctrl+S",icon:"ðŸ’¾",action:()=>this.fm.save()},{label:"Save Asâ€¦",shortcut:"Ctrl+Shift+S",icon:"ðŸ“¥",action:()=>this.fm.saveAs()},{type:"divider"},{label:"Export",type:"header"},{label:"Export as PNG",shortcut:"",icon:"ðŸ–¼ï¸",action:()=>this.fm.exportPNG()},{label:"Export as JSON",shortcut:"",icon:"{ }",action:()=>this.fm.exportJSON()},{label:"Export as SVG",shortcut:"",icon:"â—‡",action:()=>this.fm.exportSVG()},{type:"divider"},{label:"Import Referenceâ€¦",shortcut:"",icon:"ðŸ“Ž",action:()=>this.fm.importReference()}];this.menu.innerHTML="",e.forEach(t=>{if(t.type==="divider"){const n=document.createElement("div");n.className="file-menu-divider",this.menu.appendChild(n);return}if(t.type==="header"){const n=document.createElement("div");n.className="file-menu-header",n.textContent=t.label,this.menu.appendChild(n);return}const s=document.createElement("div");s.className="file-menu-item",s.innerHTML=`
        <span class="file-menu-icon">${t.icon}</span>
        <span class="file-menu-label">${t.label}</span>
        ${t.shortcut?`<span class="file-menu-shortcut">${t.shortcut}</span>`:""}
      `,s.addEventListener("click",()=>{this.hide(),t.action()}),this.menu.appendChild(s)})}_bind(){this.btn.addEventListener("click",e=>{e.stopPropagation(),this.toggle()}),document.addEventListener("click",e=>{this.isOpen&&!this.menu.contains(e.target)&&!this.btn.contains(e.target)&&this.hide()}),document.addEventListener("keydown",e=>{e.key==="Escape"&&this.isOpen&&this.hide()}),window.addEventListener("keydown",e=>{var t,s,n;(t=document.activeElement)!=null&&t.isContentEditable||((s=document.activeElement)==null?void 0:s.tagName)==="TEXTAREA"||((n=document.activeElement)==null?void 0:n.tagName)==="INPUT"||(e.ctrlKey&&!e.shiftKey&&e.key==="n"&&(e.preventDefault(),this.fm.newProject()),e.ctrlKey&&!e.shiftKey&&e.key==="o"&&(e.preventDefault(),this.fm.openFile()),e.ctrlKey&&e.shiftKey&&e.key==="S"&&(e.preventDefault(),this.fm.saveAs()))})}}function Gt(){return{async:!1,breaks:!1,extensions:null,gfm:!0,hooks:null,pedantic:!1,renderer:null,silent:!1,tokenizer:null,walkTokens:null}}var xe=Gt();function tn(i){xe=i}var He={exec:()=>null};function I(i,e=""){let t=typeof i=="string"?i:i.source,s={replace:(n,o)=>{let r=typeof o=="string"?o:o.source;return r=r.replace(Y.caret,"$1"),t=t.replace(n,r),s},getRegex:()=>new RegExp(t,e)};return s}var Mi=(()=>{try{return!!new RegExp("(?<=1)(?<!1)")}catch{return!1}})(),Y={codeRemoveIndent:/^(?: {1,4}| {0,3}\t)/gm,outputLinkReplace:/\\([\[\]])/g,indentCodeCompensation:/^(\s+)(?:```)/,beginningSpace:/^\s+/,endingHash:/#$/,startingSpaceChar:/^ /,endingSpaceChar:/ $/,nonSpaceChar:/[^ ]/,newLineCharGlobal:/\n/g,tabCharGlobal:/\t/g,multipleSpaceGlobal:/\s+/g,blankLine:/^[ \t]*$/,doubleBlankLine:/\n[ \t]*\n[ \t]*$/,blockquoteStart:/^ {0,3}>/,blockquoteSetextReplace:/\n {0,3}((?:=+|-+) *)(?=\n|$)/g,blockquoteSetextReplace2:/^ {0,3}>[ \t]?/gm,listReplaceTabs:/^\t+/,listReplaceNesting:/^ {1,4}(?=( {4})*[^ ])/g,listIsTask:/^\[[ xX]\] +\S/,listReplaceTask:/^\[[ xX]\] +/,listTaskCheckbox:/\[[ xX]\]/,anyLine:/\n.*\n/,hrefBrackets:/^<(.*)>$/,tableDelimiter:/[:|]/,tableAlignChars:/^\||\| *$/g,tableRowBlankLine:/\n[ \t]*$/,tableAlignRight:/^ *-+: *$/,tableAlignCenter:/^ *:-+: *$/,tableAlignLeft:/^ *:-+ *$/,startATag:/^<a /i,endATag:/^<\/a>/i,startPreScriptTag:/^<(pre|code|kbd|script)(\s|>)/i,endPreScriptTag:/^<\/(pre|code|kbd|script)(\s|>)/i,startAngleBracket:/^</,endAngleBracket:/>$/,pedanticHrefTitle:/^([^'"]*[^\s])\s+(['"])(.*)\2/,unicodeAlphaNumeric:/[\p{L}\p{N}]/u,escapeTest:/[&<>"']/,escapeReplace:/[&<>"']/g,escapeTestNoEncode:/[<>"']|&(?!(#\d{1,7}|#[Xx][a-fA-F0-9]{1,6}|\w+);)/,escapeReplaceNoEncode:/[<>"']|&(?!(#\d{1,7}|#[Xx][a-fA-F0-9]{1,6}|\w+);)/g,unescapeTest:/&(#(?:\d+)|(?:#x[0-9A-Fa-f]+)|(?:\w+));?/ig,caret:/(^|[^\[])\^/g,percentDecode:/%25/g,findPipe:/\|/g,splitPipe:/ \|/,slashPipe:/\\\|/g,carriageReturn:/\r\n|\r/g,spaceLine:/^ +$/gm,notSpaceStart:/^\S*/,endingNewline:/\n$/,listItemRegex:i=>new RegExp(`^( {0,3}${i})((?:[	 ][^\\n]*)?(?:\\n|$))`),nextBulletRegex:i=>new RegExp(`^ {0,${Math.min(3,i-1)}}(?:[*+-]|\\d{1,9}[.)])((?:[ 	][^\\n]*)?(?:\\n|$))`),hrRegex:i=>new RegExp(`^ {0,${Math.min(3,i-1)}}((?:- *){3,}|(?:_ *){3,}|(?:\\* *){3,})(?:\\n+|$)`),fencesBeginRegex:i=>new RegExp(`^ {0,${Math.min(3,i-1)}}(?:\`\`\`|~~~)`),headingBeginRegex:i=>new RegExp(`^ {0,${Math.min(3,i-1)}}#`),htmlBeginRegex:i=>new RegExp(`^ {0,${Math.min(3,i-1)}}<(?:[a-z].*>|!--)`,"i")},Pi=/^(?:[ \t]*(?:\n|$))+/,Li=/^((?: {4}| {0,3}\t)[^\n]+(?:\n(?:[ \t]*(?:\n|$))*)?)+/,Ni=/^ {0,3}(`{3,}(?=[^`\n]*(?:\n|$))|~{3,})([^\n]*)(?:\n|$)(?:|([\s\S]*?)(?:\n|$))(?: {0,3}\1[~`]* *(?=\n|$)|$)/,Ge=/^ {0,3}((?:-[\t ]*){3,}|(?:_[ \t]*){3,}|(?:\*[ \t]*){3,})(?:\n+|$)/,$i=/^ {0,3}(#{1,6})(?=\s|$)(.*)(?:\n+|$)/,Wt=/(?:[*+-]|\d{1,9}[.)])/,sn=/^(?!bull |blockCode|fences|blockquote|heading|html|table)((?:.|\n(?!\s*?\n|bull |blockCode|fences|blockquote|heading|html|table))+?)\n {0,3}(=+|-+) *(?:\n+|$)/,nn=I(sn).replace(/bull/g,Wt).replace(/blockCode/g,/(?: {4}| {0,3}\t)/).replace(/fences/g,/ {0,3}(?:`{3,}|~{3,})/).replace(/blockquote/g,/ {0,3}>/).replace(/heading/g,/ {0,3}#{1,6}/).replace(/html/g,/ {0,3}<[^\n>]+>\n/).replace(/\|table/g,"").getRegex(),Ri=I(sn).replace(/bull/g,Wt).replace(/blockCode/g,/(?: {4}| {0,3}\t)/).replace(/fences/g,/ {0,3}(?:`{3,}|~{3,})/).replace(/blockquote/g,/ {0,3}>/).replace(/heading/g,/ {0,3}#{1,6}/).replace(/html/g,/ {0,3}<[^\n>]+>\n/).replace(/table/g,/ {0,3}\|?(?:[:\- ]*\|)+[\:\- ]*\n/).getRegex(),Yt=/^([^\n]+(?:\n(?!hr|heading|lheading|blockquote|fences|list|html|table| +\n)[^\n]+)*)/,Oi=/^[^\n]+/,Xt=/(?!\s*\])(?:\\[\s\S]|[^\[\]\\])+/,Di=I(/^ {0,3}\[(label)\]: *(?:\n[ \t]*)?([^<\s][^\s]*|<.*?>)(?:(?: +(?:\n[ \t]*)?| *\n[ \t]*)(title))? *(?:\n+|$)/).replace("label",Xt).replace("title",/(?:"(?:\\"?|[^"\\])*"|'[^'\n]*(?:\n[^'\n]+)*\n?'|\([^()]*\))/).getRegex(),zi=I(/^( {0,3}bull)([ \t][^\n]+?)?(?:\n|$)/).replace(/bull/g,Wt).getRegex(),dt="address|article|aside|base|basefont|blockquote|body|caption|center|col|colgroup|dd|details|dialog|dir|div|dl|dt|fieldset|figcaption|figure|footer|form|frame|frameset|h[1-6]|head|header|hr|html|iframe|legend|li|link|main|menu|menuitem|meta|nav|noframes|ol|optgroup|option|p|param|search|section|summary|table|tbody|td|tfoot|th|thead|title|tr|track|ul",Vt=/<!--(?:-?>|[\s\S]*?(?:-->|$))/,Fi=I("^ {0,3}(?:<(script|pre|style|textarea)[\\s>][\\s\\S]*?(?:</\\1>[^\\n]*\\n+|$)|comment[^\\n]*(\\n+|$)|<\\?[\\s\\S]*?(?:\\?>\\n*|$)|<![A-Z][\\s\\S]*?(?:>\\n*|$)|<!\\[CDATA\\[[\\s\\S]*?(?:\\]\\]>\\n*|$)|</?(tag)(?: +|\\n|/?>)[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$)|<(?!script|pre|style|textarea)([a-z][\\w-]*)(?:attribute)*? */?>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$)|</(?!script|pre|style|textarea)[a-z][\\w-]*\\s*>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$))","i").replace("comment",Vt).replace("tag",dt).replace("attribute",/ +[a-zA-Z:_][\w.:-]*(?: *= *"[^"\n]*"| *= *'[^'\n]*'| *= *[^\s"'=<>`]+)?/).getRegex(),on=I(Yt).replace("hr",Ge).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("|table","").replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",dt).getRegex(),Bi=I(/^( {0,3}> ?(paragraph|[^\n]*)(?:\n|$))+/).replace("paragraph",on).getRegex(),Jt={blockquote:Bi,code:Li,def:Di,fences:Ni,heading:$i,hr:Ge,html:Fi,lheading:nn,list:zi,newline:Pi,paragraph:on,table:He,text:Oi},Ns=I("^ *([^\\n ].*)\\n {0,3}((?:\\| *)?:?-+:? *(?:\\| *:?-+:? *)*(?:\\| *)?)(?:\\n((?:(?! *\\n|hr|heading|blockquote|code|fences|list|html).*(?:\\n|$))*)\\n*|$)").replace("hr",Ge).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("blockquote"," {0,3}>").replace("code","(?: {4}| {0,3}	)[^\\n]").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",dt).getRegex(),qi={...Jt,lheading:Ri,table:Ns,paragraph:I(Yt).replace("hr",Ge).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("table",Ns).replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",dt).getRegex()},Ui={...Jt,html:I(`^ *(?:comment *(?:\\n|\\s*$)|<(tag)[\\s\\S]+?</\\1> *(?:\\n{2,}|\\s*$)|<tag(?:"[^"]*"|'[^']*'|\\s[^'"/>\\s]*)*?/?> *(?:\\n{2,}|\\s*$))`).replace("comment",Vt).replace(/tag/g,"(?!(?:a|em|strong|small|s|cite|q|dfn|abbr|data|time|code|var|samp|kbd|sub|sup|i|b|u|mark|ruby|rt|rp|bdi|bdo|span|br|wbr|ins|del|img)\\b)\\w+(?!:|[^\\w\\s@]*@)\\b").getRegex(),def:/^ *\[([^\]]+)\]: *<?([^\s>]+)>?(?: +(["(][^\n]+[")]))? *(?:\n+|$)/,heading:/^(#{1,6})(.*)(?:\n+|$)/,fences:He,lheading:/^(.+?)\n {0,3}(=+|-+) *(?:\n+|$)/,paragraph:I(Yt).replace("hr",Ge).replace("heading",` *#{1,6} *[^
]`).replace("lheading",nn).replace("|table","").replace("blockquote"," {0,3}>").replace("|fences","").replace("|list","").replace("|html","").replace("|tag","").getRegex()},ji=/^\\([!"#$%&'()*+,\-./:;<=>?@\[\]\\^_`{|}~])/,Hi=/^(`+)([^`]|[^`][\s\S]*?[^`])\1(?!`)/,rn=/^( {2,}|\\)\n(?!\s*$)/,Gi=/^(`+|[^`])(?:(?= {2,}\n)|[\s\S]*?(?:(?=[\\<!\[`*_]|\b_|$)|[^ ](?= {2,}\n)))/,ht=/[\p{P}\p{S}]/u,Kt=/[\s\p{P}\p{S}]/u,an=/[^\s\p{P}\p{S}]/u,Wi=I(/^((?![*_])punctSpace)/,"u").replace(/punctSpace/g,Kt).getRegex(),cn=/(?!~)[\p{P}\p{S}]/u,Yi=/(?!~)[\s\p{P}\p{S}]/u,Xi=/(?:[^\s\p{P}\p{S}]|~)/u,Vi=I(/link|precode-code|html/,"g").replace("link",/\[(?:[^\[\]`]|(?<a>`+)[^`]+\k<a>(?!`))*?\]\((?:\\[\s\S]|[^\\\(\)]|\((?:\\[\s\S]|[^\\\(\)])*\))*\)/).replace("precode-",Mi?"(?<!`)()":"(^^|[^`])").replace("code",/(?<b>`+)[^`]+\k<b>(?!`)/).replace("html",/<(?! )[^<>]*?>/).getRegex(),ln=/^(?:\*+(?:((?!\*)punct)|[^\s*]))|^_+(?:((?!_)punct)|([^\s_]))/,Ji=I(ln,"u").replace(/punct/g,ht).getRegex(),Ki=I(ln,"u").replace(/punct/g,cn).getRegex(),dn="^[^_*]*?__[^_*]*?\\*[^_*]*?(?=__)|[^*]+(?=[^*])|(?!\\*)punct(\\*+)(?=[\\s]|$)|notPunctSpace(\\*+)(?!\\*)(?=punctSpace|$)|(?!\\*)punctSpace(\\*+)(?=notPunctSpace)|[\\s](\\*+)(?!\\*)(?=punct)|(?!\\*)punct(\\*+)(?!\\*)(?=punct)|notPunctSpace(\\*+)(?=notPunctSpace)",Zi=I(dn,"gu").replace(/notPunctSpace/g,an).replace(/punctSpace/g,Kt).replace(/punct/g,ht).getRegex(),Qi=I(dn,"gu").replace(/notPunctSpace/g,Xi).replace(/punctSpace/g,Yi).replace(/punct/g,cn).getRegex(),eo=I("^[^_*]*?\\*\\*[^_*]*?_[^_*]*?(?=\\*\\*)|[^_]+(?=[^_])|(?!_)punct(_+)(?=[\\s]|$)|notPunctSpace(_+)(?!_)(?=punctSpace|$)|(?!_)punctSpace(_+)(?=notPunctSpace)|[\\s](_+)(?!_)(?=punct)|(?!_)punct(_+)(?!_)(?=punct)","gu").replace(/notPunctSpace/g,an).replace(/punctSpace/g,Kt).replace(/punct/g,ht).getRegex(),to=I(/\\(punct)/,"gu").replace(/punct/g,ht).getRegex(),so=I(/^<(scheme:[^\s\x00-\x1f<>]*|email)>/).replace("scheme",/[a-zA-Z][a-zA-Z0-9+.-]{1,31}/).replace("email",/[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+(@)[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+(?![-_])/).getRegex(),no=I(Vt).replace("(?:-->|$)","-->").getRegex(),io=I("^comment|^</[a-zA-Z][\\w:-]*\\s*>|^<[a-zA-Z][\\w-]*(?:attribute)*?\\s*/?>|^<\\?[\\s\\S]*?\\?>|^<![a-zA-Z]+\\s[\\s\\S]*?>|^<!\\[CDATA\\[[\\s\\S]*?\\]\\]>").replace("comment",no).replace("attribute",/\s+[a-zA-Z:_][\w.:-]*(?:\s*=\s*"[^"]*"|\s*=\s*'[^']*'|\s*=\s*[^\s"'=<>`]+)?/).getRegex(),at=/(?:\[(?:\\[\s\S]|[^\[\]\\])*\]|\\[\s\S]|`+[^`]*?`+(?!`)|[^\[\]\\`])*?/,oo=I(/^!?\[(label)\]\(\s*(href)(?:(?:[ \t]*(?:\n[ \t]*)?)(title))?\s*\)/).replace("label",at).replace("href",/<(?:\\.|[^\n<>\\])+>|[^ \t\n\x00-\x1f]*/).replace("title",/"(?:\\"?|[^"\\])*"|'(?:\\'?|[^'\\])*'|\((?:\\\)?|[^)\\])*\)/).getRegex(),hn=I(/^!?\[(label)\]\[(ref)\]/).replace("label",at).replace("ref",Xt).getRegex(),un=I(/^!?\[(ref)\](?:\[\])?/).replace("ref",Xt).getRegex(),ro=I("reflink|nolink(?!\\()","g").replace("reflink",hn).replace("nolink",un).getRegex(),$s=/[hH][tT][tT][pP][sS]?|[fF][tT][pP]/,Zt={_backpedal:He,anyPunctuation:to,autolink:so,blockSkip:Vi,br:rn,code:Hi,del:He,emStrongLDelim:Ji,emStrongRDelimAst:Zi,emStrongRDelimUnd:eo,escape:ji,link:oo,nolink:un,punctuation:Wi,reflink:hn,reflinkSearch:ro,tag:io,text:Gi,url:He},ao={...Zt,link:I(/^!?\[(label)\]\((.*?)\)/).replace("label",at).getRegex(),reflink:I(/^!?\[(label)\]\s*\[([^\]]*)\]/).replace("label",at).getRegex()},zt={...Zt,emStrongRDelimAst:Qi,emStrongLDelim:Ki,url:I(/^((?:protocol):\/\/|www\.)(?:[a-zA-Z0-9\-]+\.?)+[^\s<]*|^email/).replace("protocol",$s).replace("email",/[A-Za-z0-9._+-]+(@)[a-zA-Z0-9-_]+(?:\.[a-zA-Z0-9-_]*[a-zA-Z0-9])+(?![-_])/).getRegex(),_backpedal:/(?:[^?!.,:;*_'"~()&]+|\([^)]*\)|&(?![a-zA-Z0-9]+;$)|[?!.,:;*_'"~)]+(?!$))+/,del:/^(~~?)(?=[^\s~])((?:\\[\s\S]|[^\\])*?(?:\\[\s\S]|[^\s~\\]))\1(?=[^~]|$)/,text:I(/^([`~]+|[^`~])(?:(?= {2,}\n)|(?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)|[\s\S]*?(?:(?=[\\<!\[`*~_]|\b_|protocol:\/\/|www\.|$)|[^ ](?= {2,}\n)|[^a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-](?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)))/).replace("protocol",$s).getRegex()},co={...zt,br:I(rn).replace("{2,}","*").getRegex(),text:I(zt.text).replace("\\b_","\\b_| {2,}\\n").replace(/\{2,\}/g,"*").getRegex()},nt={normal:Jt,gfm:qi,pedantic:Ui},qe={normal:Zt,gfm:zt,breaks:co,pedantic:ao},lo={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},Rs=i=>lo[i];function he(i,e){if(e){if(Y.escapeTest.test(i))return i.replace(Y.escapeReplace,Rs)}else if(Y.escapeTestNoEncode.test(i))return i.replace(Y.escapeReplaceNoEncode,Rs);return i}function Os(i){try{i=encodeURI(i).replace(Y.percentDecode,"%")}catch{return null}return i}function Ds(i,e){var o;let t=i.replace(Y.findPipe,(r,a,c)=>{let l=!1,p=a;for(;--p>=0&&c[p]==="\\";)l=!l;return l?"|":" |"}),s=t.split(Y.splitPipe),n=0;if(s[0].trim()||s.shift(),s.length>0&&!((o=s.at(-1))!=null&&o.trim())&&s.pop(),e)if(s.length>e)s.splice(e);else for(;s.length<e;)s.push("");for(;n<s.length;n++)s[n]=s[n].trim().replace(Y.slashPipe,"|");return s}function Ue(i,e,t){let s=i.length;if(s===0)return"";let n=0;for(;n<s&&i.charAt(s-n-1)===e;)n++;return i.slice(0,s-n)}function ho(i,e){if(i.indexOf(e[1])===-1)return-1;let t=0;for(let s=0;s<i.length;s++)if(i[s]==="\\")s++;else if(i[s]===e[0])t++;else if(i[s]===e[1]&&(t--,t<0))return s;return t>0?-2:-1}function zs(i,e,t,s,n){let o=e.href,r=e.title||null,a=i[1].replace(n.other.outputLinkReplace,"$1");s.state.inLink=!0;let c={type:i[0].charAt(0)==="!"?"image":"link",raw:t,href:o,title:r,text:a,tokens:s.inlineTokens(a)};return s.state.inLink=!1,c}function uo(i,e,t){let s=i.match(t.other.indentCodeCompensation);if(s===null)return e;let n=s[1];return e.split(`
`).map(o=>{let r=o.match(t.other.beginningSpace);if(r===null)return o;let[a]=r;return a.length>=n.length?o.slice(n.length):o}).join(`
`)}var ct=class{constructor(i){P(this,"options");P(this,"rules");P(this,"lexer");this.options=i||xe}space(i){let e=this.rules.block.newline.exec(i);if(e&&e[0].length>0)return{type:"space",raw:e[0]}}code(i){let e=this.rules.block.code.exec(i);if(e){let t=e[0].replace(this.rules.other.codeRemoveIndent,"");return{type:"code",raw:e[0],codeBlockStyle:"indented",text:this.options.pedantic?t:Ue(t,`
`)}}}fences(i){let e=this.rules.block.fences.exec(i);if(e){let t=e[0],s=uo(t,e[3]||"",this.rules);return{type:"code",raw:t,lang:e[2]?e[2].trim().replace(this.rules.inline.anyPunctuation,"$1"):e[2],text:s}}}heading(i){let e=this.rules.block.heading.exec(i);if(e){let t=e[2].trim();if(this.rules.other.endingHash.test(t)){let s=Ue(t,"#");(this.options.pedantic||!s||this.rules.other.endingSpaceChar.test(s))&&(t=s.trim())}return{type:"heading",raw:e[0],depth:e[1].length,text:t,tokens:this.lexer.inline(t)}}}hr(i){let e=this.rules.block.hr.exec(i);if(e)return{type:"hr",raw:Ue(e[0],`
`)}}blockquote(i){let e=this.rules.block.blockquote.exec(i);if(e){let t=Ue(e[0],`
`).split(`
`),s="",n="",o=[];for(;t.length>0;){let r=!1,a=[],c;for(c=0;c<t.length;c++)if(this.rules.other.blockquoteStart.test(t[c]))a.push(t[c]),r=!0;else if(!r)a.push(t[c]);else break;t=t.slice(c);let l=a.join(`
`),p=l.replace(this.rules.other.blockquoteSetextReplace,`
    $1`).replace(this.rules.other.blockquoteSetextReplace2,"");s=s?`${s}
${l}`:l,n=n?`${n}
${p}`:p;let h=this.lexer.state.top;if(this.lexer.state.top=!0,this.lexer.blockTokens(p,o,!0),this.lexer.state.top=h,t.length===0)break;let g=o.at(-1);if((g==null?void 0:g.type)==="code")break;if((g==null?void 0:g.type)==="blockquote"){let u=g,f=u.raw+`
`+t.join(`
`),m=this.blockquote(f);o[o.length-1]=m,s=s.substring(0,s.length-u.raw.length)+m.raw,n=n.substring(0,n.length-u.text.length)+m.text;break}else if((g==null?void 0:g.type)==="list"){let u=g,f=u.raw+`
`+t.join(`
`),m=this.list(f);o[o.length-1]=m,s=s.substring(0,s.length-g.raw.length)+m.raw,n=n.substring(0,n.length-u.raw.length)+m.raw,t=f.substring(o.at(-1).raw.length).split(`
`);continue}}return{type:"blockquote",raw:s,tokens:o,text:n}}}list(i){var t,s;let e=this.rules.block.list.exec(i);if(e){let n=e[1].trim(),o=n.length>1,r={type:"list",raw:"",ordered:o,start:o?+n.slice(0,-1):"",loose:!1,items:[]};n=o?`\\d{1,9}\\${n.slice(-1)}`:`\\${n}`,this.options.pedantic&&(n=o?n:"[*+-]");let a=this.rules.other.listItemRegex(n),c=!1;for(;i;){let p=!1,h="",g="";if(!(e=a.exec(i))||this.rules.block.hr.test(i))break;h=e[0],i=i.substring(h.length);let u=e[2].split(`
`,1)[0].replace(this.rules.other.listReplaceTabs,E=>" ".repeat(3*E.length)),f=i.split(`
`,1)[0],m=!u.trim(),b=0;if(this.options.pedantic?(b=2,g=u.trimStart()):m?b=e[1].length+1:(b=e[2].search(this.rules.other.nonSpaceChar),b=b>4?1:b,g=u.slice(b),b+=e[1].length),m&&this.rules.other.blankLine.test(f)&&(h+=f+`
`,i=i.substring(f.length+1),p=!0),!p){let E=this.rules.other.nextBulletRegex(b),S=this.rules.other.hrRegex(b),D=this.rules.other.fencesBeginRegex(b),C=this.rules.other.headingBeginRegex(b),j=this.rules.other.htmlBeginRegex(b);for(;i;){let L=i.split(`
`,1)[0],J;if(f=L,this.options.pedantic?(f=f.replace(this.rules.other.listReplaceNesting,"  "),J=f):J=f.replace(this.rules.other.tabCharGlobal,"    "),D.test(f)||C.test(f)||j.test(f)||E.test(f)||S.test(f))break;if(J.search(this.rules.other.nonSpaceChar)>=b||!f.trim())g+=`
`+J.slice(b);else{if(m||u.replace(this.rules.other.tabCharGlobal,"    ").search(this.rules.other.nonSpaceChar)>=4||D.test(u)||C.test(u)||S.test(u))break;g+=`
`+f}!m&&!f.trim()&&(m=!0),h+=L+`
`,i=i.substring(L.length+1),u=J.slice(b)}}r.loose||(c?r.loose=!0:this.rules.other.doubleBlankLine.test(h)&&(c=!0)),r.items.push({type:"list_item",raw:h,task:!!this.options.gfm&&this.rules.other.listIsTask.test(g),loose:!1,text:g,tokens:[]}),r.raw+=h}let l=r.items.at(-1);if(l)l.raw=l.raw.trimEnd(),l.text=l.text.trimEnd();else return;r.raw=r.raw.trimEnd();for(let p of r.items){if(this.lexer.state.top=!1,p.tokens=this.lexer.blockTokens(p.text,[]),p.task){if(p.text=p.text.replace(this.rules.other.listReplaceTask,""),((t=p.tokens[0])==null?void 0:t.type)==="text"||((s=p.tokens[0])==null?void 0:s.type)==="paragraph"){p.tokens[0].raw=p.tokens[0].raw.replace(this.rules.other.listReplaceTask,""),p.tokens[0].text=p.tokens[0].text.replace(this.rules.other.listReplaceTask,"");for(let g=this.lexer.inlineQueue.length-1;g>=0;g--)if(this.rules.other.listIsTask.test(this.lexer.inlineQueue[g].src)){this.lexer.inlineQueue[g].src=this.lexer.inlineQueue[g].src.replace(this.rules.other.listReplaceTask,"");break}}let h=this.rules.other.listTaskCheckbox.exec(p.raw);if(h){let g={type:"checkbox",raw:h[0]+" ",checked:h[0]!=="[ ]"};p.checked=g.checked,r.loose?p.tokens[0]&&["paragraph","text"].includes(p.tokens[0].type)&&"tokens"in p.tokens[0]&&p.tokens[0].tokens?(p.tokens[0].raw=g.raw+p.tokens[0].raw,p.tokens[0].text=g.raw+p.tokens[0].text,p.tokens[0].tokens.unshift(g)):p.tokens.unshift({type:"paragraph",raw:g.raw,text:g.raw,tokens:[g]}):p.tokens.unshift(g)}}if(!r.loose){let h=p.tokens.filter(u=>u.type==="space"),g=h.length>0&&h.some(u=>this.rules.other.anyLine.test(u.raw));r.loose=g}}if(r.loose)for(let p of r.items){p.loose=!0;for(let h of p.tokens)h.type==="text"&&(h.type="paragraph")}return r}}html(i){let e=this.rules.block.html.exec(i);if(e)return{type:"html",block:!0,raw:e[0],pre:e[1]==="pre"||e[1]==="script"||e[1]==="style",text:e[0]}}def(i){let e=this.rules.block.def.exec(i);if(e){let t=e[1].toLowerCase().replace(this.rules.other.multipleSpaceGlobal," "),s=e[2]?e[2].replace(this.rules.other.hrefBrackets,"$1").replace(this.rules.inline.anyPunctuation,"$1"):"",n=e[3]?e[3].substring(1,e[3].length-1).replace(this.rules.inline.anyPunctuation,"$1"):e[3];return{type:"def",tag:t,raw:e[0],href:s,title:n}}}table(i){var r;let e=this.rules.block.table.exec(i);if(!e||!this.rules.other.tableDelimiter.test(e[2]))return;let t=Ds(e[1]),s=e[2].replace(this.rules.other.tableAlignChars,"").split("|"),n=(r=e[3])!=null&&r.trim()?e[3].replace(this.rules.other.tableRowBlankLine,"").split(`
`):[],o={type:"table",raw:e[0],header:[],align:[],rows:[]};if(t.length===s.length){for(let a of s)this.rules.other.tableAlignRight.test(a)?o.align.push("right"):this.rules.other.tableAlignCenter.test(a)?o.align.push("center"):this.rules.other.tableAlignLeft.test(a)?o.align.push("left"):o.align.push(null);for(let a=0;a<t.length;a++)o.header.push({text:t[a],tokens:this.lexer.inline(t[a]),header:!0,align:o.align[a]});for(let a of n)o.rows.push(Ds(a,o.header.length).map((c,l)=>({text:c,tokens:this.lexer.inline(c),header:!1,align:o.align[l]})));return o}}lheading(i){let e=this.rules.block.lheading.exec(i);if(e)return{type:"heading",raw:e[0],depth:e[2].charAt(0)==="="?1:2,text:e[1],tokens:this.lexer.inline(e[1])}}paragraph(i){let e=this.rules.block.paragraph.exec(i);if(e){let t=e[1].charAt(e[1].length-1)===`
`?e[1].slice(0,-1):e[1];return{type:"paragraph",raw:e[0],text:t,tokens:this.lexer.inline(t)}}}text(i){let e=this.rules.block.text.exec(i);if(e)return{type:"text",raw:e[0],text:e[0],tokens:this.lexer.inline(e[0])}}escape(i){let e=this.rules.inline.escape.exec(i);if(e)return{type:"escape",raw:e[0],text:e[1]}}tag(i){let e=this.rules.inline.tag.exec(i);if(e)return!this.lexer.state.inLink&&this.rules.other.startATag.test(e[0])?this.lexer.state.inLink=!0:this.lexer.state.inLink&&this.rules.other.endATag.test(e[0])&&(this.lexer.state.inLink=!1),!this.lexer.state.inRawBlock&&this.rules.other.startPreScriptTag.test(e[0])?this.lexer.state.inRawBlock=!0:this.lexer.state.inRawBlock&&this.rules.other.endPreScriptTag.test(e[0])&&(this.lexer.state.inRawBlock=!1),{type:"html",raw:e[0],inLink:this.lexer.state.inLink,inRawBlock:this.lexer.state.inRawBlock,block:!1,text:e[0]}}link(i){let e=this.rules.inline.link.exec(i);if(e){let t=e[2].trim();if(!this.options.pedantic&&this.rules.other.startAngleBracket.test(t)){if(!this.rules.other.endAngleBracket.test(t))return;let o=Ue(t.slice(0,-1),"\\");if((t.length-o.length)%2===0)return}else{let o=ho(e[2],"()");if(o===-2)return;if(o>-1){let r=(e[0].indexOf("!")===0?5:4)+e[1].length+o;e[2]=e[2].substring(0,o),e[0]=e[0].substring(0,r).trim(),e[3]=""}}let s=e[2],n="";if(this.options.pedantic){let o=this.rules.other.pedanticHrefTitle.exec(s);o&&(s=o[1],n=o[3])}else n=e[3]?e[3].slice(1,-1):"";return s=s.trim(),this.rules.other.startAngleBracket.test(s)&&(this.options.pedantic&&!this.rules.other.endAngleBracket.test(t)?s=s.slice(1):s=s.slice(1,-1)),zs(e,{href:s&&s.replace(this.rules.inline.anyPunctuation,"$1"),title:n&&n.replace(this.rules.inline.anyPunctuation,"$1")},e[0],this.lexer,this.rules)}}reflink(i,e){let t;if((t=this.rules.inline.reflink.exec(i))||(t=this.rules.inline.nolink.exec(i))){let s=(t[2]||t[1]).replace(this.rules.other.multipleSpaceGlobal," "),n=e[s.toLowerCase()];if(!n){let o=t[0].charAt(0);return{type:"text",raw:o,text:o}}return zs(t,n,t[0],this.lexer,this.rules)}}emStrong(i,e,t=""){let s=this.rules.inline.emStrongLDelim.exec(i);if(!(!s||s[3]&&t.match(this.rules.other.unicodeAlphaNumeric))&&(!(s[1]||s[2])||!t||this.rules.inline.punctuation.exec(t))){let n=[...s[0]].length-1,o,r,a=n,c=0,l=s[0][0]==="*"?this.rules.inline.emStrongRDelimAst:this.rules.inline.emStrongRDelimUnd;for(l.lastIndex=0,e=e.slice(-1*i.length+n);(s=l.exec(e))!=null;){if(o=s[1]||s[2]||s[3]||s[4]||s[5]||s[6],!o)continue;if(r=[...o].length,s[3]||s[4]){a+=r;continue}else if((s[5]||s[6])&&n%3&&!((n+r)%3)){c+=r;continue}if(a-=r,a>0)continue;r=Math.min(r,r+a+c);let p=[...s[0]][0].length,h=i.slice(0,n+s.index+p+r);if(Math.min(n,r)%2){let u=h.slice(1,-1);return{type:"em",raw:h,text:u,tokens:this.lexer.inlineTokens(u)}}let g=h.slice(2,-2);return{type:"strong",raw:h,text:g,tokens:this.lexer.inlineTokens(g)}}}}codespan(i){let e=this.rules.inline.code.exec(i);if(e){let t=e[2].replace(this.rules.other.newLineCharGlobal," "),s=this.rules.other.nonSpaceChar.test(t),n=this.rules.other.startingSpaceChar.test(t)&&this.rules.other.endingSpaceChar.test(t);return s&&n&&(t=t.substring(1,t.length-1)),{type:"codespan",raw:e[0],text:t}}}br(i){let e=this.rules.inline.br.exec(i);if(e)return{type:"br",raw:e[0]}}del(i){let e=this.rules.inline.del.exec(i);if(e)return{type:"del",raw:e[0],text:e[2],tokens:this.lexer.inlineTokens(e[2])}}autolink(i){let e=this.rules.inline.autolink.exec(i);if(e){let t,s;return e[2]==="@"?(t=e[1],s="mailto:"+t):(t=e[1],s=t),{type:"link",raw:e[0],text:t,href:s,tokens:[{type:"text",raw:t,text:t}]}}}url(i){var t;let e;if(e=this.rules.inline.url.exec(i)){let s,n;if(e[2]==="@")s=e[0],n="mailto:"+s;else{let o;do o=e[0],e[0]=((t=this.rules.inline._backpedal.exec(e[0]))==null?void 0:t[0])??"";while(o!==e[0]);s=e[0],e[1]==="www."?n="http://"+e[0]:n=e[0]}return{type:"link",raw:e[0],text:s,href:n,tokens:[{type:"text",raw:s,text:s}]}}}inlineText(i){let e=this.rules.inline.text.exec(i);if(e){let t=this.lexer.state.inRawBlock;return{type:"text",raw:e[0],text:e[0],escaped:t}}}},se=class Ft{constructor(e){P(this,"tokens");P(this,"options");P(this,"state");P(this,"inlineQueue");P(this,"tokenizer");this.tokens=[],this.tokens.links=Object.create(null),this.options=e||xe,this.options.tokenizer=this.options.tokenizer||new ct,this.tokenizer=this.options.tokenizer,this.tokenizer.options=this.options,this.tokenizer.lexer=this,this.inlineQueue=[],this.state={inLink:!1,inRawBlock:!1,top:!0};let t={other:Y,block:nt.normal,inline:qe.normal};this.options.pedantic?(t.block=nt.pedantic,t.inline=qe.pedantic):this.options.gfm&&(t.block=nt.gfm,this.options.breaks?t.inline=qe.breaks:t.inline=qe.gfm),this.tokenizer.rules=t}static get rules(){return{block:nt,inline:qe}}static lex(e,t){return new Ft(t).lex(e)}static lexInline(e,t){return new Ft(t).inlineTokens(e)}lex(e){e=e.replace(Y.carriageReturn,`
`),this.blockTokens(e,this.tokens);for(let t=0;t<this.inlineQueue.length;t++){let s=this.inlineQueue[t];this.inlineTokens(s.src,s.tokens)}return this.inlineQueue=[],this.tokens}blockTokens(e,t=[],s=!1){var n,o,r;for(this.options.pedantic&&(e=e.replace(Y.tabCharGlobal,"    ").replace(Y.spaceLine,""));e;){let a;if((o=(n=this.options.extensions)==null?void 0:n.block)!=null&&o.some(l=>(a=l.call({lexer:this},e,t))?(e=e.substring(a.raw.length),t.push(a),!0):!1))continue;if(a=this.tokenizer.space(e)){e=e.substring(a.raw.length);let l=t.at(-1);a.raw.length===1&&l!==void 0?l.raw+=`
`:t.push(a);continue}if(a=this.tokenizer.code(e)){e=e.substring(a.raw.length);let l=t.at(-1);(l==null?void 0:l.type)==="paragraph"||(l==null?void 0:l.type)==="text"?(l.raw+=(l.raw.endsWith(`
`)?"":`
`)+a.raw,l.text+=`
`+a.text,this.inlineQueue.at(-1).src=l.text):t.push(a);continue}if(a=this.tokenizer.fences(e)){e=e.substring(a.raw.length),t.push(a);continue}if(a=this.tokenizer.heading(e)){e=e.substring(a.raw.length),t.push(a);continue}if(a=this.tokenizer.hr(e)){e=e.substring(a.raw.length),t.push(a);continue}if(a=this.tokenizer.blockquote(e)){e=e.substring(a.raw.length),t.push(a);continue}if(a=this.tokenizer.list(e)){e=e.substring(a.raw.length),t.push(a);continue}if(a=this.tokenizer.html(e)){e=e.substring(a.raw.length),t.push(a);continue}if(a=this.tokenizer.def(e)){e=e.substring(a.raw.length);let l=t.at(-1);(l==null?void 0:l.type)==="paragraph"||(l==null?void 0:l.type)==="text"?(l.raw+=(l.raw.endsWith(`
`)?"":`
`)+a.raw,l.text+=`
`+a.raw,this.inlineQueue.at(-1).src=l.text):this.tokens.links[a.tag]||(this.tokens.links[a.tag]={href:a.href,title:a.title},t.push(a));continue}if(a=this.tokenizer.table(e)){e=e.substring(a.raw.length),t.push(a);continue}if(a=this.tokenizer.lheading(e)){e=e.substring(a.raw.length),t.push(a);continue}let c=e;if((r=this.options.extensions)!=null&&r.startBlock){let l=1/0,p=e.slice(1),h;this.options.extensions.startBlock.forEach(g=>{h=g.call({lexer:this},p),typeof h=="number"&&h>=0&&(l=Math.min(l,h))}),l<1/0&&l>=0&&(c=e.substring(0,l+1))}if(this.state.top&&(a=this.tokenizer.paragraph(c))){let l=t.at(-1);s&&(l==null?void 0:l.type)==="paragraph"?(l.raw+=(l.raw.endsWith(`
`)?"":`
`)+a.raw,l.text+=`
`+a.text,this.inlineQueue.pop(),this.inlineQueue.at(-1).src=l.text):t.push(a),s=c.length!==e.length,e=e.substring(a.raw.length);continue}if(a=this.tokenizer.text(e)){e=e.substring(a.raw.length);let l=t.at(-1);(l==null?void 0:l.type)==="text"?(l.raw+=(l.raw.endsWith(`
`)?"":`
`)+a.raw,l.text+=`
`+a.text,this.inlineQueue.pop(),this.inlineQueue.at(-1).src=l.text):t.push(a);continue}if(e){let l="Infinite loop on byte: "+e.charCodeAt(0);if(this.options.silent){console.error(l);break}else throw new Error(l)}}return this.state.top=!0,t}inline(e,t=[]){return this.inlineQueue.push({src:e,tokens:t}),t}inlineTokens(e,t=[]){var c,l,p,h,g;let s=e,n=null;if(this.tokens.links){let u=Object.keys(this.tokens.links);if(u.length>0)for(;(n=this.tokenizer.rules.inline.reflinkSearch.exec(s))!=null;)u.includes(n[0].slice(n[0].lastIndexOf("[")+1,-1))&&(s=s.slice(0,n.index)+"["+"a".repeat(n[0].length-2)+"]"+s.slice(this.tokenizer.rules.inline.reflinkSearch.lastIndex))}for(;(n=this.tokenizer.rules.inline.anyPunctuation.exec(s))!=null;)s=s.slice(0,n.index)+"++"+s.slice(this.tokenizer.rules.inline.anyPunctuation.lastIndex);let o;for(;(n=this.tokenizer.rules.inline.blockSkip.exec(s))!=null;)o=n[2]?n[2].length:0,s=s.slice(0,n.index+o)+"["+"a".repeat(n[0].length-o-2)+"]"+s.slice(this.tokenizer.rules.inline.blockSkip.lastIndex);s=((l=(c=this.options.hooks)==null?void 0:c.emStrongMask)==null?void 0:l.call({lexer:this},s))??s;let r=!1,a="";for(;e;){r||(a=""),r=!1;let u;if((h=(p=this.options.extensions)==null?void 0:p.inline)!=null&&h.some(m=>(u=m.call({lexer:this},e,t))?(e=e.substring(u.raw.length),t.push(u),!0):!1))continue;if(u=this.tokenizer.escape(e)){e=e.substring(u.raw.length),t.push(u);continue}if(u=this.tokenizer.tag(e)){e=e.substring(u.raw.length),t.push(u);continue}if(u=this.tokenizer.link(e)){e=e.substring(u.raw.length),t.push(u);continue}if(u=this.tokenizer.reflink(e,this.tokens.links)){e=e.substring(u.raw.length);let m=t.at(-1);u.type==="text"&&(m==null?void 0:m.type)==="text"?(m.raw+=u.raw,m.text+=u.text):t.push(u);continue}if(u=this.tokenizer.emStrong(e,s,a)){e=e.substring(u.raw.length),t.push(u);continue}if(u=this.tokenizer.codespan(e)){e=e.substring(u.raw.length),t.push(u);continue}if(u=this.tokenizer.br(e)){e=e.substring(u.raw.length),t.push(u);continue}if(u=this.tokenizer.del(e)){e=e.substring(u.raw.length),t.push(u);continue}if(u=this.tokenizer.autolink(e)){e=e.substring(u.raw.length),t.push(u);continue}if(!this.state.inLink&&(u=this.tokenizer.url(e))){e=e.substring(u.raw.length),t.push(u);continue}let f=e;if((g=this.options.extensions)!=null&&g.startInline){let m=1/0,b=e.slice(1),E;this.options.extensions.startInline.forEach(S=>{E=S.call({lexer:this},b),typeof E=="number"&&E>=0&&(m=Math.min(m,E))}),m<1/0&&m>=0&&(f=e.substring(0,m+1))}if(u=this.tokenizer.inlineText(f)){e=e.substring(u.raw.length),u.raw.slice(-1)!=="_"&&(a=u.raw.slice(-1)),r=!0;let m=t.at(-1);(m==null?void 0:m.type)==="text"?(m.raw+=u.raw,m.text+=u.text):t.push(u);continue}if(e){let m="Infinite loop on byte: "+e.charCodeAt(0);if(this.options.silent){console.error(m);break}else throw new Error(m)}}return t}},lt=class{constructor(i){P(this,"options");P(this,"parser");this.options=i||xe}space(i){return""}code({text:i,lang:e,escaped:t}){var o;let s=(o=(e||"").match(Y.notSpaceStart))==null?void 0:o[0],n=i.replace(Y.endingNewline,"")+`
`;return s?'<pre><code class="language-'+he(s)+'">'+(t?n:he(n,!0))+`</code></pre>
`:"<pre><code>"+(t?n:he(n,!0))+`</code></pre>
`}blockquote({tokens:i}){return`<blockquote>
${this.parser.parse(i)}</blockquote>
`}html({text:i}){return i}def(i){return""}heading({tokens:i,depth:e}){return`<h${e}>${this.parser.parseInline(i)}</h${e}>
`}hr(i){return`<hr>
`}list(i){let e=i.ordered,t=i.start,s="";for(let r=0;r<i.items.length;r++){let a=i.items[r];s+=this.listitem(a)}let n=e?"ol":"ul",o=e&&t!==1?' start="'+t+'"':"";return"<"+n+o+`>
`+s+"</"+n+`>
`}listitem(i){return`<li>${this.parser.parse(i.tokens)}</li>
`}checkbox({checked:i}){return"<input "+(i?'checked="" ':"")+'disabled="" type="checkbox"> '}paragraph({tokens:i}){return`<p>${this.parser.parseInline(i)}</p>
`}table(i){let e="",t="";for(let n=0;n<i.header.length;n++)t+=this.tablecell(i.header[n]);e+=this.tablerow({text:t});let s="";for(let n=0;n<i.rows.length;n++){let o=i.rows[n];t="";for(let r=0;r<o.length;r++)t+=this.tablecell(o[r]);s+=this.tablerow({text:t})}return s&&(s=`<tbody>${s}</tbody>`),`<table>
<thead>
`+e+`</thead>
`+s+`</table>
`}tablerow({text:i}){return`<tr>
${i}</tr>
`}tablecell(i){let e=this.parser.parseInline(i.tokens),t=i.header?"th":"td";return(i.align?`<${t} align="${i.align}">`:`<${t}>`)+e+`</${t}>
`}strong({tokens:i}){return`<strong>${this.parser.parseInline(i)}</strong>`}em({tokens:i}){return`<em>${this.parser.parseInline(i)}</em>`}codespan({text:i}){return`<code>${he(i,!0)}</code>`}br(i){return"<br>"}del({tokens:i}){return`<del>${this.parser.parseInline(i)}</del>`}link({href:i,title:e,tokens:t}){let s=this.parser.parseInline(t),n=Os(i);if(n===null)return s;i=n;let o='<a href="'+i+'"';return e&&(o+=' title="'+he(e)+'"'),o+=">"+s+"</a>",o}image({href:i,title:e,text:t,tokens:s}){s&&(t=this.parser.parseInline(s,this.parser.textRenderer));let n=Os(i);if(n===null)return he(t);i=n;let o=`<img src="${i}" alt="${t}"`;return e&&(o+=` title="${he(e)}"`),o+=">",o}text(i){return"tokens"in i&&i.tokens?this.parser.parseInline(i.tokens):"escaped"in i&&i.escaped?i.text:he(i.text)}},Qt=class{strong({text:i}){return i}em({text:i}){return i}codespan({text:i}){return i}del({text:i}){return i}html({text:i}){return i}text({text:i}){return i}link({text:i}){return""+i}image({text:i}){return""+i}br(){return""}checkbox({raw:i}){return i}},ne=class Bt{constructor(e){P(this,"options");P(this,"renderer");P(this,"textRenderer");this.options=e||xe,this.options.renderer=this.options.renderer||new lt,this.renderer=this.options.renderer,this.renderer.options=this.options,this.renderer.parser=this,this.textRenderer=new Qt}static parse(e,t){return new Bt(t).parse(e)}static parseInline(e,t){return new Bt(t).parseInline(e)}parse(e){var s,n;let t="";for(let o=0;o<e.length;o++){let r=e[o];if((n=(s=this.options.extensions)==null?void 0:s.renderers)!=null&&n[r.type]){let c=r,l=this.options.extensions.renderers[c.type].call({parser:this},c);if(l!==!1||!["space","hr","heading","code","table","blockquote","list","html","def","paragraph","text"].includes(c.type)){t+=l||"";continue}}let a=r;switch(a.type){case"space":{t+=this.renderer.space(a);break}case"hr":{t+=this.renderer.hr(a);break}case"heading":{t+=this.renderer.heading(a);break}case"code":{t+=this.renderer.code(a);break}case"table":{t+=this.renderer.table(a);break}case"blockquote":{t+=this.renderer.blockquote(a);break}case"list":{t+=this.renderer.list(a);break}case"checkbox":{t+=this.renderer.checkbox(a);break}case"html":{t+=this.renderer.html(a);break}case"def":{t+=this.renderer.def(a);break}case"paragraph":{t+=this.renderer.paragraph(a);break}case"text":{t+=this.renderer.text(a);break}default:{let c='Token with "'+a.type+'" type was not found.';if(this.options.silent)return console.error(c),"";throw new Error(c)}}}return t}parseInline(e,t=this.renderer){var n,o;let s="";for(let r=0;r<e.length;r++){let a=e[r];if((o=(n=this.options.extensions)==null?void 0:n.renderers)!=null&&o[a.type]){let l=this.options.extensions.renderers[a.type].call({parser:this},a);if(l!==!1||!["escape","html","link","image","strong","em","codespan","br","del","text"].includes(a.type)){s+=l||"";continue}}let c=a;switch(c.type){case"escape":{s+=t.text(c);break}case"html":{s+=t.html(c);break}case"link":{s+=t.link(c);break}case"image":{s+=t.image(c);break}case"checkbox":{s+=t.checkbox(c);break}case"strong":{s+=t.strong(c);break}case"em":{s+=t.em(c);break}case"codespan":{s+=t.codespan(c);break}case"br":{s+=t.br(c);break}case"del":{s+=t.del(c);break}case"text":{s+=t.text(c);break}default:{let l='Token with "'+c.type+'" type was not found.';if(this.options.silent)return console.error(l),"";throw new Error(l)}}}return s}},it,je=(it=class{constructor(i){P(this,"options");P(this,"block");this.options=i||xe}preprocess(i){return i}postprocess(i){return i}processAllTokens(i){return i}emStrongMask(i){return i}provideLexer(){return this.block?se.lex:se.lexInline}provideParser(){return this.block?ne.parse:ne.parseInline}},P(it,"passThroughHooks",new Set(["preprocess","postprocess","processAllTokens","emStrongMask"])),P(it,"passThroughHooksRespectAsync",new Set(["preprocess","postprocess","processAllTokens"])),it),po=class{constructor(...i){P(this,"defaults",Gt());P(this,"options",this.setOptions);P(this,"parse",this.parseMarkdown(!0));P(this,"parseInline",this.parseMarkdown(!1));P(this,"Parser",ne);P(this,"Renderer",lt);P(this,"TextRenderer",Qt);P(this,"Lexer",se);P(this,"Tokenizer",ct);P(this,"Hooks",je);this.use(...i)}walkTokens(i,e){var s,n;let t=[];for(let o of i)switch(t=t.concat(e.call(this,o)),o.type){case"table":{let r=o;for(let a of r.header)t=t.concat(this.walkTokens(a.tokens,e));for(let a of r.rows)for(let c of a)t=t.concat(this.walkTokens(c.tokens,e));break}case"list":{let r=o;t=t.concat(this.walkTokens(r.items,e));break}default:{let r=o;(n=(s=this.defaults.extensions)==null?void 0:s.childTokens)!=null&&n[r.type]?this.defaults.extensions.childTokens[r.type].forEach(a=>{let c=r[a].flat(1/0);t=t.concat(this.walkTokens(c,e))}):r.tokens&&(t=t.concat(this.walkTokens(r.tokens,e)))}}return t}use(...i){let e=this.defaults.extensions||{renderers:{},childTokens:{}};return i.forEach(t=>{let s={...t};if(s.async=this.defaults.async||s.async||!1,t.extensions&&(t.extensions.forEach(n=>{if(!n.name)throw new Error("extension name required");if("renderer"in n){let o=e.renderers[n.name];o?e.renderers[n.name]=function(...r){let a=n.renderer.apply(this,r);return a===!1&&(a=o.apply(this,r)),a}:e.renderers[n.name]=n.renderer}if("tokenizer"in n){if(!n.level||n.level!=="block"&&n.level!=="inline")throw new Error("extension level must be 'block' or 'inline'");let o=e[n.level];o?o.unshift(n.tokenizer):e[n.level]=[n.tokenizer],n.start&&(n.level==="block"?e.startBlock?e.startBlock.push(n.start):e.startBlock=[n.start]:n.level==="inline"&&(e.startInline?e.startInline.push(n.start):e.startInline=[n.start]))}"childTokens"in n&&n.childTokens&&(e.childTokens[n.name]=n.childTokens)}),s.extensions=e),t.renderer){let n=this.defaults.renderer||new lt(this.defaults);for(let o in t.renderer){if(!(o in n))throw new Error(`renderer '${o}' does not exist`);if(["options","parser"].includes(o))continue;let r=o,a=t.renderer[r],c=n[r];n[r]=(...l)=>{let p=a.apply(n,l);return p===!1&&(p=c.apply(n,l)),p||""}}s.renderer=n}if(t.tokenizer){let n=this.defaults.tokenizer||new ct(this.defaults);for(let o in t.tokenizer){if(!(o in n))throw new Error(`tokenizer '${o}' does not exist`);if(["options","rules","lexer"].includes(o))continue;let r=o,a=t.tokenizer[r],c=n[r];n[r]=(...l)=>{let p=a.apply(n,l);return p===!1&&(p=c.apply(n,l)),p}}s.tokenizer=n}if(t.hooks){let n=this.defaults.hooks||new je;for(let o in t.hooks){if(!(o in n))throw new Error(`hook '${o}' does not exist`);if(["options","block"].includes(o))continue;let r=o,a=t.hooks[r],c=n[r];je.passThroughHooks.has(o)?n[r]=l=>{if(this.defaults.async&&je.passThroughHooksRespectAsync.has(o))return(async()=>{let h=await a.call(n,l);return c.call(n,h)})();let p=a.call(n,l);return c.call(n,p)}:n[r]=(...l)=>{if(this.defaults.async)return(async()=>{let h=await a.apply(n,l);return h===!1&&(h=await c.apply(n,l)),h})();let p=a.apply(n,l);return p===!1&&(p=c.apply(n,l)),p}}s.hooks=n}if(t.walkTokens){let n=this.defaults.walkTokens,o=t.walkTokens;s.walkTokens=function(r){let a=[];return a.push(o.call(this,r)),n&&(a=a.concat(n.call(this,r))),a}}this.defaults={...this.defaults,...s}}),this}setOptions(i){return this.defaults={...this.defaults,...i},this}lexer(i,e){return se.lex(i,e??this.defaults)}parser(i,e){return ne.parse(i,e??this.defaults)}parseMarkdown(i){return(e,t)=>{let s={...t},n={...this.defaults,...s},o=this.onError(!!n.silent,!!n.async);if(this.defaults.async===!0&&s.async===!1)return o(new Error("marked(): The async option was set to true by an extension. Remove async: false from the parse options object to return a Promise."));if(typeof e>"u"||e===null)return o(new Error("marked(): input parameter is undefined or null"));if(typeof e!="string")return o(new Error("marked(): input parameter is of type "+Object.prototype.toString.call(e)+", string expected"));if(n.hooks&&(n.hooks.options=n,n.hooks.block=i),n.async)return(async()=>{let r=n.hooks?await n.hooks.preprocess(e):e,a=await(n.hooks?await n.hooks.provideLexer():i?se.lex:se.lexInline)(r,n),c=n.hooks?await n.hooks.processAllTokens(a):a;n.walkTokens&&await Promise.all(this.walkTokens(c,n.walkTokens));let l=await(n.hooks?await n.hooks.provideParser():i?ne.parse:ne.parseInline)(c,n);return n.hooks?await n.hooks.postprocess(l):l})().catch(o);try{n.hooks&&(e=n.hooks.preprocess(e));let r=(n.hooks?n.hooks.provideLexer():i?se.lex:se.lexInline)(e,n);n.hooks&&(r=n.hooks.processAllTokens(r)),n.walkTokens&&this.walkTokens(r,n.walkTokens);let a=(n.hooks?n.hooks.provideParser():i?ne.parse:ne.parseInline)(r,n);return n.hooks&&(a=n.hooks.postprocess(a)),a}catch(r){return o(r)}}}onError(i,e){return t=>{if(t.message+=`
Please report this to https://github.com/markedjs/marked.`,i){let s="<p>An error occurred:</p><pre>"+he(t.message+"",!0)+"</pre>";return e?Promise.resolve(s):s}if(e)return Promise.reject(t);throw t}}},ve=new po;function M(i,e){return ve.parse(i,e)}M.options=M.setOptions=function(i){return ve.setOptions(i),M.defaults=ve.defaults,tn(M.defaults),M};M.getDefaults=Gt;M.defaults=xe;M.use=function(...i){return ve.use(...i),M.defaults=ve.defaults,tn(M.defaults),M};M.walkTokens=function(i,e){return ve.walkTokens(i,e)};M.parseInline=ve.parseInline;M.Parser=ne;M.parser=ne.parse;M.Renderer=lt;M.TextRenderer=Qt;M.Lexer=se;M.lexer=se.lex;M.Tokenizer=ct;M.Hooks=je;M.parse=M;M.options;M.setOptions;M.use;M.walkTokens;M.parseInline;ne.parse;se.lex;M.setOptions({breaks:!0,gfm:!0,headerIds:!1,mangle:!1});const Fs={idle:{label:"Idle",css:"idle",icon:"â¸"},initializing:{label:"Initializing",css:"starting",icon:"â³"},executing:{label:"Executing",css:"starting",icon:"âš¡"},monitoring:{label:"Monitoring",css:"active",icon:"ðŸ”„"},paused:{label:"Paused",css:"paused",icon:"â¸"},completed:{label:"Completed",css:"success",icon:"âœ…"},failed:{label:"Failed",css:"error",icon:"âŒ"},cancelled:{label:"Cancelled",css:"idle",icon:"ðŸ›‘"}};class go{constructor(e){this.bus=e,this._isOpen=!1,this._messages=[],this._state="idle",this._metrics=null,this._handsOff=!1,this._elapsedInterval=null,this._createDOM(),this._bindEvents()}_createDOM(){this.toggleBtn=document.createElement("button"),this.toggleBtn.id="agent-panel-toggle",this.toggleBtn.className="agent-panel-toggle",this.toggleBtn.innerHTML=`
      <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
        <path d="M3 5h14M3 10h14M3 15h14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
      </svg>
      <span class="toggle-label">Agents</span>
    `,this.toggleBtn.title="Toggle Agent Panel",document.body.appendChild(this.toggleBtn),this.panel=document.createElement("aside"),this.panel.id="agent-panel",this.panel.className="agent-panel glass-panel",this.panel.innerHTML=`
      <div class="agent-panel-header">
        <div class="panel-header-left">
          <span class="panel-icon">ðŸ¤–</span>
          <h3 class="panel-title">Agent Orchestration</h3>
        </div>
        <div class="panel-header-right">
          <span id="agent-status-indicator" class="agent-status-indicator idle" title="Status: Idle">â—</span>
          <button id="agent-panel-close" class="panel-close-btn" title="Close Panel">âœ•</button>
        </div>
      </div>

      <div class="agent-panel-readiness" id="agent-readiness">
        <div class="readiness-icon">ðŸ“‹</div>
        <div class="readiness-text">
          <span class="readiness-label">Map Readiness</span>
          <span class="readiness-value" id="readiness-value">â€”</span>
        </div>
      </div>

      <!-- Session controls bar -->
      <div class="agent-panel-controls" id="agent-controls">
        <div class="controls-row">
          <label class="hands-off-toggle" title="Hands-off: let agents run without approval gates">
            <input type="checkbox" id="hands-off-check">
            <span class="toggle-slider"></span>
            <span class="toggle-text">Hands-off</span>
          </label>
          <div class="session-actions">
            <button id="btn-pause-session" class="ctrl-btn" title="Pause" disabled>â¸</button>
            <button id="btn-cancel-session" class="ctrl-btn ctrl-btn-danger" title="Cancel" disabled>âœ•</button>
          </div>
        </div>
        <div class="controls-metrics" id="controls-metrics">
          <span class="metric"><span class="metric-icon">ðŸ’¬</span> <span id="metric-messages">0</span></span>
          <span class="metric"><span class="metric-icon">âš ï¸</span> <span id="metric-errors">0</span></span>
          <span class="metric"><span class="metric-icon">â±</span> <span id="metric-elapsed">0s</span></span>
        </div>
      </div>

      <div class="agent-panel-messages" id="agent-messages">
        <div class="messages-empty">
          <div class="empty-icon">ðŸ’¬</div>
          <p>No conversation yet.</p>
          <p class="empty-hint">Set up your mind map, then click <strong>â–¶ Run Agents</strong> to start.</p>
        </div>
      </div>

      <div class="agent-panel-input" id="agent-input-area">
        <div class="ceo-context-section" id="ceo-context-section">
          <textarea
            id="ceo-input"
            class="ceo-input"
            placeholder="Describe your concept, goals, or give feedback to agents..."
            rows="3"
          ></textarea>
          <div class="input-actions">
            <button id="btn-send-to-agents" class="agent-btn primary" title="Send to Agents">
              <span>Send to COO</span>
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                <path d="M2 8h12M10 4l4 4-4 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <div class="agent-panel-footer" id="agent-footer">
        <div class="cost-summary">
          <span class="cost-label">Session Cost</span>
          <span class="cost-value" id="cost-display">$0.00</span>
        </div>
        <div class="token-summary">
          <span class="token-label">Tokens</span>
          <span class="token-value" id="token-display">0</span>
        </div>
      </div>
    `,document.body.appendChild(this.panel)}_bindEvents(){this.toggleBtn.addEventListener("click",()=>this.toggle()),this.panel.querySelector("#agent-panel-close").addEventListener("click",()=>this.close()),this.panel.querySelector("#btn-send-to-agents").addEventListener("click",()=>this._sendMessage()),this.panel.querySelector("#ceo-input").addEventListener("keydown",o=>{o.key==="Enter"&&!o.shiftKey&&(o.preventDefault(),this._sendMessage())});const n=this.panel.querySelector("#hands-off-check");n.addEventListener("change",()=>{this._handsOff=n.checked,this.bus.emit("orchestration:hands-off-changed",{handsOff:this._handsOff})}),this.panel.querySelector("#btn-pause-session").addEventListener("click",()=>{this._state==="monitoring"?this.bus.emit("orchestration:pause-request"):this._state==="paused"&&this.bus.emit("orchestration:resume-request")}),this.panel.querySelector("#btn-cancel-session").addEventListener("click",()=>{this.bus.emit("orchestration:cancel-request")}),this.bus.on("agent:message",o=>this._addMessage(o)),this.bus.on("agent:status",o=>this._updateStatus(o)),this.bus.on("agent:cost-update",o=>this._updateCost(o)),this.bus.on("agent:readiness",o=>this._updateReadiness(o)),this.bus.on("orchestration:state-change",o=>this._onStateChange(o)),this.bus.on("orchestration:metrics-update",o=>this._onMetricsUpdate(o)),this.bus.on("orchestration:progress",o=>{this._addMessage({role:"agent",content:this._formatProgress(o),timestamp:Date.now(),displayName:"Claude Code"})}),this.bus.on("orchestration:error",o=>{this._addMessage({role:"system",content:`âš ï¸ ${o.message}`,timestamp:Date.now(),displayName:"System"})}),this.bus.on("orchestration:complete",o=>{this._addMessage({role:"system",content:o.success?"âœ… Session completed successfully.":`âŒ Session failed (exit code: ${o.exitCode}).`,timestamp:Date.now(),displayName:"System"})}),this.bus.on("orchestration:approval-needed",o=>{this._addMessage({role:"approval",content:`ðŸ” **Approval needed**: Claude wants to use \`${_e(o.tool)}\`.

Approve or deny this action in the Claude Code CLI.`,timestamp:Date.now(),displayName:"Approval Gate"})})}toggle(){this._isOpen?this.close():this.open()}open(){var e;this._isOpen=!0,this.panel.classList.add("open"),this.toggleBtn.classList.add("active"),(e=document.getElementById("app"))==null||e.classList.add("agent-panel-open"),this.bus.emit("agent-panel:opened")}close(){var e;this._isOpen=!1,this.panel.classList.remove("open"),this.toggleBtn.classList.remove("active"),(e=document.getElementById("app"))==null||e.classList.remove("agent-panel-open"),this.bus.emit("agent-panel:closed")}get handsOff(){return this._handsOff}setMessages(e){this._messages=e,this._renderMessages()}setCost(e,t){const s=this.panel.querySelector("#cost-display"),n=this.panel.querySelector("#token-display");s&&(s.textContent=`$${e.toFixed(4)}`),n&&(n.textContent=t.toLocaleString())}_onStateChange(e){this._state=e.current;const t=Fs[e.current]||Fs.idle,s=this.panel.querySelector("#agent-status-indicator");s&&(s.className=`agent-status-indicator ${t.css}`,s.title=`Status: ${t.label}`,s.textContent=t.icon);const n=this.panel.querySelector("#btn-pause-session"),o=this.panel.querySelector("#btn-cancel-session"),r=["monitoring","paused","executing"].includes(e.current);o.disabled=!r,e.current==="monitoring"?(n.disabled=!1,n.textContent="â¸",n.title="Pause"):e.current==="paused"?(n.disabled=!1,n.textContent="â–¶",n.title="Resume"):(n.disabled=!0,n.textContent="â¸"),(e.current==="executing"||e.current==="monitoring")&&(this._isOpen||this.open()),e.current==="monitoring"||e.current==="executing"?this._startElapsedTimer():this._stopElapsedTimer()}_onMetricsUpdate(e){this._metrics=e.metrics;const t=this.panel.querySelector("#metric-messages"),s=this.panel.querySelector("#metric-errors"),n=this.panel.querySelector("#metric-elapsed");t&&(t.textContent=e.metrics.messageCount||0),s&&(s.textContent=e.metrics.errorCount||0),n&&(n.textContent=e.metrics.elapsedFormatted||"0s")}_sendMessage(){const e=this.panel.querySelector("#ceo-input"),t=e.value.trim();t&&(this.bus.emit("ceo:message",{content:t,timestamp:Date.now()}),this._addMessage({role:"ceo",content:t,timestamp:Date.now(),displayName:"CEO (You)"}),e.value="",e.focus())}_addMessage(e){this._messages.push(e),this._messages.length>200&&(this._messages=this._messages.slice(-200)),this._renderMessages()}_renderMessages(){const e=this.panel.querySelector("#agent-messages");if(this._messages.length===0){e.innerHTML=`
        <div class="messages-empty">
          <div class="empty-icon">ðŸ’¬</div>
          <p>No conversation yet.</p>
          <p class="empty-hint">Set up your mind map, then click <strong>â–¶ Run Agents</strong> to start.</p>
        </div>
      `;return}e.innerHTML=this._messages.map(t=>this._renderMessage(t)).join(""),requestAnimationFrame(()=>{e.scrollTop=e.scrollHeight})}_renderMessage(e){const t=e.role==="ceo",s=e.role==="system",n=e.role==="approval",o=e.role==="agent";let r,a,c;if(t)r="ðŸ‘¤",a="CEO (You)",c="ceo-message";else if(s)r="âš™ï¸",a=e.displayName||"System",c="system-message";else if(n)r="ðŸ”",a="Approval Gate",c="approval-message";else if(o)r="ðŸ¤–",a=e.displayName||"Claude Code",c="agent-message-other";else{const h=jt.find(g=>g.id===e.role);r=(h==null?void 0:h.icon)||"ðŸ¤–",a=e.displayName||(h==null?void 0:h.label)||e.role,c="agent-message-other"}const l=new Date(e.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),p=t?`<p>${_e(e.content)}</p>`:ei(M.parse(e.content||""));return`
      <div class="agent-message ${c}" data-role="${rt(e.role)}">
        <div class="message-header">
          <span class="message-avatar">${r}</span>
          <span class="message-name">${_e(a)}</span>
          <span class="message-time">${l}</span>
        </div>
        <div class="message-body">${p}</div>
        ${e.ceoDecision?`<div class="message-decision decision-${rt(e.ceoDecision)}">${_e(e.ceoDecision)}</div>`:""}
      </div>
    `}_formatProgress(e){var s;if(e.type==="text")return e.data||"";const t=e.data;if(!t)return"";if(t.type==="assistant"&&((s=t.message)!=null&&s.content)){const n=t.message.content;return Array.isArray(n)?n.filter(o=>o.type==="text").map(o=>o.text).join(`
`):typeof n=="string"?n:JSON.stringify(n)}if(t.type==="result"&&t.result)return`**Result**: ${t.result}`;if(t.type==="tool_use")return`ðŸ”§ Using tool: \`${t.name||t.tool}\``;if(t.type==="tool_result"){const n=t.output||t.content||"";return`ðŸ“„ Tool output: ${typeof n=="string"?n.substring(0,200):JSON.stringify(n).substring(0,200)}${n.length>200?"â€¦":""}`}return`[${t.type||"event"}]`}_updateStatus(e){const t=this.panel.querySelector("#agent-status-indicator");t&&(t.className=`agent-status-indicator ${e}`,t.title=`Status: ${e.charAt(0).toUpperCase()+e.slice(1)}`)}_updateCost(e){e&&this.setCost(e.totalCost||0,e.totalTokens||0)}_updateReadiness(e){const t=this.panel.querySelector("#readiness-value");t&&(e.valid?(t.textContent="âœ… Ready",t.className="readiness-value ready"):e.errors.length>0?(t.textContent=`âŒ ${e.errors.length} issue(s)`,t.className="readiness-value error"):(t.textContent=`âš ï¸ ${e.warnings.length} warning(s)`,t.className="readiness-value warning"))}_startElapsedTimer(){var t;this._stopElapsedTimer();const e=((t=this._metrics)==null?void 0:t.startedAt)||Date.now();this._elapsedInterval=setInterval(()=>{const s=Date.now()-e,n=this.panel.querySelector("#metric-elapsed");n&&(n.textContent=this._formatElapsed(s))},1e3)}_stopElapsedTimer(){this._elapsedInterval&&(clearInterval(this._elapsedInterval),this._elapsedInterval=null)}_formatElapsed(e){const t=Math.floor(e/1e3);if(t<60)return`${t}s`;const s=Math.floor(t/60),n=t%60;return s<60?`${s}m ${n}s`:`${Math.floor(s/60)}h ${s%60}m`}}function Bs(i,e,t={}){const s=[],n=[];if(!i||i.length===0?s.push("Mind map has no nodes. Add at least 2 nodes to define your project."):i.length<2?s.push("Mind map has only 1 node. Add more nodes to define your project structure."):i.length<3&&n.push("Mind map has very few nodes. Consider adding more detail for better agent results."),i){const r=i.filter(c=>!c.text||c.text.trim().length===0);r.length>0&&n.push(`${r.length} node(s) have no text. Give them labels for agents to understand your intent.`);const a=i.filter(c=>c.text&&c.text.trim().length>0&&c.text.trim().length<3);a.length>0&&n.push(`${a.length} node(s) have very short labels. More descriptive text helps agents.`)}if(i&&i.length>=2&&i.filter(a=>a.nodeType&&a.nodeType!=="general").length===0&&n.push("No nodes have a type set. Categorizing nodes (feature, constraint, risk, etc.) helps agents prioritize."),i&&i.length>=3&&i.filter(a=>a.priority&&a.priority!=="medium").length===0&&n.push("All nodes are default priority. Setting priorities helps agents focus on critical items."),e&&i&&i.length>=2)if(e.length===0)n.push("No connections between nodes. Connecting related nodes helps agents understand relationships.");else{const r=new Set;e.forEach(c=>{r.add(c.sourceId),r.add(c.targetId)});const a=i.filter(c=>!r.has(c.id));a.length>0&&a.length<i.length&&n.push(`${a.length} node(s) are not connected to anything. Connect them to show relationships.`)}(!t||!t.concept&&(!t.goals||t.goals.length===0))&&n.push("No CEO context provided. Describing your concept and goals gives agents better direction.");const o=fo(i||[],e||[]);return{valid:s.length===0,errors:s,warnings:n,stats:o}}function fo(i,e){const t={},s={},n={};return qt.forEach(o=>t[o.id]=0),Ut.forEach(o=>s[o.id]=0),Object.keys(Rt).forEach(o=>n[o]=0),i.forEach(o=>{const r=o.nodeType||"general",a=o.priority||"medium",c=o.agentStatus||"unassigned";t[r]=(t[r]||0)+1,s[a]=(s[a]||0)+1,n[c]=(n[c]||0)+1}),{totalNodes:i.length,totalConnections:e.length,nodesByType:t,nodesByPriority:s,nodesByStatus:n,nodesWithText:i.filter(o=>o.text&&o.text.trim().length>0).length,nodesAssigned:i.filter(o=>o.assignedAgent).length}}function pn(i,e,t={}){const s=new Map(i.map(u=>[u.id,u])),n={feature:[],constraint:[],risk:[],reference:[],techNote:[],general:[]};i.forEach(u=>{const f=u.nodeType||"general",m={id:u.id,text:(u.text||"").trim(),type:f,priority:u.priority||"medium",assignedAgent:u.assignedAgent||null,agentNotes:u.agentNotes||"",shape:u.shape||"rectangle"};n[f]?n[f].push(m):n.general.push(m)});const o={critical:0,high:1,medium:2,low:3};Object.values(n).forEach(u=>{u.sort((f,m)=>(o[f.priority]??2)-(o[m.priority]??2))});const r=[],a=new Map,c=new Map;i.forEach(u=>{a.set(u.id,[]),c.set(u.id,0)}),e.forEach(u=>{var E,S;const f=s.get(u.sourceId),m=s.get(u.targetId);if(!f||!m)return;const b=u.directed==="forward"||u.directed==="both";r.push({from:{id:f.id,text:(f.text||"").trim()},to:{id:m.id,text:(m.text||"").trim()},directed:b,type:b?"depends-on":"related-to"}),b&&((E=a.get(u.sourceId))==null||E.push(u.targetId),c.set(u.targetId,(c.get(u.targetId)||0)+1)),u.directed==="both"&&((S=a.get(u.targetId))==null||S.push(u.sourceId),c.set(u.sourceId,(c.get(u.sourceId)||0)+1))});const l=mo(i,a,c,o),p=i.filter(u=>(c.get(u.id)||0)===0&&(u.text||"").trim().length>0);let h=t.projectName||"";if(!h&&p.length>0){const u=p.find(f=>(f.text||"").trim().length>2);u&&(h=u.text.trim())}h||(h="Untitled Project");const g={totalNodes:i.length,totalConnections:e.length,directedConnections:e.filter(u=>u.directed==="forward"||u.directed==="both").length,undirectedConnections:e.filter(u=>u.directed==="none"||!u.directed).length,featureCount:n.feature.length,constraintCount:n.constraint.length,riskCount:n.risk.length,referenceCount:n.reference.length,techNoteCount:n.techNote.length,generalCount:n.general.length,criticalCount:i.filter(u=>u.priority==="critical").length,highCount:i.filter(u=>u.priority==="high").length};return{projectName:h,ceoVision:t.ceoVision||"",...n,dependencies:r,executionOrder:l,rootNodes:p.map(u=>({id:u.id,text:(u.text||"").trim()})),stats:g}}function mo(i,e,t,s){const n=[],o=new Map(t);let r=i.filter(c=>(o.get(c.id)||0)===0).sort((c,l)=>(s[c.priority]??2)-(s[l.priority]??2));for(;r.length>0;){const c=r.shift();n.push({id:c.id,text:(c.text||"").trim(),type:c.nodeType||"general",priority:c.priority||"medium"});const l=e.get(c.id)||[],p=[];for(const h of l){const g=(o.get(h)||1)-1;if(o.set(h,g),g===0){const u=i.find(f=>f.id===h);u&&p.push(u)}}p.sort((h,g)=>(s[h.priority]??2)-(s[g.priority]??2)),r.push(...p)}const a=new Set(n.map(c=>c.id));return i.forEach(c=>{a.has(c.id)||n.push({id:c.id,text:(c.text||"").trim(),type:c.nodeType||"general",priority:c.priority||"medium"})}),n}const yo={flash:{id:"flash",name:"Tier 1 â€” Flash",description:"Cheapest/free models for mechanical, unthinking tasks",philosophy:"No reasoning needed â€” just follow the pattern.",costProfile:"Near-zero (~$0.001 per call)",models:{google:"gemini-2.0-flash-lite",openai:"gpt-4o-mini",anthropic:"claude-haiku-3-20250307"},tasks:['Heartbeat checks â€” periodic "still alive" pings',"Idle state monitoring â€” agent status polling","File listing and directory scanning","Simple string formatting and template rendering","Mind map layout generation from structured data","JSON schema validation","Log aggregation and basic filtering","Timestamp and metadata generation","Status report compilation (no analysis)","Boilerplate scaffolding from templates"],criteria:["Task has a fixed, well-defined pattern","Output is deterministic or near-deterministic","No creative judgment or ambiguity resolution needed","Can be validated with simple rules (regex, schema, etc.)"]},standard:{id:"standard",name:"Tier 2 â€” Standard",description:"Mid-range models for clear thinking and structured analysis",philosophy:"Thinking required, but the path is clear.",costProfile:"Moderate (~$0.01-0.05 per call)",models:{google:"gemini-2.0-flash",openai:"gpt-4o",anthropic:"claude-sonnet-4-20250514"},tasks:["Code review with feedback generation","Documentation writing and API reference generation","Test case generation from specifications","Dependency analysis and impact assessment","Refactoring suggestions with rationale","Progress report analysis and summaries","Error message interpretation and fix suggestions","Configuration file generation from requirements","Sprint planning and task decomposition","QC pass â€” style, lint, and pattern compliance checks"],criteria:["Task requires understanding context and making judgments","Output needs to be coherent and well-reasoned","Multiple valid approaches exist but the domain is well-understood","Moderate complexity â€” not trivial, not groundbreaking"]},opus:{id:"opus",name:"Tier 3 â€” Opus",description:"Premium thinking models for hard agentic work requiring deep reasoning",philosophy:"The hard problems. The ones that keep CTOs up at night.",costProfile:"Premium (~$0.10-0.50+ per call)",models:{anthropic:"claude-opus-4-20250514",openai:"o3",google:"gemini-2.5-pro"},tasks:["System architecture design and decisions","Complex multi-file implementation with cross-cutting concerns","Debugging obscure, hard-to-reproduce issues","Security audits and vulnerability analysis","Performance optimization with profiling analysis","Creative problem-solving for novel requirements","Cross-system integration design","Critical decision-making with trade-off analysis","Algorithm design and optimization","Large-scale refactoring with state preservation"],criteria:["Task has genuine ambiguity requiring deep reasoning","Wrong answers have significant consequences","Multiple systems or concerns must be held in context simultaneously","Creative synthesis or novel solutions are needed","The problem space is large and interconnected"]}};function bo(){return{model_routing:{philosophy:"Cost-optimized intelligence: use the cheapest model capable of handling each sub-task correctly. Never bring a bazooka to a pillow fight.",tiers:Object.values(yo).map(i=>({tier:i.id,name:i.name,description:i.description,philosophy:i.philosophy,cost_profile:i.costProfile,recommended_models:i.models,task_types:i.tasks,selection_criteria:i.criteria})),routing_rules:["DEFAULT to Tier 1 (Flash) unless the task explicitly requires reasoning.","ESCALATE to Tier 2 (Standard) when the task needs contextual understanding or judgment calls.","RESERVE Tier 3 (Opus) for architecture decisions, complex debugging, security audits, and novel problem-solving.","When in doubt, start with the lower tier â€” escalate only if the output quality is insufficient.","Heartbeats, status checks, and idle monitoring MUST use Tier 1. No exceptions.","Agent coordination messages (task assignment, progress updates) use Tier 1.","Code generation for well-defined specs uses Tier 2. Ambiguous specs escalate to Tier 3.","All security-critical decisions MUST use Tier 3."],cost_tracking:{log_every_call:!0,track_tier_usage:!0,alert_threshold:"Flag if Tier 3 usage exceeds 20% of total calls â€” likely indicates over-escalation.",budget_allocation:"~70% Flash, ~25% Standard, ~5% Opus by call volume"}}}}function gn(i,e={}){const t=e.model||"claude-4.6",s=e.mode||"planning",n=e.stack||mn(i),o=fn(i,{model:t,mode:s,stack:n,...e});return Ao(o,i)}function fn(i,e){const t=bo();return{task_title:`${i.projectName} â€” Autonomous Build with Virtual Agent Team`,model:e.model,mode:e.mode,goal:_o(i),...t,workspace_instructions:vo(e),virtual_team:xo(i),project_context:wo(i),execution_strategy:ko(i),deliverables:So(i),constraints_and_style:To(i)}}function _o(i){let e=`Act as a single orchestrating super-agent that internally simulates and coordinates a virtual team to design, implement, document, and harden "${i.projectName}"`;i.ceoVision&&(e+=`. CEO Vision: ${i.ceoVision}`);const t=[];return i.stats.featureCount>0&&t.push(`${i.stats.featureCount} feature(s)`),i.stats.constraintCount>0&&t.push(`${i.stats.constraintCount} constraint(s)`),i.stats.riskCount>0&&t.push(`${i.stats.riskCount} identified risk(s)`),t.length>0&&(e+=`. The product mind map defines: ${t.join(", ")}.`),e+=" Maintain strong security and near-autonomous execution inside the IDE.",e}function vo(i){return{codebase_scope:"Use the current workspace as the canonical project root. Inspect existing files, package configuration, and any docs to align architecture and naming.",preferred_stack:i.stack||"Determine from existing project files or ask user.",allowed_tools:i.allowedTools||["editor_read_write","terminal","browser_preview","git"],general_policies:["Prefer iterative plans and small, reviewable patches over large monolithic edits.","Keep all design and technical decisions documented in /docs.","Before executing potentially destructive changes (deletes, mass refactors), restate your plan and confirm with the user if the risk is high.","Run builds and tests after each significant change to catch regressions early."]}}function xo(i){const e={};e.orchestrator={role:"Primary executive function (COO) inside this single agent.",_routing:"standard",responsibilities:["Translate the CEO's mind map into concrete milestones and task groups.","Assign tasks to the appropriate virtual sub-role and keep an internal task board.","Route each sub-task to the most efficient processing level available.","Sequence work so backend contracts and APIs are defined early, then UI flows, then integration, then QA/security passes.","Periodically summarize progress, remaining risks, and next actions in a concise status note for the user.","Use lightweight processing for: heartbeat pings, status checks, task board updates, progress log entries.","Escalate to deep-reasoning ONLY for: cross-cutting architecture decisions, unresolvable conflicts, novel problem-solving."]},e.cto={role:"Virtual Chief Technology Officer â€” architecture and technical strategy lead.",_routing:"opus",responsibilities:["Define and own the system architecture: module boundaries, data flow, communication patterns, and technology choices.","Make final calls on framework selection, infrastructure decisions, and build tooling.","Evaluate technical trade-offs (performance vs. complexity, build vs. buy, monolith vs. micro).","Review all cross-cutting concerns: caching strategy, error handling patterns, logging, and observability.","Approve the technical design of each milestone before the team begins implementation.","Maintain /docs/architecture.md as the living system design document."]},e.creative_director={role:"Virtual Creative Director and Art Department â€” visual identity, branding, and design system.",_routing:"standard",responsibilities:["Define the visual identity: color palette, typography scale, spacing system, and brand tone.","Create a design system / style guide and ensure all UI components adhere to it.","Specify iconography, illustration style, and imagery guidelines for consistency.","Review all user-facing screens for visual coherence, hierarchy, and polish.","Collaborate with the front-end agent to translate designs into responsive, pixel-accurate implementations.","Ensure dark mode, accessibility contrast ratios (WCAG AA minimum), and responsive breakpoints are handled.","Provide asset specifications: SVG icons, favicon, OG images, and loading states.","Maintain /docs/design-system.md documenting the visual language and component library."]};const t=i.feature.filter(o=>/design|brand|style|theme|color|font|icon|logo|visual|ux|ui.*design|aesthetic|dark.*mode|light.*mode/i.test(o.text));t.length>0&&(e.creative_director.priority_features=t.map(o=>o.text)),e.front_end_agent={role:"Virtual UI/UX and front-end engineer.",_routing:"standard",responsibilities:["Define core user journeys and translate them into screens, views, and components.","Collaborate with the creative director to implement the design system faithfully.","Collaborate with the virtual backend agent to align props, data models, and API contracts.","Continuously refactor for readability, type-safety (if applicable), and maintainability.","Ensure responsive layout, accessible semantics, and intuitive navigation.","Implement micro-interactions, animations, and loading states per creative director specs."]};const s=i.feature.filter(o=>/ui|interface|screen|page|form|button|modal|dashboard|layout/i.test(o.text));s.length>0&&(e.front_end_agent.priority_features=s.map(o=>o.text)),e.backend_agent={role:"Virtual backend engineer and API integrator.",_routing:"standard",responsibilities:["Create or adapt the backend structure and wiring in the codebase (auth, database, storage, API endpoints as needed).","Define data models, security rules, and API surface, then communicate contracts to the virtual front-end.","Document all environment variables, configuration, and deployment steps in /docs/backend.md."],security_focus:["Use the principle of least privilege in access control rules.","Avoid embedding secrets in the repo; reference env variables and document them clearly.","Security rule design and auth flow architecture require deep-reasoning â€” no shortcuts."]};const n=i.feature.filter(o=>/api|server|database|auth|cloud|function|endpoint|storage|backend|data/i.test(o.text));return n.length>0&&(e.backend_agent.priority_features=n.map(o=>o.text)),e.sentinel={role:"Virtual security specialist â€” dedicated to hardening, compliance, and threat prevention.",_routing:"opus",responsibilities:["Perform security audits on auth flows, data access paths, and API endpoints.","Review all security rules (Firestore, RTDB, Storage, CORS, CSP headers) for least-privilege compliance.","Threat-model every user-facing flow: authentication, authorization, input validation, file uploads.","Scan for secrets, API keys, and tokens in the codebase â€” flag any that are committed.","Validate HTTPS enforcement, cookie policies, and session management.","Ensure OWASP Top 10 and relevant compliance standards are addressed.","Maintain /docs/security-audit.md with findings, mitigations, and open items."]},e.research_agent={role:"Virtual technology analyst and research specialist.",_routing:"standard",responsibilities:["Investigate best practices and patterns relevant to the chosen stack.","When encountering an implementation hurdle, pause to research options and summarize trade-offs before coding.","Maintain /docs/tech-journal.md as a chronological log of decisions, rejected ideas, blockers, and resolutions.","Cross-link to external documentation in comments and docs where helpful."]},i.reference.length>0&&(e.research_agent.research_items=i.reference.map(o=>o.text)),e.documenter={role:"Virtual documentation specialist â€” owns all written deliverables.",_routing:"standard",responsibilities:["Write and maintain README, setup guides, and onboarding documentation.","Author API reference docs, data model descriptions, and environment configuration guides.","Ensure inline code comments are meaningful and not redundant.","Update /docs/ directory structure after every significant milestone.","Produce changelogs, migration guides, and deployment runbooks as needed."]},e.devils_advocate={role:"Virtual QA and architecture challenger.",_routing:"opus",responsibilities:["After each major milestone, run a review pass.","Challenge assumptions: performance, scalability, privacy, DX, and long-term maintainability.","Question architecture decisions â€” propose alternatives and stress-test trade-offs.","File concrete improvement tasks (code changes, tests, docs) and loop them back into the orchestrator's plan before marking a milestone as complete."],constraints:["Always ensure no secrets, API keys, or sensitive identifiers are committed in code, logs, or docs.","Prefer explicit configuration and validation over hidden magic."]},i.risk.length>0&&(e.devils_advocate.known_risks=i.risk.map(o=>({risk:o.text,priority:o.priority}))),e.auditors={role:"Virtual audit team â€” tracks token usage, API costs, and overall project health.",_routing:"flash",sub_roles:{token_auditor:"Track token consumption per task and per agent role. Flag excessive usage.",api_cost_auditor:"Monitor API call costs across providers. Alert when spend exceeds expected budgets.",project_auditor:"Assess overall project health: milestone completion rate, tech debt accumulation, documentation coverage."},responsibilities:["Maintain running cost and token logs after each major operation.","Generate periodic efficiency reports: tokens spent vs. output value.","Flag any role or task that is consuming disproportionate resources.","Recommend processing level adjustments based on observed task complexity."]},e}function wo(i){const e={product_name:i.projectName};return i.ceoVision&&(e.ceo_vision=i.ceoVision),i.feature.length>0&&(e.features=i.feature.map(t=>({name:t.text,priority:t.priority,...t.agentNotes?{notes:t.agentNotes}:{}}))),i.constraint.length>0&&(e.constraints=i.constraint.map(t=>({constraint:t.text,priority:t.priority}))),i.techNote.length>0&&(e.technical_notes=i.techNote.map(t=>t.text)),i.dependencies.length>0&&(e.dependency_graph=i.dependencies.map(t=>({from:t.from.text,to:t.to.text,relationship:t.type}))),e}function ko(i){const e=Eo(i);return{initial_steps:["Scan the repository structure and any existing README or docs.","Draft a high-level architecture diagram and feature list in /docs/architecture.md.",`Define a milestone plan with ${e.length} phases derived from the mind map.`],milestones:e,workflow:["For each milestone, have the orchestrator generate a plan, then let the relevant virtual sub-role take the lead on implementation.","After implementing a milestone, invoke the devil's advocate mode to review decisions, suggest corrections, and create follow-up tasks.","Keep changes small and atomic, using clear commit messages if git is available.","Show task groups and artifacts (plans, docs, test descriptions) rather than only final code."],user_interaction:["Ask the user early to confirm: target platform, preferred stack, and any non-negotiable constraints.","Before executing high-impact operations (framework switch, large refactor), request explicit confirmation.","Summarize progress and open questions at natural checkpoints so the user can steer the project."]}}function Eo(i){const e=[];e.push({phase:1,name:"Project & Environment Setup",_routing:"flash",_rationale:"Setup tasks are mechanical â€” scaffolding, config copying, dependency installation.",tasks:["Initialize project structure and dependencies","Set up development environment and tooling","Create initial documentation scaffold"]});const t=i.feature.filter(r=>r.priority==="critical"),s=i.feature.filter(r=>r.priority==="high"),n=i.feature.filter(r=>r.priority==="medium"),o=i.feature.filter(r=>r.priority==="low");return t.length>0&&e.push({phase:e.length+1,name:"Core Architecture & Critical Features",_routing:"opus",_rationale:"Critical architecture decisions and foundational code require deep reasoning.",tasks:t.map(r=>r.text),priority:"critical"}),s.length>0&&e.push({phase:e.length+1,name:"Primary Features",_routing:"standard",_rationale:"Well-defined feature implementation â€” clear requirements, standard patterns.",tasks:s.map(r=>r.text),priority:"high"}),n.length>0&&e.push({phase:e.length+1,name:"Secondary Features",_routing:"standard",_rationale:"Standard implementation work with clear specs.",tasks:n.map(r=>r.text),priority:"medium"}),o.length>0&&e.push({phase:e.length+1,name:"Enhancement & Polish",_routing:"flash",_rationale:"Polish tasks are mostly mechanical â€” formatting, minor tweaks, cleanup.",tasks:o.map(r=>r.text),priority:"low"}),e.push({phase:e.length+1,name:"QA, Security Review & Documentation",_routing:"opus",_rationale:"Security audits, threat modeling, and final review demand the highest reasoning capability.",tasks:["Devil's advocate full review pass","Security audit of auth flows and data access","Performance review and optimization","Final documentation and README update",...i.risk.length>0?["Address identified risks: "+i.risk.map(r=>r.text).join(", ")]:[]]}),e}function So(i){const e=[`A working ${i.projectName} application implementing all defined features.`,"Clearly structured components implementing the primary user journeys.","Basic test coverage or smoke-test scripts for critical paths."],t=["/docs/architecture.md describing overall system design, data models, and main flows.","/docs/backend.md covering backend configuration, rules, and deployment notes.","/docs/tech-journal.md logging decisions, alternatives considered, and links to external references.","Updated root README with setup steps, environment configuration, and run/build commands."],s=["Devil's advocate review notes integrated or explicitly deferred with justification.","No hard-coded secrets or tokens in the repo.","Auth flows and data access reviewed for least-privilege access and common abuse cases."];return i.constraint.length>0&&s.push(`Verified compliance with constraints: ${i.constraint.map(n=>n.text).join("; ")}`),{code:e,documentation:t,quality_and_security:s}}function To(i){const e=["Follow the existing project conventions where present; otherwise adopt widely accepted idioms for the chosen framework.","Write self-documenting code with meaningful names and minimal inline comments that add real value."];return i.constraint.length>0&&i.constraint.forEach(t=>{e.push(`CONSTRAINT: ${t.text}`)}),{coding_style:e,autonomy:["Default to acting autonomously within these instructions; only pause for user input when a decision is irreversible, high-impact, or ambiguous.","Use internal virtual roles as mental modes; you do not need to expose role-swap chatter unless it clarifies reasoning for the user."]}}function mn(i){const e=[...i.feature.map(t=>t.text),...i.constraint.map(t=>t.text),...i.techNote.map(t=>t.text),...i.reference.map(t=>t.text)].join(" ").toLowerCase();return/react|next\.?js|jsx/i.test(e)?"React / Next.js":/vue|nuxt/i.test(e)?"Vue / Nuxt":/flutter|dart/i.test(e)?"Flutter / Dart":/firebase/i.test(e)?"Firebase-backed web app":/python|django|flask/i.test(e)?"Python":/node|express/i.test(e)?"Node.js / Express":"Determine from existing project files or ask user"}function Ao(i,e){var o;const t=new Date().toISOString().split("T")[0];let s="";s+=`# ${e.projectName} â€” Workflow Prompt

`,s+=`> Generated by MindMapper on ${t}
`,s+=`> Mind map: ${e.stats.totalNodes} nodes, ${e.stats.totalConnections} connections

`,e.ceoVision&&(s+=`## CEO Vision

`,s+=`${e.ceoVision}

`),s+=`## Task Definition

`,s+=`Paste the JSON below into Claude Code (Opus 4.6 thinking mode) to execute this workflow.

`,s+="```json\n",s+=JSON.stringify(i,null,2),s+="\n```\n\n",s+=`## Mind Map Summary

`,e.feature.length>0&&(s+=`### Features (${e.feature.length})

`,e.feature.forEach(r=>{const a=r.priority!=="medium"?` [${r.priority.toUpperCase()}]`:"";s+=`- ${r.text}${a}
`}),s+=`
`),e.constraint.length>0&&(s+=`### Constraints (${e.constraint.length})

`,e.constraint.forEach(r=>{s+=`- ðŸ”’ ${r.text}
`}),s+=`
`),e.risk.length>0&&(s+=`### Risks (${e.risk.length})

`,e.risk.forEach(r=>{s+=`- âš ï¸ ${r.text} [${r.priority}]
`}),s+=`
`),e.techNote.length>0&&(s+=`### Technical Notes

`,e.techNote.forEach(r=>{s+=`- ðŸ”§ ${r.text}
`}),s+=`
`),e.dependencies.length>0&&(s+=`### Dependency Graph

`,e.dependencies.forEach(r=>{const a=r.directed?"â†’":"â†”";s+=`- ${r.from.text} ${a} ${r.to.text}
`}),s+=`
`),e.executionOrder.length>0&&(s+=`### Execution Order (Topological)

`,e.executionOrder.forEach((r,a)=>{r.text&&(s+=`${a+1}. ${r.text} *(${r.type}, ${r.priority})*
`)}),s+=`
`);const n=((o=i.execution_strategy)==null?void 0:o.milestones)||[];return n.length>0&&(s+=`## Milestone Plan

`,n.forEach(r=>{s+=`### Phase ${r.phase}: ${r.name}

`,r.tasks.forEach(a=>{s+=`- [ ] ${a}
`}),s+=`
`})),s+=`---

`,s+=`*This prompt was generated from a MindMapper mind map. Copy the JSON task definition above and paste it into Claude Code to execute the workflow.*
`,s}function Io(i,e={}){const t=e.model||"claude-4.6",s=e.mode||"planning",n=e.stack||mn(i);return fn(i,{model:t,mode:s,stack:n,...e})}class Co{constructor(e,t,s){this.bus=e,this._getNodes=t,this._getConnections=s,this._currentPrompt="",this._currentJSON=null,this._serializedData=null,this._createDOM(),this._bindEvents()}_createDOM(){this.overlay=document.createElement("div"),this.overlay.id="prompt-export-overlay",this.overlay.className="prompt-export-overlay",this.overlay.innerHTML=`
      <div class="prompt-export-modal glass-panel" id="prompt-export-modal">
        <!-- Header -->
        <div class="prompt-export-header">
          <div class="export-header-left">
            <span class="export-icon">ðŸš€</span>
            <h2 class="export-title">Generate Workflow Prompt</h2>
          </div>
          <button class="prompt-export-close" id="prompt-export-close" title="Close">âœ•</button>
        </div>

        <!-- Inputs Row -->
        <div class="prompt-export-inputs">
          <div class="export-input-group">
            <label class="export-label" for="export-project-name">Project Name</label>
            <input type="text" id="export-project-name" class="export-input" placeholder="My Awesome Project" />
          </div>
          <div class="export-input-group full-width">
            <label class="export-label" for="export-ceo-vision">CEO Vision <span class="label-hint">(Describe your concept in 1-3 sentences)</span></label>
            <textarea id="export-ceo-vision" class="export-textarea" rows="2" placeholder="An AI-powered platform that..."></textarea>
          </div>
        </div>

        <!-- Body: Stats + Preview -->
        <div class="prompt-export-body">
          <!-- Stats Sidebar -->
          <div class="export-stats" id="export-stats">
            <h4 class="stats-title">Mind Map Analysis</h4>
            <div class="stats-grid" id="stats-grid"></div>
          </div>

          <!-- Preview -->
          <div class="export-preview-wrap">
            <div class="preview-toolbar">
              <span class="preview-label">ðŸ“„ Prompt Preview</span>
              <div class="preview-actions">
                <button class="export-btn small" id="btn-regenerate" title="Regenerate">ðŸ”„ Regenerate</button>
              </div>
            </div>
            <pre class="export-preview" id="export-preview"></pre>
          </div>
        </div>

        <!-- Footer Actions -->
        <div class="prompt-export-footer">
          <div class="export-footer-left">
            <span class="export-char-count" id="export-char-count">0 chars</span>
          </div>
          <div class="export-footer-right">
            <button class="export-btn" id="btn-copy-json" title="Copy just the JSON task definition">
              ðŸ“‹ Copy JSON Only
            </button>
            <button class="export-btn" id="btn-download-md" title="Download as .md file">
              ðŸ’¾ Download .md
            </button>
            <button class="export-btn primary" id="btn-copy-full" title="Copy the full markdown prompt to clipboard">
              ðŸ“‹ Copy Full Prompt
            </button>
          </div>
        </div>
      </div>
    `,document.body.appendChild(this.overlay)}_bindEvents(){this.overlay.querySelector("#prompt-export-close").addEventListener("click",()=>this.hide()),this.overlay.addEventListener("click",s=>{s.target===this.overlay&&this.hide()}),this.overlay.querySelector("#btn-regenerate").addEventListener("click",()=>this._generate()),this.overlay.querySelector("#btn-copy-full").addEventListener("click",()=>{this._copyToClipboard(this._currentPrompt,"Full prompt copied to clipboard!")}),this.overlay.querySelector("#btn-copy-json").addEventListener("click",()=>{const s=JSON.stringify(this._currentJSON,null,2);this._copyToClipboard(s,"JSON task definition copied to clipboard!")}),this.overlay.querySelector("#btn-download-md").addEventListener("click",()=>{this._downloadFile()}),window.addEventListener("keydown",s=>{s.key==="Escape"&&this.overlay.classList.contains("visible")&&this.hide()});let e=null;[this.overlay.querySelector("#export-project-name"),this.overlay.querySelector("#export-ceo-vision")].forEach(s=>{s.addEventListener("input",()=>{clearTimeout(e),e=setTimeout(()=>this._generate(),500)})})}show(){this.overlay.classList.add("visible");const e=this.overlay.querySelector("#prompt-export-modal");requestAnimationFrame(()=>e.classList.add("visible")),this._generate()}hide(){this.overlay.querySelector("#prompt-export-modal").classList.remove("visible"),setTimeout(()=>this.overlay.classList.remove("visible"),250)}_generate(){const e=this._getNodes(),t=this._getConnections(),s=this.overlay.querySelector("#export-project-name").value.trim(),n=this.overlay.querySelector("#export-ceo-vision").value.trim();this._serializedData=pn(e,t,{projectName:s,ceoVision:n}),this._currentPrompt=gn(this._serializedData),this._currentJSON=Io(this._serializedData),this._renderPreview(),this._renderStats();const o=this.overlay.querySelector("#export-project-name");!o.value.trim()&&this._serializedData.projectName!=="Untitled Project"&&(o.value=this._serializedData.projectName)}_renderPreview(){const e=this.overlay.querySelector("#export-preview");e.textContent=this._currentPrompt;const t=this.overlay.querySelector("#export-char-count");t.textContent=`${this._currentPrompt.length.toLocaleString()} chars Â· ~${Math.ceil(this._currentPrompt.length/4).toLocaleString()} tokens`}_renderStats(){const e=this._serializedData;if(!e)return;const t=this.overlay.querySelector("#stats-grid");t.innerHTML=`
      <div class="stat-item">
        <span class="stat-value">${e.stats.totalNodes}</span>
        <span class="stat-label">Nodes</span>
      </div>
      <div class="stat-item">
        <span class="stat-value">${e.stats.totalConnections}</span>
        <span class="stat-label">Connections</span>
      </div>
      <div class="stat-item accent">
        <span class="stat-value">${e.stats.featureCount}</span>
        <span class="stat-label">Features</span>
      </div>
      <div class="stat-item warn">
        <span class="stat-value">${e.stats.constraintCount}</span>
        <span class="stat-label">Constraints</span>
      </div>
      <div class="stat-item danger">
        <span class="stat-value">${e.stats.riskCount}</span>
        <span class="stat-label">Risks</span>
      </div>
      <div class="stat-item">
        <span class="stat-value">${e.stats.referenceCount}</span>
        <span class="stat-label">References</span>
      </div>
      <div class="stat-item">
        <span class="stat-value">${e.stats.directedConnections}</span>
        <span class="stat-label">Dependencies</span>
      </div>
      <div class="stat-item ${e.stats.criticalCount>0?"danger":""}">
        <span class="stat-value">${e.stats.criticalCount}</span>
        <span class="stat-label">Critical</span>
      </div>
    `}async _copyToClipboard(e,t){try{await navigator.clipboard.writeText(e),this._showToast(t)}catch{const n=document.createElement("textarea");n.value=e,n.style.position="fixed",n.style.opacity="0",document.body.appendChild(n),n.select(),document.execCommand("copy"),document.body.removeChild(n),this._showToast(t)}}_downloadFile(){var o;const e=(((o=this._serializedData)==null?void 0:o.projectName)||"workflow-prompt").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/-+$/,""),t=new Blob([this._currentPrompt],{type:"text/markdown"}),s=URL.createObjectURL(t),n=document.createElement("a");n.href=s,n.download=`${e}-workflow.md`,n.click(),URL.revokeObjectURL(s),this._showToast("Downloaded!")}_showToast(e){const t=document.querySelector(".export-toast");t&&t.remove();const s=document.createElement("div");s.className="export-toast",s.innerHTML=`<span>âœ… ${e}</span>`,document.body.appendChild(s),requestAnimationFrame(()=>s.classList.add("visible")),setTimeout(()=>{s.classList.remove("visible"),setTimeout(()=>s.remove(),300)},2e3)}}const Pt=`You are an expert product strategist and systems architect. 
Given a high-level product concept, you will decompose it into a structured mind map.

Your output must be a valid JSON object (no markdown, no code fences, just raw JSON) with this exact structure:

{
  "projectName": "Short project name",
  "nodes": [
    {
      "text": "Node label text",
      "type": "general|feature|constraint|risk|reference|techNote",
      "priority": "critical|high|medium|low"
    }
  ],
  "connections": [
    { "from": 0, "to": 1, "directed": true }
  ]
}

Rules:
1. The FIRST node (index 0) should be the project's core concept â€” type "general", priority "critical".
2. Generate 12-20 nodes that thoroughly decompose the concept.
3. Use ALL node types thoughtfully:
   - "feature" â€” Core capabilities and user-facing functionality
   - "constraint" â€” Technical limitations, business rules, must-haves
   - "risk" â€” Potential problems, pitfalls, security concerns
   - "reference" â€” External services, APIs, technologies to research
   - "techNote" â€” Architecture decisions, implementation notes
   - "general" â€” Grouping concepts, categories, themes
4. Assign priorities realistically: only 1-3 items should be "critical", most should be "high" or "medium".
5. CONNECTIONS MUST FORM A TREE â€” each non-root node must have EXACTLY ONE parent connection pointing TO it.
   The root node (index 0) should connect to 3-6 top-level category nodes. Those category nodes connect to their children, and so on.
   Do NOT create cross-connections, cycles, or multiple parents for a single node.
   Set "directed": true and always use "from": parent, "to": child.
6. Total connections should equal (number of nodes âˆ’ 1), forming a clean hierarchy.
7. Keep node text concise (2-6 words typically, max 10 words).
8. Think like a startup CTO planning the architecture and a product manager defining the roadmap.
   Organize into 3-6 top-level branches (e.g. "Core Features", "Security", "Integration", "UX", "Infrastructure").

Respond with ONLY the JSON object, nothing else.`,yn={google:{name:"Google",models:["gemini-2.0-flash-lite","gemini-2.5-flash-lite","gemini-2.0-flash","gemini-2.5-flash","gemini-3-flash","gemini-2.5-pro","gemini-3-pro"],defaultModel:"gemini-2.0-flash-lite",buildRequest:(i,e,t)=>({url:`https://generativelanguage.googleapis.com/v1beta/models/${e}:generateContent`,headers:{"Content-Type":"application/json","x-goog-api-key":i},body:JSON.stringify({contents:[{role:"user",parts:[{text:`${Pt}

Product concept: ${t}`}]}],generationConfig:{temperature:.7,maxOutputTokens:2e3,responseMimeType:"application/json"}})}),parseResponse:i=>{var t,s,n,o,r;const e=(r=(o=(n=(s=(t=i.candidates)==null?void 0:t[0])==null?void 0:s.content)==null?void 0:n.parts)==null?void 0:o[0])==null?void 0:r.text;if(!e)throw new Error("No response content from Google");return JSON.parse(e)}},openai:{name:"OpenAI",models:["gpt-4o-mini","gpt-4.1-mini","gpt-4o","gpt-4.1","o3-mini","o4-mini","o3","gpt-5"],defaultModel:"gpt-4o-mini",endpoint:"https://api.openai.com/v1/chat/completions",buildRequest:(i,e,t)=>({url:"https://api.openai.com/v1/chat/completions",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({model:e,messages:[{role:"system",content:Pt},{role:"user",content:`Product concept: ${t}`}],temperature:.7,max_tokens:2e3,response_format:{type:"json_object"}})}),parseResponse:i=>{var t,s,n;const e=(n=(s=(t=i.choices)==null?void 0:t[0])==null?void 0:s.message)==null?void 0:n.content;if(!e)throw new Error("No response content from OpenAI");return JSON.parse(e)}},anthropic:{name:"Anthropic",models:["claude-3-haiku-20240307","claude-3-5-haiku-20241022","claude-haiku-4-5-20251001","claude-3-5-sonnet-20241022","claude-sonnet-4-20250514","claude-sonnet-4-5-20250929","claude-opus-4-20250514","claude-opus-4-1-20250805","claude-opus-4-6"],defaultModel:"claude-3-haiku-20240307",endpoint:"https://api.anthropic.com/v1/messages",buildRequest:(i,e,t)=>({url:"https://api.anthropic.com/v1/messages",headers:{"Content-Type":"application/json","x-api-key":i,"anthropic-version":"2023-06-01","anthropic-dangerous-direct-browser-access":"true"},body:JSON.stringify({model:e,max_tokens:2e3,system:Pt,messages:[{role:"user",content:`Product concept: ${t}`}]})}),parseResponse:i=>{var t,s;const e=(s=(t=i.content)==null?void 0:t[0])==null?void 0:s.text;if(!e)throw new Error("No response content from Anthropic");return JSON.parse(e)}}};async function Mo(i,e={}){var h;const{provider:t,apiKey:s,model:n}=e;if(!(i!=null&&i.trim()))throw new Error("Please enter a product concept.");if(!(s!=null&&s.trim()))throw new Error("Please enter your API key.");const o=yn[t];if(!o)throw new Error(`Unknown provider: ${t}`);const r=n||o.defaultModel,a=o.buildRequest(s,r,i.trim()),c=await fetch(a.url,{method:"POST",headers:a.headers,body:a.body});if(!c.ok){const g=await c.text().catch(()=>"Unknown error");let u;try{u=JSON.parse(g)}catch{u=null}const f=((h=u==null?void 0:u.error)==null?void 0:h.message)||g;throw new Error(`API error (${c.status}): ${f}`)}const l=await c.json(),p=o.parseResponse(l);return Po(p)}function qs(){return Object.entries(yn).map(([i,e])=>({key:i,name:e.name,models:e.models,defaultModel:e.defaultModel}))}function Po(i){if(!i||typeof i!="object")throw new Error("Invalid response: not an object");const e=i.projectName||"Generated Project";if(!Array.isArray(i.nodes)||i.nodes.length===0)throw new Error("Invalid response: missing or empty nodes array");const t=new Set(["general","feature","constraint","risk","reference","techNote"]),s=new Set(["critical","high","medium","low"]),n=i.nodes.map((r,a)=>({text:String(r.text||`Node ${a+1}`).trim(),type:t.has(r.type)?r.type:"general",priority:s.has(r.priority)?r.priority:"medium"})),o=[];return Array.isArray(i.connections)&&i.connections.forEach(r=>{const a=parseInt(r.from,10),c=parseInt(r.to,10);!isNaN(a)&&!isNaN(c)&&a>=0&&a<n.length&&c>=0&&c<n.length&&a!==c&&o.push({from:a,to:c,directed:r.directed!==!1})}),{projectName:e,nodes:n,connections:o}}function bn(i,e,t=0,s=0){if(i.length===0)return i;const n=i.length,o=i.map(k=>({...k,x:0,y:0})),r=new Map;i.forEach((k,T)=>r.set(T,new Set)),e.forEach(k=>{var T,H;(T=r.get(k.from))==null||T.add(k.to),(H=r.get(k.to))==null||H.add(k.from)});const a=new Map,c=new Set,l=[0];for(c.add(0),a.set(0,[]);l.length>0;){const k=l.shift();for(const T of r.get(k)||[])c.has(T)||(c.add(T),a.has(k)||a.set(k,[]),a.get(k).push(T),a.has(T)||a.set(T,[]),l.push(T))}const p={general:0,feature:1,techNote:2,constraint:3,reference:4,risk:5};for(const[,k]of a)k.sort((T,H)=>(p[i[T].type]??6)-(p[i[H].type]??6));const h=new Map;function g(k){const T=a.get(k)||[];if(T.length===0)return h.set(k,1),1;let H=0;for(const pe of T)H+=g(pe);return h.set(k,H),H}g(0);const u=320,f=90,m=56,b=a.get(0)||[],E=[],S=[],D=[...b].sort((k,T)=>(h.get(T)||0)-(h.get(k)||0));let C=0,j=0;for(const k of D){const T=h.get(k)||1;C<=j?(E.push(k),C+=T):(S.push(k),j+=T)}E.sort((k,T)=>b.indexOf(k)-b.indexOf(T)),S.sort((k,T)=>b.indexOf(k)-b.indexOf(T));function L(k,T,H,pe){const ee=a.get(k)||[];if(ee.length===0)return o[k].x=T,o[k].y=H,m+f;const me=T+pe*u;let Ee=H;const O=[];for(const Le of ee){const $=L(Le,me,Ee,pe);O.push({y:o[Le].y,extent:$}),Ee+=$}const Ye=O[0].y,F=O[O.length-1].y;return o[k].x=T,o[k].y=(Ye+F)/2,Ee-H}const ae=E.reduce((k,T)=>k+(h.get(T)||1),0)*(m+f);let we=s-ae/2;for(const k of E){const T=L(k,t-u,we,-1);we+=T}const q=S.reduce((k,T)=>k+(h.get(T)||1),0)*(m+f);let ke=s-q/2;for(const k of S){const T=L(k,t+u,ke,1);ke+=T}o[0].x=t,o[0].y=s;const ue=[];for(let k=0;k<n;k++)c.has(k)||ue.push(k);if(ue.length>0){const k=o.filter((ee,me)=>c.has(me)).map(ee=>ee.y),T=Math.max(...k)+200,H=ue.length*240,pe=t-H/2;ue.forEach((ee,me)=>{o[ee].x=pe+me*240+120,o[ee].y=T})}return o}const Lo=["An AI-powered personal finance app that learns spending habits and automates savings","A collaborative whiteboard tool for remote teams with real-time AI suggestions","A sustainability tracking platform for small businesses to measure carbon footprint","An AR-powered interior design app that lets you visualize furniture before buying","A micro-learning platform that creates custom 5-minute daily lessons from any textbook","A neighborhood safety app with community alerts and AI-analyzed incident patterns","An AI code review tool that learns your team's coding standards and enforces them","A health & wellness marketplace connecting users with verified holistic practitioners"];class No{constructor(e,t,s){this.bus=e,this.nodeManager=t,this.connectionManager=s,this._generating=!1,this._createDOM(),this._bindEvents(),this._loadSavedSettings()}_createDOM(){this.overlay=document.createElement("div"),this.overlay.id="idea-input-overlay",this.overlay.className="idea-input-overlay";const t=qs().map(s=>`<option value="${s.key}">${s.name}</option>`).join("");this.overlay.innerHTML=`
      <div class="idea-input-modal glass-panel" id="idea-input-modal">
        <!-- Header -->
        <div class="idea-input-header">
          <div class="idea-header-left">
            <span class="idea-icon">âœ¨</span>
            <h2 class="idea-title">Generate Mind Map from Concept</h2>
          </div>
          <button class="idea-input-close" id="idea-input-close" title="Close">âœ•</button>
        </div>

        <!-- Body -->
        <div class="idea-input-body">
          <!-- Left: Input Area -->
          <div class="idea-input-area">
            <label class="idea-label" for="idea-concept">Your Product Concept</label>
            <textarea
              id="idea-concept"
              class="idea-concept-input"
              rows="4"
              placeholder="Describe your product idea in 1-3 sentences...&#10;&#10;e.g. An AI-powered recipe app that learns your dietary preferences and generates meal plans with auto-generated grocery lists"
              maxlength="500"
            ></textarea>
            <div class="idea-concept-meta">
              <span id="idea-char-count" class="idea-char-count">0/500</span>
            </div>

            <!-- Provider & Key Row -->
            <div class="idea-config-row">
              <div class="idea-config-group">
                <label class="idea-label-sm" for="idea-provider">LLM Provider</label>
                <select id="idea-provider" class="idea-select">
                  ${t}
                </select>
              </div>
              <div class="idea-config-group grow">
                <label class="idea-label-sm" for="idea-api-key">API Key</label>
                <div class="idea-key-wrap">
                  <input type="password" id="idea-api-key" class="idea-key-input" placeholder="sk-..." />
                  <button id="idea-key-toggle" class="idea-key-toggle" title="Show/hide key">ðŸ‘ï¸</button>
                </div>
              </div>
            </div>

            <!-- Model Selection -->
            <div class="idea-config-row">
              <div class="idea-config-group grow">
                <label class="idea-label-sm" for="idea-model">Model</label>
                <select id="idea-model" class="idea-select"></select>
              </div>
              <div class="idea-config-group">
                <label class="idea-label-sm">&nbsp;</label>
                <label class="idea-checkbox-label">
                  <input type="checkbox" id="idea-clear-canvas" checked />
                  <span>Clear canvas first</span>
                </label>
              </div>
            </div>

            <!-- Error Display -->
            <div id="idea-error" class="idea-error" style="display: none"></div>

            <!-- Generate Button -->
            <button id="idea-generate-btn" class="idea-generate-btn">
              <span class="gen-icon">âš¡</span>
              <span class="gen-text">Generate Mind Map</span>
            </button>
          </div>

          <!-- Right: Inspiration Panel -->
          <div class="idea-inspiration">
            <h4 class="inspiration-title">ðŸ’¡ Need Inspiration?</h4>
            <p class="inspiration-subtitle">Click a concept to use it:</p>
            <div class="inspiration-list" id="inspiration-list"></div>
          </div>
        </div>

        <!-- Loading Overlay -->
        <div class="idea-loading" id="idea-loading" style="display: none">
          <div class="idea-loading-inner">
            <div class="idea-spinner"></div>
            <p class="idea-loading-text">Generating your mind map...</p>
            <p class="idea-loading-sub">The AI is decomposing your concept into features, constraints, and risks</p>
          </div>
        </div>
      </div>
    `,document.body.appendChild(this.overlay),this._populateExamples()}_bindEvents(){this.overlay.querySelector("#idea-input-close").addEventListener("click",()=>this.hide()),this.overlay.addEventListener("click",r=>{r.target===this.overlay&&this.hide()}),this._escHandler=r=>{r.key==="Escape"&&this.overlay.classList.contains("visible")&&this.hide()},window.addEventListener("keydown",this._escHandler);const e=this.overlay.querySelector("#idea-concept"),t=this.overlay.querySelector("#idea-char-count");e.addEventListener("input",()=>{t.textContent=`${e.value.length}/500`}),this.overlay.querySelector("#idea-provider").addEventListener("change",()=>{this._updateModels(),this._loadKeyForProvider()});const n=this.overlay.querySelector("#idea-key-toggle"),o=this.overlay.querySelector("#idea-api-key");n.addEventListener("click",()=>{o.type=o.type==="password"?"text":"password",n.textContent=o.type==="password"?"ðŸ‘ï¸":"ðŸ”’"}),o.addEventListener("blur",()=>{this._saveKeyForProvider()}),this.overlay.querySelector("#idea-generate-btn").addEventListener("click",()=>this._generate()),e.addEventListener("keydown",r=>{r.ctrlKey&&r.key==="Enter"&&(r.preventDefault(),this._generate())})}show(){this.overlay.classList.add("visible");const e=this.overlay.querySelector("#idea-input-modal");requestAnimationFrame(()=>e.classList.add("visible")),setTimeout(()=>{this.overlay.querySelector("#idea-concept").focus()},300)}hide(){if(this._generating)return;this.overlay.querySelector("#idea-input-modal").classList.remove("visible"),setTimeout(()=>this.overlay.classList.remove("visible"),250)}async _generate(){if(this._generating)return;const e=this.overlay.querySelector("#idea-concept").value.trim(),t=this.overlay.querySelector("#idea-provider").value,s=this.overlay.querySelector("#idea-api-key").value.trim(),n=this.overlay.querySelector("#idea-model").value,o=this.overlay.querySelector("#idea-clear-canvas").checked;if(!e){this._showError("Please enter a product concept.");return}if(!s){this._showError("Please enter your API key.");return}this._saveKeyForProvider(),this._setLoading(!0),this._hideError();try{const r=await Mo(e,{provider:t,apiKey:s,model:n}),a=this._getViewportCenter(),c=bn(r.nodes,r.connections,a.x,a.y);o&&(this.nodeManager.deserialize([]),this.connectionManager.deserialize([]));const l=this._renderNodes(c);this._renderConnections(r.connections,l),this.bus.emit("state:changed"),setTimeout(()=>this.bus.emit("viewport:fit-request"),100),this._setLoading(!1),this.hide(),this._showToast(`âœ¨ Generated ${c.length} nodes from your concept!`)}catch(r){this._setLoading(!1),this._showError(r.message||"Generation failed. Please try again."),console.error("[IdeaGenerator] Error:",r)}}_renderNodes(e){const t=[];return e.forEach(s=>{const n=this.nodeManager.createNode(Math.round(s.x-70),Math.round(s.y-20),{text:s.text});s.type&&this.nodeManager.setNodeType(n.id,s.type),s.priority&&this.nodeManager.setPriority(n.id,s.priority),t.push(n.id)}),t}_renderConnections(e,t){e.forEach(s=>{const n=t[s.from],o=t[s.to];if(!n||!o)return;const r=this.nodeManager.getNode(n),a=this.nodeManager.getNode(o);if(!r||!a)return;const c=a.x-r.x,l=a.y-r.y;let p,h;Math.abs(c)>Math.abs(l)?(p=c>0?"right":"left",h=c>0?"left":"right"):(p=l>0?"bottom":"top",h=l>0?"top":"bottom"),this.connectionManager.createConnection(n,p,o,h,{directed:s.directed?"forward":"none"})})}_getViewportCenter(){const e=document.getElementById("canvas-container");if(!e)return{x:400,y:300};const t=e.getBoundingClientRect();return this.nodeManager.viewport.screenToWorld(t.width/2,t.height/2)}_populateExamples(){const e=this.overlay.querySelector("#inspiration-list");Lo.forEach(t=>{const s=document.createElement("button");s.className="inspiration-pill",s.textContent=t,s.addEventListener("click",()=>{this.overlay.querySelector("#idea-concept").value=t,this.overlay.querySelector("#idea-char-count").textContent=`${t.length}/500`,this.overlay.querySelector(".idea-input-area").scrollTop=0}),e.appendChild(s)})}_loadSavedSettings(){const e=localStorage.getItem("mm_ai_provider")||"openai",t=this.overlay.querySelector("#idea-provider");t.value=e,this._updateModels(),this._loadKeyForProvider()}_updateModels(){const e=this.overlay.querySelector("#idea-provider").value,s=qs().find(o=>o.key===e),n=this.overlay.querySelector("#idea-model");n.innerHTML="",s&&s.models.forEach(o=>{const r=document.createElement("option");r.value=o,r.textContent=o,o===s.defaultModel&&(r.selected=!0),n.appendChild(r)}),localStorage.setItem("mm_ai_provider",e)}_loadKeyForProvider(){const e=this.overlay.querySelector("#idea-provider").value,t=localStorage.getItem(`mm_ai_key_${e}`)||"";this.overlay.querySelector("#idea-api-key").value=t}_saveKeyForProvider(){const e=this.overlay.querySelector("#idea-provider").value,t=this.overlay.querySelector("#idea-api-key").value;t&&localStorage.setItem(`mm_ai_key_${e}`,t)}_setLoading(e){this._generating=e;const t=this.overlay.querySelector("#idea-loading"),s=this.overlay.querySelector("#idea-generate-btn");t.style.display=e?"flex":"none",s.disabled=e,e?(s.querySelector(".gen-text").textContent="Generating...",s.classList.add("generating")):(s.querySelector(".gen-text").textContent="Generate Mind Map",s.classList.remove("generating"))}_showError(e){const t=this.overlay.querySelector("#idea-error");t.textContent=`âš ï¸ ${e}`,t.style.display="block"}_hideError(){this.overlay.querySelector("#idea-error").style.display="none"}_showToast(e){const t=document.querySelector(".export-toast");t&&t.remove();const s=document.createElement("div");s.className="export-toast",s.innerHTML=`<span>${e}</span>`,document.body.appendChild(s),requestAnimationFrame(()=>s.classList.add("visible")),setTimeout(()=>{s.classList.remove("visible"),setTimeout(()=>s.remove(),300)},3e3)}}const $o="modulepreload",Ro=function(i){return"/"+i},Us={},ge=function(e,t,s){let n=Promise.resolve();if(t&&t.length>0){let r=function(l){return Promise.all(l.map(p=>Promise.resolve(p).then(h=>({status:"fulfilled",value:h}),h=>({status:"rejected",reason:h}))))};document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),c=(a==null?void 0:a.nonce)||(a==null?void 0:a.getAttribute("nonce"));n=r(t.map(l=>{if(l=Ro(l),l in Us)return;Us[l]=!0;const p=l.endsWith(".css"),h=p?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${h}`))return;const g=document.createElement("link");if(g.rel=p?"stylesheet":$o,p||(g.as="script"),g.crossOrigin="",g.href=l,c&&g.setAttribute("nonce",c),document.head.appendChild(g),p)return new Promise((u,f)=>{g.addEventListener("load",u),g.addEventListener("error",()=>f(new Error(`Unable to preload CSS for ${l}`)))})}))}function o(r){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=r,window.dispatchEvent(a),!a.defaultPrevented)throw r}return n.then(r=>{for(const a of r||[])a.status==="rejected"&&o(a.reason);return e().catch(o)})};class Z{static get isTauri(){return!!window.__TAURI_INTERNALS__}static get isBrowser(){return!Z.isTauri}static get platform(){return Z.isTauri?"desktop":"browser"}static get capabilities(){return Z.isTauri?{subprocess:!0,secureStore:!0,nativeDialogs:!0,fileSystem:!0}:{subprocess:!1,secureStore:!1,nativeDialogs:!1,fileSystem:!1}}static requireDesktop(e){if(!Z.isTauri)throw new Error(`"${e}" requires the MindMapper desktop app. This feature is not available in the browser.`)}}class Oo{constructor(e){this._bus=e,this._sessionId=null,this._unlisteners=[],this._status="idle"}async detectCLI(){if(!Z.isTauri)return{installed:!1,error:"Not running in desktop mode"};const{invoke:e}=await ge(async()=>{const{invoke:t}=await import("./core-DhEqZVGG.js");return{invoke:t}},[]);return e("detect_claude_cli")}async execute(e,t={}){if(Z.requireDesktop("Claude Code execution"),this._status==="running")throw new Error("A Claude Code session is already running. Cancel it first.");this._status="starting",await this._attachListeners();try{const{invoke:s}=await ge(async()=>{const{invoke:o}=await import("./core-DhEqZVGG.js");return{invoke:o}},[]),n=await s("spawn_claude",{prompt:e,outputDir:t.outputDir||".",model:t.model||null,handsOff:t.handsOff||!1});return this._sessionId=n.sessionId,this._status="running",this._bus.emit("orchestration:started",{sessionId:n.sessionId,pid:n.pid}),n}catch(s){throw this._status="failed",this._bus.emit("orchestration:error",{message:s.toString(),phase:"spawn"}),this._detachListeners(),s}}async cancel(){if(this._status!=="running"&&this._status!=="starting")return{cancelled:!1,reason:"No active session"};const{invoke:e}=await ge(async()=>{const{invoke:s}=await import("./core-DhEqZVGG.js");return{invoke:s}},[]),t=await e("cancel_claude");return t.cancelled&&(this._status="cancelled",this._bus.emit("orchestration:cancel",{sessionId:this._sessionId}),this._detachListeners()),t}getStatus(){return this._status}async getApiKey(e="anthropic"){if(!Z.isTauri)return null;const{invoke:t}=await ge(async()=>{const{invoke:n}=await import("./core-DhEqZVGG.js");return{invoke:n}},[]);return(await t("get_api_key",{provider:e})).key??null}async setApiKey(e,t="anthropic"){if(!Z.isTauri)return!1;const{invoke:s}=await ge(async()=>{const{invoke:o}=await import("./core-DhEqZVGG.js");return{invoke:o}},[]);return(await s("set_api_key",{provider:t,key:e})).saved}async _attachListeners(){const{listen:e}=await ge(async()=>{const{listen:r}=await import("./event-0KKzhgIB.js");return{listen:r}},__vite__mapDeps([0,1])),t=await e("claude:progress",r=>{var c;const a=r.payload;this._bus.emit("orchestration:progress",{sessionId:a.sessionId,type:a.type,data:a.data}),a.type==="json"&&((c=a.data)==null?void 0:c.type)==="tool_use_permission"&&this._bus.emit("orchestration:approval-needed",{sessionId:a.sessionId,tool:a.data.tool,input:a.data.input})}),s=await e("claude:error",r=>{this._bus.emit("orchestration:error",{sessionId:r.payload.sessionId,message:r.payload.message,phase:"runtime"})}),n=await e("claude:complete",r=>{const a=r.payload;this._status=a.success?"completed":"failed",this._bus.emit("orchestration:complete",{sessionId:a.sessionId,exitCode:a.exitCode,success:a.success}),this._detachListeners()}),o=await e("claude:started",r=>{this._sessionId=r.payload.sessionId});this._unlisteners=[t,s,n,o]}_detachListeners(){this._unlisteners.forEach(e=>e()),this._unlisteners=[]}destroy(){this._detachListeners(),this._status="idle",this._sessionId=null}}const js=50,Hs="mindmapper_sessions";class Do{constructor(){this._cache=null}async list(){return[...await this._load()].sort((t,s)=>s.startedAt-t.startedAt)}async get(e){return(await this._load()).find(s=>s.sessionId===e)||null}async save(e){const t=await this._load(),s=t.findIndex(n=>n.sessionId===e.sessionId);s>=0?t[s]={...t[s],...e}:t.push(e),t.length>js&&(t.sort((n,o)=>o.startedAt-n.startedAt),t.length=js),await this._persist(t),this._cache=t}async remove(e){let t=await this._load();t=t.filter(s=>s.sessionId!==e),await this._persist(t),this._cache=t}async clear(){await this._persist([]),this._cache=[]}async _load(){if(this._cache)return this._cache;try{if(Z.isTauri){const{invoke:e}=await ge(async()=>{const{invoke:s}=await import("./core-DhEqZVGG.js");return{invoke:s}},[]),t=await e("get_api_key",{provider:"_sessions"});this._cache=t.key?JSON.parse(t.key):[]}else{const e=localStorage.getItem(Hs);this._cache=e?JSON.parse(e):[]}}catch{this._cache=[]}return this._cache}async _persist(e){try{if(Z.isTauri){const{invoke:t}=await ge(async()=>{const{invoke:s}=await import("./core-DhEqZVGG.js");return{invoke:s}},[]);await t("set_api_key",{provider:"_sessions",key:JSON.stringify(e)})}else localStorage.setItem(Hs,JSON.stringify(e))}catch(t){console.error("SessionStore: failed to persist sessions",t)}}}const N=Object.freeze({IDLE:"idle",INITIALIZING:"initializing",EXECUTING:"executing",MONITORING:"monitoring",PAUSED:"paused",COMPLETED:"completed",FAILED:"failed",CANCELLED:"cancelled"});class zo{constructor(e,t){this._bus=e,this._nodeManager=t.nodeManager,this._connManager=t.connectionManager,this._bridge=new Oo(e),this._store=new Do,this._state=N.IDLE,this._session=null,this._metrics=this._freshMetrics(),this._messages=[],this._unlisteners=[],this._attachBusListeners()}get state(){return this._state}static get STATE(){return N}get session(){return this._session}get metrics(){return{...this._metrics}}get messages(){return[...this._messages]}async startSession(e={}){if(this._state!==N.IDLE&&this._state!==N.COMPLETED&&this._state!==N.FAILED&&this._state!==N.CANCELLED)throw new Error(`Cannot start session in state "${this._state}". Cancel or wait for completion.`);this._transition(N.INITIALIZING),this._messages=[],this._metrics=this._freshMetrics(),this._metrics.startedAt=Date.now();try{const t=this._nodeManager.serialize(),s=this._connManager.serialize(),n=pn(t,s,{projectName:e.projectName,ceoVision:e.ceoVision});this._metrics.nodeCount=n.stats.totalNodes,this._metrics.connectionCount=n.stats.totalConnections;const o=gn(n,{stack:e.stack,outputDir:e.outputDir||"."});this._metrics.promptLength=o.length,this._transition(N.EXECUTING);const r=await this._bridge.execute(o,{outputDir:e.outputDir||".",model:e.model,handsOff:e.handsOff});return this._session={sessionId:r.sessionId,pid:r.pid,projectName:n.projectName,startedAt:this._metrics.startedAt,handsOff:e.handsOff||!1},this._transition(N.MONITORING),await this._store.save({sessionId:r.sessionId,projectName:n.projectName,status:N.MONITORING,startedAt:this._metrics.startedAt,promptPreview:o.substring(0,200)}),this._emitMetrics(),{sessionId:r.sessionId}}catch(t){throw this._transition(N.FAILED),this._addMessage("system",`Failed to start session: ${t.message}`),t}}pauseSession(){if(this._state!==N.MONITORING)throw new Error(`Cannot pause in state "${this._state}".`);this._transition(N.PAUSED),this._addMessage("system","Session paused by CEO.")}resumeSession(){if(this._state!==N.PAUSED)throw new Error(`Cannot resume in state "${this._state}".`);this._transition(N.MONITORING),this._addMessage("system","Session resumed by CEO.")}async cancelSession(){if(this._state!==N.MONITORING&&this._state!==N.PAUSED&&this._state!==N.EXECUTING)throw new Error(`Cannot cancel in state "${this._state}".`);await this._bridge.cancel(),this._transition(N.CANCELLED),this._metrics.completedAt=Date.now(),this._addMessage("system","Session cancelled by CEO."),this._session&&await this._store.save({sessionId:this._session.sessionId,status:N.CANCELLED,completedAt:this._metrics.completedAt,messageCount:this._metrics.messageCount,errorCount:this._metrics.errorCount}),this._emitMetrics()}getSessionSummary(){const e=this._metrics.completedAt?this._metrics.completedAt-this._metrics.startedAt:this._state!==N.IDLE?Date.now()-this._metrics.startedAt:0;return{state:this._state,session:this._session,metrics:{...this._metrics,elapsedMs:e,elapsedFormatted:this._formatElapsed(e)}}}async getHistory(){return this._store.list()}destroy(){this._unlisteners.forEach(e=>e()),this._unlisteners=[],this._bridge.destroy()}_attachBusListeners(){const e=(t,s)=>{this._unlisteners.push(this._bus.on(t,s))};e("orchestration:progress",t=>{(this._state===N.MONITORING||this._state===N.PAUSED)&&(this._metrics.messageCount++,this._addMessage("agent",t),this._emitMetrics())}),e("orchestration:error",t=>{this._metrics.errorCount++,this._addMessage("error",t.message||"Unknown error"),this._emitMetrics()}),e("orchestration:complete",async t=>{const s=t.success?N.COMPLETED:N.FAILED;this._transition(s),this._metrics.completedAt=Date.now(),this._metrics.exitCode=t.exitCode,this._addMessage("system",t.success?"Session completed successfully.":`Session failed (exit code: ${t.exitCode}).`),this._session&&await this._store.save({sessionId:this._session.sessionId,status:s,completedAt:this._metrics.completedAt,exitCode:t.exitCode,messageCount:this._metrics.messageCount,errorCount:this._metrics.errorCount}),this._emitMetrics()}),e("orchestration:approval-needed",t=>{this._addMessage("approval",t),this._emitMetrics()}),e("ceo:approval",t=>{this._addMessage("system",`CEO approved: ${t.decision}`)}),e("orchestration:cancel",()=>{})}_transition(e){var s;const t=this._state;this._state=e,this._bus.emit("orchestration:state-change",{previous:t,current:e,sessionId:(s=this._session)==null?void 0:s.sessionId})}_addMessage(e,t){this._messages.push({type:e,content:t,timestamp:Date.now()})}_emitMetrics(){this._bus.emit("orchestration:metrics-update",this.getSessionSummary())}_freshMetrics(){return{startedAt:0,completedAt:0,messageCount:0,errorCount:0,nodeCount:0,connectionCount:0,promptLength:0,exitCode:null}}_formatElapsed(e){if(e<1e3)return`${e}ms`;const t=Math.floor(e/1e3);if(t<60)return`${t}s`;const s=Math.floor(t/60),n=t%60;if(s<60)return`${s}m ${n}s`;const o=Math.floor(s/60),r=s%60;return`${o}h ${r}m`}}class Fo{constructor(){var e,t,s,n,o;this.bus=new Cn,this.history=new Mn(this.bus),this.viewport=new Pn(this.bus),this.storage=new di(this.bus),this.nodeManager=new ni(this.bus,this.viewport),this.connectionManager=new ri(this.bus,this.nodeManager),this.nodeManager.setConnectionManager(this.connectionManager),this.contextMenu=new ai(this.bus,this.nodeManager,this.connectionManager,this.viewport),this.propertyPanel=new ci(this.bus,this.nodeManager),this.miniMap=new li(this.bus,this.nodeManager,this.viewport),this.presetManager=new bi,this.presetModal=new _i(this.presetManager,r=>this._loadPreset(r),()=>({nodes:this.nodeManager.serialize(),connections:this.connectionManager.serialize()})),this.fileManager=new Ii({getState:()=>this._getState(),loadState:r=>this._loadPreset(r),clearState:()=>{this.history.pause(),this.nodeManager.deserialize([]),this.connectionManager.deserialize([]),this.history.resume(),this.bus.emit("state:loaded"),this.bus.emit("state:changed")},fitToContent:()=>this._fitToContent(),getNodeManager:()=>this.nodeManager,getConnectionManager:()=>this.connectionManager}),this.fileMenu=new Ci(this.fileManager),this.agentPanel=new go(this.bus),this.orchestrationEngine=new zo(this.bus,{nodeManager:this.nodeManager,connectionManager:this.connectionManager}),this.promptExportModal=new Co(this.bus,()=>this.nodeManager.serialize(),()=>this.connectionManager.serialize()),this.ideaInputModal=new No(this.bus,this.nodeManager,this.connectionManager),(e=document.getElementById("btn-presets"))==null||e.addEventListener("click",()=>this.presetModal.show()),(t=document.getElementById("btn-generate-prompt"))==null||t.addEventListener("click",()=>this.promptExportModal.show()),(s=document.getElementById("btn-ai-generate"))==null||s.addEventListener("click",()=>this.ideaInputModal.show()),(n=document.getElementById("btn-run-agents"))==null||n.addEventListener("click",()=>this._runAgents()),(o=document.getElementById("btn-clean-layout"))==null||o.addEventListener("click",()=>this._cleanLayout()),this.bus.on("orchestration:pause-request",()=>{try{this.orchestrationEngine.pauseSession()}catch(r){console.warn("Pause failed:",r.message)}}),this.bus.on("orchestration:resume-request",()=>{try{this.orchestrationEngine.resumeSession()}catch(r){console.warn("Resume failed:",r.message)}}),this.bus.on("orchestration:cancel-request",async()=>{try{await this.orchestrationEngine.cancelSession()}catch(r){console.warn("Cancel failed:",r.message)}}),this._bindKeyboard(),this._bindSaveLoad(),this.bus.on("viewport:fit-request",()=>this._fitToContent()),this._bindReadinessValidation(),this._loadState(),this.history.push(this._getState()),console.log("%câš¡ MindMapper initialized","color: #00e5ff; font-weight: bold; font-size: 14px;")}_bindKeyboard(){window.addEventListener("keydown",e=>{var t,s,n;if(!((t=document.activeElement)!=null&&t.isContentEditable||((s=document.activeElement)==null?void 0:s.tagName)==="TEXTAREA"||((n=document.activeElement)==null?void 0:n.tagName)==="INPUT")){if(e.ctrlKey&&e.key==="z"){e.preventDefault();const o=this.history.undo();o&&this._restoreState(o)}if(e.ctrlKey&&e.key==="y"){e.preventDefault();const o=this.history.redo();o&&this._restoreState(o)}e.ctrlKey&&!e.shiftKey&&e.key==="s"&&(e.preventDefault(),this.storage.save(this._getState())),(e.key==="Delete"||e.key==="Backspace")&&(e.preventDefault(),this.connectionManager.selectedConnection?this.connectionManager.deleteSelectedConnection():this.nodeManager.deleteSelected()),e.ctrlKey&&e.shiftKey&&e.key==="G"&&(e.preventDefault(),this.promptExportModal.show()),e.ctrlKey&&e.shiftKey&&e.key==="I"&&(e.preventDefault(),this.ideaInputModal.show()),e.key==="Escape"&&(this.nodeManager.deselectAll(),this.connectionManager.deselectConnection(),this.bus.emit("selection:changed",[]))}})}_bindSaveLoad(){let e=null;this.bus.on("state:changed",()=>{clearTimeout(e),e=setTimeout(()=>{this.history.push(this._getState())},300)}),this.bus.on("state:save-request",()=>{this.storage.save(this._getState())})}_bindReadinessValidation(){let e=null;const t=()=>{clearTimeout(e),e=setTimeout(()=>{const s=Bs(this.nodeManager.serialize(),this.connectionManager.serialize());this.bus.emit("agent:readiness",s)},500)};this.bus.on("state:changed",t),this.bus.on("state:loaded",t)}_getState(){return{nodes:this.nodeManager.serialize(),connections:this.connectionManager.serialize(),viewport:this.viewport.getState()}}_restoreState(e){this.history.pause(),this.nodeManager.deserialize(e.nodes),this.connectionManager.deserialize(e.connections),this.viewport.setState(e.viewport),this.history.resume(),this.bus.emit("state:loaded")}_loadState(){const e=this.storage.load();if(e&&(this.history.pause(),this.nodeManager.deserialize(e.nodes),this.connectionManager.deserialize(e.connections),this.viewport.setState(e.viewport),this.history.resume(),this.bus.emit("state:loaded"),e.nodes&&e.nodes.length>0)){const t=document.getElementById("help-hint");t&&t.classList.add("hidden")}}_fitToContent(){const e=this.nodeManager.getBounds();if(!e)return;const s=document.getElementById("canvas-container").getBoundingClientRect(),n=100,o=s.width/(e.width+n*2),r=s.height/(e.height+n*2),a=Math.min(o,r,1.5),c=e.minX+e.width/2,l=e.minY+e.height/2;this.viewport.zoom=a,this.viewport.x=s.width/2-c*a,this.viewport.y=s.height/2-l*a,this.viewport._applyTransform(),this.bus.emit("viewport:changed",this.viewport.getState())}_loadPreset(e){this.history.pause(),this.nodeManager.deserialize([]),this.connectionManager.deserialize([]),this.nodeManager.deserialize(e.nodes||[]),this.connectionManager.deserialize(e.connections||[]),this.history.resume(),this.bus.emit("state:loaded"),requestAnimationFrame(()=>{this._fitToContent(),this.history.push(this._getState()),this.bus.emit("state:changed")});const t=document.getElementById("help-hint");t&&t.classList.add("hidden")}async _runAgents(){if(!Z.isTauri){alert(`Run Agents requires the MindMapper desktop app.

Use "Generate Prompt" to copy the workflow prompt and paste it into Claude Code manually.`);return}const e=Bs(this.nodeManager.serialize(),this.connectionManager.serialize());if(!e.valid){const n=e.errors.map(o=>`â€¢ ${o}`).join(`
`);alert(`Mind map is not ready:

${n}

Fix these issues before running agents.`);return}const t=prompt(`Enter the output directory for Claude Code:
(This is where generated files will go)`,".");if(!t)return;const s=this.agentPanel.handsOff;try{await this.orchestrationEngine.startSession({outputDir:t,handsOff:s})}catch(n){console.error("Failed to start orchestration session:",n)}}_cleanLayout(){const e=this.nodeManager.serialize(),t=this.connectionManager.serialize();if(e.length===0){alert("No nodes on the canvas to arrange.");return}const s=new Map,n=e.map((h,g)=>(s.set(h.id,g),{text:h.text,type:h.nodeType||"general",priority:h.priority||"medium"})),o=[];t.forEach(h=>{const g=s.get(h.sourceId),u=s.get(h.targetId);g!==void 0&&u!==void 0&&o.push({from:g,to:u,directed:h.directed==="forward"})});const r=document.getElementById("canvas-container"),a=(r==null?void 0:r.getBoundingClientRect())||{width:1200,height:800},c=this.viewport.screenToWorld(a.width/2,a.height/2),l=bn(n,o,c.x,c.y);t.forEach(h=>{const g=this.connectionManager.connections.get(h.id);if(!g)return;const u=s.get(h.sourceId),f=s.get(h.targetId);if(u===void 0||f===void 0)return;const m=l[f].x-l[u].x,b=l[f].y-l[u].y;Math.abs(m)>Math.abs(b)?(g.sourcePort=m>0?"right":"left",g.targetPort=m>0?"left":"right"):(g.sourcePort=b>0?"bottom":"top",g.targetPort=b>0?"top":"bottom")}),e.forEach((h,g)=>{const u=this.nodeManager.getNode(h.id);if(!u)return;const f=Math.round(l[g].x-70),m=Math.round(l[g].y-20);u.el.style.transition="left 0.5s cubic-bezier(0.4, 0, 0.2, 1), top 0.5s cubic-bezier(0.4, 0, 0.2, 1)",u.x=f,u.y=m,u.el.style.left=`${f}px`,u.el.style.top=`${m}px`,setTimeout(()=>{u.el.style.transition=""},550)});const p=()=>this.connectionManager._renderAll();[0,50,100,200,300,400,500,550].forEach(h=>setTimeout(p,h)),setTimeout(()=>{p(),this.bus.emit("state:changed"),this.bus.emit("viewport:fit-request")},560)}}window.addEventListener("DOMContentLoaded",()=>{window.mindMapper=new Fo});
