rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ─── Projects ─────────────────────────────────────────────────────
    // Only the owner can read/write their projects
    match /projects/{projectId} {
      allow read, write: if request.auth != null
                         && request.auth.uid == resource.data.ownerId;
      allow create: if request.auth != null
                    && request.resource.data.ownerId == request.auth.uid;

      // ─── Messages ────────────────────────────────────────────────
      // Only the project owner can read messages
      // Only Cloud Functions can write messages (agents)
      match /messages/{messageId} {
        allow read: if request.auth != null
                    && get(/databases/$(database)/documents/projects/$(projectId)).data.ownerId == request.auth.uid;
        // Client cannot write messages — only Cloud Functions (admin SDK) can
        allow write: if false;
      }

      // ─── Artifacts ───────────────────────────────────────────────
      // Same as messages: read-only for project owner
      match /artifacts/{artifactId} {
        allow read: if request.auth != null
                    && get(/databases/$(database)/documents/projects/$(projectId)).data.ownerId == request.auth.uid;
        allow write: if false;
      }

      // ─── Cost Ledger ─────────────────────────────────────────────
      match /costLedger/{docId} {
        allow read: if request.auth != null
                    && get(/databases/$(database)/documents/projects/$(projectId)).data.ownerId == request.auth.uid;
        allow write: if false;
      }
    }

    // ─── Users ────────────────────────────────────────────────────────
    // Users can only read/write their own profile
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
